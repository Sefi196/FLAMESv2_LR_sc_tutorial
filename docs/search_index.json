[["index.html", "Long-read Single-Cell RNA-seq analysis tutorial Chapter 1 Introduction 1.1 Prerequisites 1.2 Getting Started with the Data 1.3 Dataset Information 1.4 Citation 1.5 Contact", " Long-read Single-Cell RNA-seq analysis tutorial Sefi PrawerPostdoctoral Research Fellow in Long Reads and Single-Cell TranscriptomicsUniversity of Melbourne 2025-11-28 Chapter 1 Introduction Welcome to the FLAMESv2 analysis tutorial! In this tutorial, we demonstrate how to process and analyze long-read single-cell RNA sequencing data using outputs from the FLAMES package (Tian et al., 2021; Wang et al., 2025). FLAMES enables the identification and quantification of isoform-level expression in single cells, providing a unique opportunity to uncover transcriptomic complexity that is often undetectable in short-read data. We will demonstrate how to load and explore FLAMES outputs in Seurat and other popular single-cell analysis tools. By following this workflow, you’ll learn how to: Preprocess long-read single-cell data Visualize isoform expression patterns and isoform structure Identify differentially expressed isoforms across cell types Detect novel isoforms with potential functional impact If you’re familiar with short-read data processing, much of the pre-processing workflow will feel intuitive. However, long-read single-cell sequencing provides isoform-level information which enables you to explore isoform dynamics in single cells. This can be useful for exploring complex developmental systems or disease pathogenesis. 1.1 Prerequisites This tutorial assumes you have already processed your long-read single-cell data using FLAMES, either through the SingleCellPipeline or MultiSampleSCPipeline. Please ensure that the following parameters in your configuration file are set to TRUE to enable isoform identification and quantification with Bambu (Chen et al., 2023) and Oarfish (Jousheghani &amp; Patro, 2024): \"bambu_isoform_identification\": [true] \"oarfish_quantification\": [true] While FLAMES is optimized for use with specific quantification and isoform discovery tools, much of this workflow can be adapted for use with other tools which FLAMES supports. We recommend using Bambu and Oarfish as they have been validated for the type of analysis demonstrated here. Additionally, we provide an optional step for users interested in removing empty droplets and ambient RNA contamination. If you plan to use this feature, ensure that you have previously calculated the ambient RNA profile. Detailed instructions for this step can be found here ?? 1.2 Getting Started with the Data To follow along with this tutorial, you can download the data from GitHub. Download it using the following command: Code curl -L -o data.zip https://github.com/Sefi196/FLAMESv2_LR_sc_tutorial/releases/latest/download/data.zip \\ &amp;&amp; unzip data.zip Simply unzip all files to begin. If you prefer to run the tutorial using your own output from FLAMES, there is no need to unzip your files. However, be sure to use the correct GTF file. The GTF file used during FLAMES processing must be the same one used for downstream analyses. The current version utilized in this tutorial can be downloaded using the following command: Code wget https://ftp.ebi.ac.uk/pub/databases/gencode/Gencode_human/release_47/gencode.v47.annotation.gtf.gz 1.3 Dataset Information This tutorial uses data generated by the Clark Lab at the University of Melbourne. It consists of two datasets designed to demonstrate different aspects of analysis in the FLAMESv2 workflow. The single-sample dataset is a small, self-contained collection of approximately 400 cells, obtained at Day 55 of an excitatory neural differentiation protocol. It provides a lightweight example that users can run quickly to gain an understanding of the major analysis steps, including removing sources of variation, building a Seurat object with gene and isoform counts, and exploring interesting isoform structures and their expression profiles. The dataset is also compact enough for users to run entirely through FLAMESv2, allowing them to experience the complete analysis workflow from raw FASTQ data to informative isoform-level outcomes. The raw data are available for download at ENA: PRJEB100552. The multi-sample dataset extends the workflow to a comparative setting and demonstrates how FLAMESv2 can be used to explore isoform-level changes across samples and developmental stages in a neuronal differentiation context. It forms part of the neuronal differentiation dataset described in the manuscript Wang et al. (2025), and for the purposes of the tutorial, it has been simplified to include only a subset of cells. This version allows users to perform sample integration, comparative isoform analysis, and trajectory-based exploration of isoform expression across neural developmental time points, all within a manageable runtime. More details on the dataset, sequencing methodology, and the differentiation protocol can be found in the following publications: (Wang et al., 2025; You et al., 2023) 1.4 Citation If you find this tutorial useful, please cite Wang et al. (2025) and Tian et al. (2021). 1.5 Contact For questions or suggestions, please feel free to email us at sefi.prawer@unimelb.edu.au or leave a comment on our GitHub page: https://github.com/Sefi196/FLAMESv2_LR_sc_tutorial. "],["setup.html", "Chapter 2 Setup 2.1 Load in required packages 2.2 Creating resource files. 2.3 Convert count matrices from Gene ID to gene Symbol", " Chapter 2 Setup 2.1 Load in required packages Code # Install packages if required. Note some packages require installation via Bioconductor. See installation instructions for each package to ensure installation is successful. library(rtracklayer) library(Seurat) library(DropletUtils) library(gridExtra) library(data.table) library(BiocParallel) library(celda) library(SingleCellExperiment) library(DoubletFinder) library(stringr) library(cowplot) library(grid) library(patchwork) library(tidyverse) library(ORFik) library(GenomicFeatures) library(Gviz) library(BSgenome.Hsapiens.UCSC.hg38) # Set working directory and create folders for output files setwd(&quot;.&quot;) # Set this to correct location dir.create(&quot;./output_files/ref_files&quot;, recursive = TRUE, showWarnings = FALSE) dir.create(&quot;./output_files/counts&quot;, recursive = TRUE, showWarnings = FALSE) dir.create(&quot;./output_files/seu_objects&quot;, recursive = TRUE, showWarnings = FALSE) dir.create(&quot;./output_files/empty_drops&quot;, recursive = TRUE, showWarnings = FALSE) dir.create(&quot;./output_files/decontx&quot;, recursive = TRUE, showWarnings = FALSE) dir.create(&quot;./output_files/QC&quot;, recursive = TRUE, showWarnings = FALSE) dir.create(&quot;./output_files/DE&quot;, recursive = TRUE, showWarnings = FALSE) dir.create(&quot;./output_files/multi_sample&quot;, recursive = TRUE, showWarnings = FALSE) 2.2 Creating resource files. To start, we’ll create a few essential files that will be used throughout the analysis. The first step is to generate a CSV file containing three key columns: ENSTID, ENSGID, and geneSymbol. This file will be used as a dictionary to rename entries in both the isoform and gene count matrices, replacing ENSGID with the corresponding gene symbol. By adopting this naming convention for ENSTID, we can easily identify the gene origin of each isoform, streamlining the interpretation and analysis of gene and isoform-level data. First let’s define a helper function for this step: Code # Function to make csv naming resource make_isoform_gene_symbol_dict &lt;- function(FLAMES_gtf, reference_gtf, output_file) { # Import the first GTF file (transcripts GTF) gtf1 &lt;- import(FLAMES_gtf) gtf1_df &lt;- as.data.frame(gtf1) # Select relevant columns from the first GTF selected_columns1 &lt;- gtf1_df[, c(&quot;transcript_id&quot;, &quot;gene_id&quot;)] unique_selected_cols &lt;- unique(selected_columns1) # Import the second GTF file (reference GTF with gene symbols) gtf2 &lt;- import(reference_gtf) gtf2_df &lt;- as.data.frame(gtf2) # Select relevant columns from the second GTF selected_columns2 &lt;- gtf2_df[, c(&quot;gene_name&quot;, &quot;gene_id&quot;)] unique_gene_symbol &lt;- unique(selected_columns2) # Merge the two data frames on &#39;gene_id&#39; combined_data &lt;- merge(unique_selected_cols, unique_gene_symbol, by = &quot;gene_id&quot;, all.x = TRUE) # If &#39;gene_name&#39; is missing, replace it with &#39;gene_id&#39; combined_data$gene_symbol &lt;- ifelse(is.na(combined_data$gene_name), combined_data$gene_id, combined_data$gene_name) # Select relevant columns final_combined_data &lt;- combined_data[, c(&quot;transcript_id&quot;, &quot;gene_id&quot;, &quot;gene_symbol&quot;)] # Write to a CSV file write.csv(final_combined_data, file = file.path(&quot;output_files/ref_files&quot;, output_file), row.names = FALSE) return(final_combined_data) } Run this chunk to create the dictionary containing ENSTID, ENSGID, and geneSymbol information: Code # The FLAMES ref can be found in your selected output folder after running the Flames pipeline. FLAMES_gtf_file &lt;- &quot;./data/FLAMES_out/isoform_annotated.gtf&quot; #ensure file is unzipped reference_gtf_file &lt;- &quot;data/gencode.v47.annotation.gtf&quot; # ensure file is unzipped output_file &lt;- &quot;isoform_gene_dict.csv&quot; # Call the helper function defined in code block above to create a dictionary containing corresponding gene information for each isoform # This may take a few minutes isoform_gene_dict &lt;- make_isoform_gene_symbol_dict(FLAMES_gtf_file, reference_gtf_file, output_file) 2.3 Convert count matrices from Gene ID to gene Symbol With the reference dictionary in place, we can now rename both our count matrix and background count matrix by converting ENSGIDs to geneSymbols. This conversion not only simplifies the interpretation of gene expression in single cells but is also necessary for some downstream tools that require gene symbols instead of ENSGIDs, such as automated cell annotation tools. Like before, let’s define a generic helper function first to do this: Code convert_ENSGID_to_geneSymbol &lt;- function(gene_count_matrix_path, id_symbol_df = isoform_gene_dict, output_file, return_df = FALSE) { # Load the reference dictionary we made earlier - select gene-level cols id_symbol_df &lt;- as_tibble(id_symbol_df) %&gt;% dplyr::select(gene_id, gene_symbol) # Load the data object with ENSGID row names gene_count_matrix &lt;- fread(gene_count_matrix_path, header = TRUE) colnames(gene_count_matrix)[1] &lt;- &quot;gene_id&quot; # Replace ENSGIDs with gene symbols in original flames gene-level count matrix formatted_gene_count_matrix &lt;- gene_count_matrix %&gt;% merge(id_symbol_df, by.x = &#39;gene_id&#39;, by.y = &#39;gene_id&#39;) %&gt;% # Add gene symbol information distinct(gene_symbol, .keep_all = TRUE) %&gt;% # Remove duplicates based on gene symbol dplyr::select(-gene_id) %&gt;% # Remove the ENSGID column column_to_rownames(var = &quot;gene_symbol&quot;) # use the gene symbols we added as rownames # Write out the processed data frame fwrite(formatted_gene_count_matrix, output_file, row.names = TRUE) # Return the processed count matrix for further use if needed if(return_df){ return(formatted_gene_count_matrix) } } Run the chunk below to format gene-level count matrices for background and FLAMES data using the helper function from above: Code # convert Gene_id to gene symbol for gene counts convert_ENSGID_to_geneSymbol( gene_count_matrix_path = &quot;./data/FLAMES_out/gene_count.csv&quot;, output_file = &quot;./output_files/counts/geneSymbol_gene_count.csv&quot; ) # convert Gene_id to gene symbol for background counts convert_ENSGID_to_geneSymbol( gene_count_matrix_path = &quot;./data/background/gene_count.csv&quot;, output_file = &quot;./output_files/counts/background_geneSymbol_gene_count.csv&quot; ) Now we have the files we need to begin cleaning our data and removing unwanted noise. "],["removing-sources-of-unwanted-noise-from-the-single-cell-dataset.html", "Chapter 3 Removing sources of unwanted noise from the single cell dataset 3.1 Empty droplets 3.2 Removing ambient RNA contamination 3.3 Standard gene QC to remove low quality cells", " Chapter 3 Removing sources of unwanted noise from the single cell dataset Now we will do some initial preprocessing of single cell data to ensure we have some high quality data. This will involve 3 main steps Removing empty droplets - droplets that do not contain true cells. Removing ambient RNA contamination - optional Removing low quality cells 3.1 Empty droplets This function removes empty droplets, a critical step to ensure that only true cells are retained for analysis. In short-read analysis using CellRanger, this process is automated, and empty droplets are removed by the software. However, FLAMES does not perform this step automatically, so it must be done manually. The function provided here not only removes empty droplets but also generates general QC metrics, enabling users to assess the reasonableness of the number of cells removed. Code ### notes: This function should be refactored and cleaned up. It&#39;s very long and complex. perform_empty_drops_analysis &lt;- function(output_path, gene_count_file, empty_drops_file, output_seurat_file, fdr_threshold = 0.001, lower = 100) { # Load required libraries # Read in data df &lt;- read.csv(gene_count_file, row.names = 1) df_emptydrops &lt;- read.csv(empty_drops_file, row.names = 1) # Combine the dataframes by row names combined_df &lt;- merge(df, df_emptydrops, by = &quot;row.names&quot;, all = TRUE) rownames(combined_df) &lt;- combined_df[, 1] combined_df[, 1] &lt;- NULL combined_df[is.na(combined_df)] &lt;- 0 # Perform standard pre-processing before empty drops analysis seurat_obj &lt;- CreateSeuratObject(counts = df, project = &quot;Day_55&quot;, min.features = 20) seurat_obj[[&quot;percent.mt&quot;]] &lt;- PercentageFeatureSet(seurat_obj, pattern = &quot;^MT-&quot;) VlnPlot(seurat_obj, features = c(&quot;nFeature_RNA&quot;, &quot;nCount_RNA&quot;, &quot;percent.mt&quot;), ncol = 3) #seurat_obj &lt;- subset(seurat_obj, subset = nFeature_RNA &gt; 10 &amp; nFeature_RNA &lt; 100000 &amp; percent.mt &lt; 100) seurat_obj &lt;- NormalizeData(seurat_obj, normalization.method = &quot;LogNormalize&quot;, scale.factor = 10000) seurat_obj &lt;- FindVariableFeatures(seurat_obj, selection.method = &quot;vst&quot;, nfeatures = 2000) all.genes &lt;- rownames(seurat_obj) seurat_obj &lt;- ScaleData(seurat_obj, features = all.genes) seurat_obj &lt;- RunPCA(seurat_obj, features = VariableFeatures(object = seurat_obj)) ElbowPlot(seurat_obj) seurat_obj &lt;- FindNeighbors(seurat_obj, dims = 1:10) seurat_obj &lt;- FindClusters(seurat_obj, resolution = 0.5) seurat_obj &lt;- RunUMAP(seurat_obj, dims = 1:10) DimPlot(seurat_obj, reduction = &quot;umap&quot;) # Define function to make dgCMatrix from combined counts makedgcmatrix &lt;- function(count.matrix) { seurat_object &lt;- CreateSeuratObject(counts = count.matrix, project = &quot;singlecell&quot;) list(seurat_object[[&quot;RNA&quot;]]$counts) } # Empty Drops Analysis combined_df[] &lt;- lapply(combined_df, function(x) as.numeric(as.character(x))) outs.ddcmatrix &lt;- makedgcmatrix(combined_df)[[1]] br.out &lt;- DropletUtils::barcodeRanks(outs.ddcmatrix) e.out &lt;- emptyDrops(outs.ddcmatrix, lower = lower, niters = 10000, test.ambient = TRUE, BPPARAM = SerialParam()) is.cell &lt;- e.out$FDR &lt; fdr_threshold # Create a dataframe with FDR of TRUE cells is.true.cell_CR &lt;- as.data.frame(e.out@listData[[&quot;FDR&quot;]], e.out@rownames) is.true.cell_CR &lt;- is.true.cell_CR %&gt;% filter(is.true.cell_CR$`e.out@listData[[&quot;FDR&quot;]]` &lt;= fdr_threshold) is.true.cell_CR &lt;- tibble::rownames_to_column(is.true.cell_CR, &quot;cell_id&quot;) # Function for retrieving the Seurat cells and cluster in dataframe overlap_true_cell &lt;- function(seurat_object) { seurat_cluster.df &lt;- as.data.frame(seurat_object$seurat_clusters) seurat_cluster.df &lt;- tibble::rownames_to_column(seurat_cluster.df, &quot;cell_id&quot;) seurat_cluster.df } # Obtain cluster dataframe from Seurat object overlap_CR &lt;- overlap_true_cell(seurat_obj) # Check overlaps between Seurat object and true cells summary(overlap_CR$cell_id %in% is.true.cell_CR$cell_id) # Function to add metadata to Seurat object True.cells &lt;- function(e.out) { cells &lt;- as.data.frame(e.out@rownames) fdr &lt;- as.data.frame(e.out$FDR) T.F.cells &lt;- cbind(cells, fdr) T.F.cells &lt;- data.frame(T.F.cells[,-1], row.names = T.F.cells[,1]) setnames(T.F.cells, c(&#39;FDR&#39;)) T.F.cells %&gt;% mutate(FDR = case_when(FDR &lt; fdr_threshold ~ &quot;Cells&quot;, FDR &gt; fdr_threshold ~ &quot;Empty_drops&quot;)) } cells_CR &lt;- True.cells(e.out) seurat_obj &lt;- AddMetaData(seurat_obj, metadata = cells_CR, col.name = &#39;is.cell&#39;) # Plot Empty drops on Gene UMAP # Create a ggplot object rankplot &lt;- ggplot(br.out, aes(x = rank, y = total)) + geom_point() + scale_x_log10() + scale_y_log10() + labs(x = &quot;Rank&quot;, y = &quot;Total&quot;) + geom_line(aes(y = fitted), color = &quot;red&quot;, linetype = &quot;solid&quot;) + geom_hline(yintercept = metadata(br.out)$knee, color = &quot;dodgerblue&quot;, linetype = &quot;dashed&quot;) + geom_hline(yintercept = metadata(br.out)$inflection, color = &quot;forestgreen&quot;, linetype = &quot;dashed&quot;) + theme( legend.position = &quot;bottomleft&quot; ) + guides(colour = guide_legend(override.aes = list(linetype = c(&quot;dashed&quot;, &quot;dashed&quot;)))) + annotate(&quot;text&quot;, x = Inf, y = metadata(br.out)$knee, label = &quot;knee&quot;, color = &quot;dodgerblue&quot;, vjust = -1, hjust = 1) + annotate(&quot;text&quot;, x = Inf, y = metadata(br.out)$inflection, label = &quot;inflection&quot;, color = &quot;forestgreen&quot;, vjust = -1, hjust = 1) # Summary table -&gt; may want to add a bunch of other summary metrics # Extract counts with checks for NULL cell_counts &lt;- as.data.frame(table(seurat_obj@meta.data$is.cell)) count_true_cells &lt;- ifelse(length(cell_counts$Freq[cell_counts$Var1 == &quot;Cells&quot;]) &gt; 0, cell_counts$Freq[cell_counts$Var1 == &quot;Cells&quot;], 0) count_empty_drops &lt;- ifelse(length(cell_counts$Freq[cell_counts$Var1 == &quot;Empty_drops&quot;]) &gt; 0, cell_counts$Freq[cell_counts$Var1 == &quot;Empty_drops&quot;], 0) # Create the summary table summary_table &lt;- data.frame( Description = c(&#39;fdr&#39;, &#39;lower Counts&#39;, &#39;number of true cells&#39;, &#39;number of empty drops&#39;), Value = c(fdr_threshold, lower, count_true_cells, count_empty_drops) ) summary_grob &lt;- tableGrob(summary_table, rows = NULL, cols = NULL) # Create the combined plot plot1 &lt;- grid.arrange( rankplot, DimPlot(seurat_obj, reduction = &quot;umap&quot;, group.by = &#39;is.cell&#39;) + labs(color = &quot;is.cell&quot;, title = &#39;Seurat Object&#39;) + theme(text = element_text(size = 10), plot.background = element_rect(fill = &quot;white&quot;)), FeaturePlot(seurat_obj, features = &quot;nCount_RNA&quot;) + theme(plot.background = element_rect(fill = &quot;white&quot;)), FeaturePlot(seurat_obj, features = &quot;nFeature_RNA&quot;) + theme(plot.background = element_rect(fill = &quot;white&quot;)), summary_grob, ncol = 2, top = textGrob(&#39;Empty drops vs real cells&#39;) ) #output the plot and summary stats pdf(file = file.path(output_path, paste0(output_seurat_file, &quot;_plots.pdf&quot;)), width = 6, height = 6, bg = &quot;white&quot;) plot(plot1) dev.off() # Subset the Seurat object to remove cells marked as empty drops seurat_obj_rm_empty &lt;- subset(seurat_obj, subset = is.cell == &#39;Cells&#39;) #save the seurat objects saveRDS(seurat_obj, file = file.path(output_path, paste0(&quot;with_empty_&quot;, output_seurat_file, &quot;.rds&quot;))) saveRDS(seurat_obj_rm_empty, file = file.path(output_path, paste0(&quot;removed_empty_&quot;, output_seurat_file, &quot;.rds&quot;))) } ##################### # usage perform_empty_drops_analysis( gene_count_file = &quot;./output_files/counts/geneSymbol_gene_count.csv&quot;, empty_drops_file = &quot;./output_files/counts/background_geneSymbol_gene_count.csv&quot;, output_path = &quot;./output_files/empty_drops/&quot;, output_seurat_file = &quot;Day55&quot;, fdr_threshold = 0.001, # see droplet utils if you want to adjust these params lower = 500 # see droplet utils if you want to adjust these params ) ## Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck ## ## Number of nodes: 344 ## Number of edges: 7209 ## ## Running Louvain algorithm... ## Maximum modularity in 10 random starts: 0.8510 ## Number of communities: 7 ## Elapsed time: 0 seconds 3.2 Removing ambient RNA contamination Now we will remove ambient RNA contamination using decontX (or SoupX). This step is optional, and it’s up to the user to decide whether it’s necessary. In this case, the barcode rank plot (Figure 3.1) shows a clear distinction between true barcodes and background barcodes, suggesting that ambient RNA contamination may not significantly contribute to noise in this dataset. However, we’ll demonstrate how to run this step in case your barcode rank plot is noisier and contamination is a concern. if users wish to skip this step take the ‘seurat_obj_rm_empty’ object and proceed to standard gene QC step. Code knitr::include_graphics(&quot;images/knee_plot.png&quot;) Figure 3.1: Barcode rank plot produced by FLAMES. Code # Function to run decontX on a single Seurat object run_decontX &lt;- function(seurat_obj_path, background_counts_path, sample_id) { # Load the Seurat object seurat_obj &lt;- readRDS(seurat_obj_path) filtered_counts &lt;- as.matrix(GetAssayData(seurat_obj, layer = &quot;counts&quot;)) # Read background counts raw_counts &lt;- as.matrix(read.csv(background_counts_path, row.names = 1)) # Get cluster info from Seurat object cluster_info &lt;- setNames(seurat_obj$seurat_clusters, colnames(seurat_obj)) # Find common genes common_genes &lt;- intersect(rownames(filtered_counts), rownames(raw_counts)) raw_counts &lt;- raw_counts[common_genes, ] filtered_counts &lt;- filtered_counts[common_genes, ] # Create SingleCellExperiment objects sce_raw &lt;- SingleCellExperiment(list(counts = raw_counts)) sce_object &lt;- SingleCellExperiment(list(counts = filtered_counts)) # Run decontX with background sce &lt;- decontX(sce_object, z = cluster_info, background = sce_raw) # Summarize contamination levels contamination_summary &lt;- as.array(summary(sce$decontX_contamination)) print(contamination_summary) # Add contamination levels to Seurat object metadata contamination &lt;- colData(sce)$decontX_contamination seurat_obj &lt;- AddMetaData(seurat_obj, metadata = contamination, col.name = &quot;decontX_contamination&quot;) # Extract decontaminated counts from SCE object decontaminated_counts &lt;- assay(sce, &quot;decontXcounts&quot;) decontaminated_counts &lt;- as.matrix(decontaminated_counts) # Create a new assay with decontaminated counts and add it to Seurat object new_assay &lt;- CreateAssayObject(counts = decontaminated_counts) seurat_obj[[&quot;decontaminated&quot;]] &lt;- new_assay clusters_umap_orig &lt;- DimPlot( object = seurat_obj, group.by = &quot;seurat_clusters&quot;, reduction = &quot;umap&quot;, label = TRUE, pt.size = 0.5 ) + labs(title = &quot;UMAP with Clusters&quot;) # Plot UMAP with contamination levels contamination_umap &lt;- FeaturePlot( object = seurat_obj, features = &quot;decontX_contamination&quot;, reduction = &quot;umap&quot; ) + labs(title = &quot;decontX contamination value&quot;) DefaultAssay(seurat_obj) &lt;- &quot;decontaminated&quot; # Normalization, variable feature selection, and scaling seurat_obj &lt;- NormalizeData(seurat_obj) seurat_obj &lt;- FindVariableFeatures(seurat_obj) seurat_obj &lt;- ScaleData(seurat_obj) # PCA and clustering seurat_obj &lt;- RunPCA(seurat_obj) seurat_obj &lt;- FindNeighbors(seurat_obj, dims = 1:20) seurat_obj &lt;- FindClusters(seurat_obj, resolution = 0.7) # UMAP seurat_obj &lt;- RunUMAP(seurat_obj, dims = 1:20) # Plot UMAP with updated clusters clusters_umap &lt;- DimPlot( object = seurat_obj, group.by = &quot;seurat_clusters&quot;, reduction = &quot;umap&quot;, label = TRUE, pt.size = 0.5 ) + labs(title = &quot;UMAP with Corrected Clusters&quot;) # Combine plots combined_umap &lt;- cowplot::plot_grid(clusters_umap_orig, contamination_umap, clusters_umap, ncol = 2) cat(&quot;Making plots\\n&quot;) # Save the combined plot as a PDF #pdf(file = paste0(sample_id, &quot;_decontx_plots.pdf&quot;), width = 18, height = 6) print(combined_umap) #dev.off() cat(&quot;Saving seurat obj\\n&quot;) # Save the Seurat object saveRDS(seurat_obj, file = paste0(sample_id, &quot;_decontx_seurat_obj.rds&quot;)) # Save decontaminated counts and contamination summary cat(&quot;Saving decontx counts\\n&quot;) write.csv(decontaminated_counts, paste0(sample_id, &quot;_decontx_counts.csv&quot;)) # Print a message indicating that the contamination summary is being saved cat(&quot;Saving contamination summary\\n&quot;) # Ensure contamination_summary is a data frame contamination_summary_df &lt;- as.data.frame(contamination_summary) write.table(contamination_summary_df, file = paste0(sample_id, &quot;_contamination_summary.txt&quot;)) # Optionally return the results return(list(seurat_obj = seurat_obj, decontaminated_counts = decontaminated_counts, contamination_summary = contamination_summary)) } # Run decontX on the input Seurat object and background counts file deconx_results &lt;- run_decontX(&quot;./output_files/empty_drops/removed_empty_Day55.rds&quot;, &quot;./output_files/counts/background_geneSymbol_gene_count.csv&quot;, &quot;./output_files/decontx//Day55&quot;) ## Min. 1st Qu. Median Mean 3rd Qu. Max. ## 0.001336 0.040294 0.065590 0.095857 0.113042 0.810218 ## Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck ## ## Number of nodes: 339 ## Number of edges: 7342 ## ## Running Louvain algorithm... ## Maximum modularity in 10 random starts: 0.8177 ## Number of communities: 8 ## Elapsed time: 0 seconds ## Warning: The default method for RunUMAP has changed from calling Python UMAP via reticulate to the R-native UWOT using the cosine metric ## To use Python UMAP via reticulate, set umap.method to &#39;umap-learn&#39; and metric to &#39;correlation&#39; ## This message will be shown once per session ## Making plots ## Saving seurat obj ## Saving decontx counts ## Saving contamination summary 3.3 Standard gene QC to remove low quality cells Now that we have removed empty drops and ambient RNA we will perform standard QC as described in the Seurat tutorial (found here). First we will determine what our filtering criteria should be using some basic QC plots. Code # standard QC filtering and also remove doublets #define sample name sample_id = &#39;Day55_tutorial&#39; # Create Seurat object seurat_object &lt;- CreateSeuratObject(counts = deconx_results$decontaminated_counts, project = sample_id) # Plot relationship between reads and unique genes per cell plot_scatter1 &lt;- FeatureScatter(seurat_object, feature1 = &quot;nCount_RNA&quot;, feature2 = &quot;nFeature_RNA&quot;) + geom_smooth(method = &quot;lm&quot;) + NoLegend() + labs(title = &quot;Reads vs Unique Genes per Cell BEFORE Filtering&quot;) plot(plot_scatter1) Code # Add mitochondrial percentage seurat_object[[&quot;joined&quot;]] &lt;- JoinLayers(seurat_object[[&quot;RNA&quot;]]) seurat_object[[&quot;percent.mt&quot;]] &lt;- PercentageFeatureSet(seurat_object, pattern = &quot;^MT-&quot;) p1 &lt;- VlnPlot(seurat_object, features = c(&quot;nFeature_RNA&quot;, &quot;nCount_RNA&quot;, &quot;percent.mt&quot;)) p1 + plot_annotation(title = &quot;QC plots (gene level) BEFORE Filtering&quot;) Based on these QC plots we will filter the data with the following values listed in the bellow code chunk. QC paramaters might vary based on your own data so please make sure you filter your data accordingly. Here we will also remove doublets - droplets that contain two or more cells - using the package ‘doubletfinder’. Code # Filter cells based on feature and count thresholds ## define the filtering params - (change these based on your data) max.features = 10000 min.features = 1000 min.counts = 800 max.counts = 100000 MT = 10 npc = 15 doublet_rate = 0.039 cluster_res = 0.9 #now we filter the seurat object based on the QC params listed above filt_seurat_object &lt;- subset(seurat_object, subset = nFeature_RNA &gt; min.features &amp; nFeature_RNA &lt; max.features &amp; percent.mt &lt; MT &amp; nCount_RNA &lt; max.counts &amp; nCount_RNA &gt; min.counts) # Plot quality metrics after filtering p2 &lt;- VlnPlot(filt_seurat_object, features = c(&quot;nFeature_RNA&quot;, &quot;nCount_RNA&quot;, &quot;percent.mt&quot;)) p2 + plot_annotation(title = &quot;QC metrics gene level AFTER Filtering&quot;) Code # Normalize data filt_seurat_object &lt;- NormalizeData(filt_seurat_object, normalization.method = &quot;LogNormalize&quot;, scale.factor = 10000) # Identify highly variable features filt_seurat_object &lt;- FindVariableFeatures(filt_seurat_object, selection.method = &quot;vst&quot;, nfeatures = 2000) # Apply linear transformation all_genes &lt;- rownames(filt_seurat_object) filt_seurat_object &lt;- ScaleData(filt_seurat_object, features = all_genes) # Perform PCA filt_seurat_object &lt;- RunPCA(filt_seurat_object, features = VariableFeatures(object = filt_seurat_object)) # Cluster cells filt_seurat_object &lt;- FindNeighbors(filt_seurat_object, dims = 1:npc) filt_seurat_object &lt;- FindClusters(filt_seurat_object, resolution = cluster_res) ## Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck ## ## Number of nodes: 319 ## Number of edges: 6816 ## ## Running Louvain algorithm... ## Maximum modularity in 10 random starts: 0.7804 ## Number of communities: 8 ## Elapsed time: 0 seconds Code # Perform UMAP filt_seurat_object &lt;- RunUMAP(filt_seurat_object, dims = 1:npc) ### Filter out doublets (remember to modify doublet rate if samples have variable target cells) ## pK Identification (no ground-truth) sweep.res.list_pbmc &lt;- paramSweep(filt_seurat_object, PCs = 1:npc, sct = FALSE) ## [1] &quot;Creating artificial doublets for pN = 5%&quot; ## [1] &quot;Creating Seurat object...&quot; ## [1] &quot;Normalizing Seurat object...&quot; ## [1] &quot;Finding variable genes...&quot; ## [1] &quot;Scaling data...&quot; ## [1] &quot;Running PCA...&quot; ## [1] &quot;Calculating PC distance matrix...&quot; ## [1] &quot;Defining neighborhoods...&quot; ## [1] &quot;Computing pANN across all pK...&quot; ## [1] &quot;pK = 0.03...&quot; ## [1] &quot;pK = 0.04...&quot; ## [1] &quot;pK = 0.05...&quot; ## [1] &quot;pK = 0.06...&quot; ## [1] &quot;pK = 0.07...&quot; ## [1] &quot;pK = 0.08...&quot; ## [1] &quot;pK = 0.09...&quot; ## [1] &quot;pK = 0.1...&quot; ## [1] &quot;pK = 0.11...&quot; ## [1] &quot;pK = 0.12...&quot; ## [1] &quot;pK = 0.13...&quot; ## [1] &quot;pK = 0.14...&quot; ## [1] &quot;pK = 0.15...&quot; ## [1] &quot;pK = 0.16...&quot; ## [1] &quot;pK = 0.17...&quot; ## [1] &quot;pK = 0.18...&quot; ## [1] &quot;pK = 0.19...&quot; ## [1] &quot;pK = 0.2...&quot; ## [1] &quot;pK = 0.21...&quot; ## [1] &quot;pK = 0.22...&quot; ## [1] &quot;pK = 0.23...&quot; ## [1] &quot;pK = 0.24...&quot; ## [1] &quot;pK = 0.25...&quot; ## [1] &quot;pK = 0.26...&quot; ## [1] &quot;pK = 0.27...&quot; ## [1] &quot;pK = 0.28...&quot; ## [1] &quot;pK = 0.29...&quot; ## [1] &quot;pK = 0.3...&quot; ## [1] &quot;Creating artificial doublets for pN = 10%&quot; ## [1] &quot;Creating Seurat object...&quot; ## [1] &quot;Normalizing Seurat object...&quot; ## [1] &quot;Finding variable genes...&quot; ## [1] &quot;Scaling data...&quot; ## [1] &quot;Running PCA...&quot; ## [1] &quot;Calculating PC distance matrix...&quot; ## [1] &quot;Defining neighborhoods...&quot; ## [1] &quot;Computing pANN across all pK...&quot; ## [1] &quot;pK = 0.03...&quot; ## [1] &quot;pK = 0.04...&quot; ## [1] &quot;pK = 0.05...&quot; ## [1] &quot;pK = 0.06...&quot; ## [1] &quot;pK = 0.07...&quot; ## [1] &quot;pK = 0.08...&quot; ## [1] &quot;pK = 0.09...&quot; ## [1] &quot;pK = 0.1...&quot; ## [1] &quot;pK = 0.11...&quot; ## [1] &quot;pK = 0.12...&quot; ## [1] &quot;pK = 0.13...&quot; ## [1] &quot;pK = 0.14...&quot; ## [1] &quot;pK = 0.15...&quot; ## [1] &quot;pK = 0.16...&quot; ## [1] &quot;pK = 0.17...&quot; ## [1] &quot;pK = 0.18...&quot; ## [1] &quot;pK = 0.19...&quot; ## [1] &quot;pK = 0.2...&quot; ## [1] &quot;pK = 0.21...&quot; ## [1] &quot;pK = 0.22...&quot; ## [1] &quot;pK = 0.23...&quot; ## [1] &quot;pK = 0.24...&quot; ## [1] &quot;pK = 0.25...&quot; ## [1] &quot;pK = 0.26...&quot; ## [1] &quot;pK = 0.27...&quot; ## [1] &quot;pK = 0.28...&quot; ## [1] &quot;pK = 0.29...&quot; ## [1] &quot;pK = 0.3...&quot; ## [1] &quot;Creating artificial doublets for pN = 15%&quot; ## [1] &quot;Creating Seurat object...&quot; ## [1] &quot;Normalizing Seurat object...&quot; ## [1] &quot;Finding variable genes...&quot; ## [1] &quot;Scaling data...&quot; ## [1] &quot;Running PCA...&quot; ## [1] &quot;Calculating PC distance matrix...&quot; ## [1] &quot;Defining neighborhoods...&quot; ## [1] &quot;Computing pANN across all pK...&quot; ## [1] &quot;pK = 0.03...&quot; ## [1] &quot;pK = 0.04...&quot; ## [1] &quot;pK = 0.05...&quot; ## [1] &quot;pK = 0.06...&quot; ## [1] &quot;pK = 0.07...&quot; ## [1] &quot;pK = 0.08...&quot; ## [1] &quot;pK = 0.09...&quot; ## [1] &quot;pK = 0.1...&quot; ## [1] &quot;pK = 0.11...&quot; ## [1] &quot;pK = 0.12...&quot; ## [1] &quot;pK = 0.13...&quot; ## [1] &quot;pK = 0.14...&quot; ## [1] &quot;pK = 0.15...&quot; ## [1] &quot;pK = 0.16...&quot; ## [1] &quot;pK = 0.17...&quot; ## [1] &quot;pK = 0.18...&quot; ## [1] &quot;pK = 0.19...&quot; ## [1] &quot;pK = 0.2...&quot; ## [1] &quot;pK = 0.21...&quot; ## [1] &quot;pK = 0.22...&quot; ## [1] &quot;pK = 0.23...&quot; ## [1] &quot;pK = 0.24...&quot; ## [1] &quot;pK = 0.25...&quot; ## [1] &quot;pK = 0.26...&quot; ## [1] &quot;pK = 0.27...&quot; ## [1] &quot;pK = 0.28...&quot; ## [1] &quot;pK = 0.29...&quot; ## [1] &quot;pK = 0.3...&quot; ## [1] &quot;Creating artificial doublets for pN = 20%&quot; ## [1] &quot;Creating Seurat object...&quot; ## [1] &quot;Normalizing Seurat object...&quot; ## [1] &quot;Finding variable genes...&quot; ## [1] &quot;Scaling data...&quot; ## [1] &quot;Running PCA...&quot; ## [1] &quot;Calculating PC distance matrix...&quot; ## [1] &quot;Defining neighborhoods...&quot; ## [1] &quot;Computing pANN across all pK...&quot; ## [1] &quot;pK = 0.03...&quot; ## [1] &quot;pK = 0.04...&quot; ## [1] &quot;pK = 0.05...&quot; ## [1] &quot;pK = 0.06...&quot; ## [1] &quot;pK = 0.07...&quot; ## [1] &quot;pK = 0.08...&quot; ## [1] &quot;pK = 0.09...&quot; ## [1] &quot;pK = 0.1...&quot; ## [1] &quot;pK = 0.11...&quot; ## [1] &quot;pK = 0.12...&quot; ## [1] &quot;pK = 0.13...&quot; ## [1] &quot;pK = 0.14...&quot; ## [1] &quot;pK = 0.15...&quot; ## [1] &quot;pK = 0.16...&quot; ## [1] &quot;pK = 0.17...&quot; ## [1] &quot;pK = 0.18...&quot; ## [1] &quot;pK = 0.19...&quot; ## [1] &quot;pK = 0.2...&quot; ## [1] &quot;pK = 0.21...&quot; ## [1] &quot;pK = 0.22...&quot; ## [1] &quot;pK = 0.23...&quot; ## [1] &quot;pK = 0.24...&quot; ## [1] &quot;pK = 0.25...&quot; ## [1] &quot;pK = 0.26...&quot; ## [1] &quot;pK = 0.27...&quot; ## [1] &quot;pK = 0.28...&quot; ## [1] &quot;pK = 0.29...&quot; ## [1] &quot;pK = 0.3...&quot; ## [1] &quot;Creating artificial doublets for pN = 25%&quot; ## [1] &quot;Creating Seurat object...&quot; ## [1] &quot;Normalizing Seurat object...&quot; ## [1] &quot;Finding variable genes...&quot; ## [1] &quot;Scaling data...&quot; ## [1] &quot;Running PCA...&quot; ## [1] &quot;Calculating PC distance matrix...&quot; ## [1] &quot;Defining neighborhoods...&quot; ## [1] &quot;Computing pANN across all pK...&quot; ## [1] &quot;pK = 0.03...&quot; ## [1] &quot;pK = 0.04...&quot; ## [1] &quot;pK = 0.05...&quot; ## [1] &quot;pK = 0.06...&quot; ## [1] &quot;pK = 0.07...&quot; ## [1] &quot;pK = 0.08...&quot; ## [1] &quot;pK = 0.09...&quot; ## [1] &quot;pK = 0.1...&quot; ## [1] &quot;pK = 0.11...&quot; ## [1] &quot;pK = 0.12...&quot; ## [1] &quot;pK = 0.13...&quot; ## [1] &quot;pK = 0.14...&quot; ## [1] &quot;pK = 0.15...&quot; ## [1] &quot;pK = 0.16...&quot; ## [1] &quot;pK = 0.17...&quot; ## [1] &quot;pK = 0.18...&quot; ## [1] &quot;pK = 0.19...&quot; ## [1] &quot;pK = 0.2...&quot; ## [1] &quot;pK = 0.21...&quot; ## [1] &quot;pK = 0.22...&quot; ## [1] &quot;pK = 0.23...&quot; ## [1] &quot;pK = 0.24...&quot; ## [1] &quot;pK = 0.25...&quot; ## [1] &quot;pK = 0.26...&quot; ## [1] &quot;pK = 0.27...&quot; ## [1] &quot;pK = 0.28...&quot; ## [1] &quot;pK = 0.29...&quot; ## [1] &quot;pK = 0.3...&quot; ## [1] &quot;Creating artificial doublets for pN = 30%&quot; ## [1] &quot;Creating Seurat object...&quot; ## [1] &quot;Normalizing Seurat object...&quot; ## [1] &quot;Finding variable genes...&quot; ## [1] &quot;Scaling data...&quot; ## [1] &quot;Running PCA...&quot; ## [1] &quot;Calculating PC distance matrix...&quot; ## [1] &quot;Defining neighborhoods...&quot; ## [1] &quot;Computing pANN across all pK...&quot; ## [1] &quot;pK = 0.03...&quot; ## [1] &quot;pK = 0.04...&quot; ## [1] &quot;pK = 0.05...&quot; ## [1] &quot;pK = 0.06...&quot; ## [1] &quot;pK = 0.07...&quot; ## [1] &quot;pK = 0.08...&quot; ## [1] &quot;pK = 0.09...&quot; ## [1] &quot;pK = 0.1...&quot; ## [1] &quot;pK = 0.11...&quot; ## [1] &quot;pK = 0.12...&quot; ## [1] &quot;pK = 0.13...&quot; ## [1] &quot;pK = 0.14...&quot; ## [1] &quot;pK = 0.15...&quot; ## [1] &quot;pK = 0.16...&quot; ## [1] &quot;pK = 0.17...&quot; ## [1] &quot;pK = 0.18...&quot; ## [1] &quot;pK = 0.19...&quot; ## [1] &quot;pK = 0.2...&quot; ## [1] &quot;pK = 0.21...&quot; ## [1] &quot;pK = 0.22...&quot; ## [1] &quot;pK = 0.23...&quot; ## [1] &quot;pK = 0.24...&quot; ## [1] &quot;pK = 0.25...&quot; ## [1] &quot;pK = 0.26...&quot; ## [1] &quot;pK = 0.27...&quot; ## [1] &quot;pK = 0.28...&quot; ## [1] &quot;pK = 0.29...&quot; ## [1] &quot;pK = 0.3...&quot; Code sweep.stats_pbmc &lt;- summarizeSweep(sweep.res.list_pbmc, GT = FALSE) bcmvn_pbmc &lt;- find.pK(sweep.stats_pbmc) ## NULL Code ##### pK &lt;- bcmvn_pbmc %&gt;% filter(BCmetric == max(BCmetric)) %&gt;% dplyr::select(pK) pK &lt;- as.numeric(as.character(pK[[1]])) ## Homotypic Doublet Proportion Estimate annotations &lt;- filt_seurat_object@meta.data$seurat_clusters homotypic.prop &lt;- modelHomotypic(annotations) nExp_poi &lt;- round(doublet_rate * nrow(filt_seurat_object@meta.data)) nExp_poi.adj &lt;- round(nExp_poi * (1 - homotypic.prop)) # Run doubletFinder filt_seurat_object &lt;- doubletFinder(filt_seurat_object, PCs = 1:npc, pN = 0.25, pK = pK, nExp = nExp_poi.adj, reuse.pANN = FALSE, sct = FALSE) ## [1] &quot;Creating 106 artificial doublets...&quot; ## [1] &quot;Creating Seurat object...&quot; ## [1] &quot;Normalizing Seurat object...&quot; ## [1] &quot;Finding variable genes...&quot; ## [1] &quot;Scaling data...&quot; ## [1] &quot;Running PCA...&quot; ## [1] &quot;Calculating PC distance matrix...&quot; ## [1] &quot;Computing pANN...&quot; ## [1] &quot;Classifying doublets..&quot; Code colnames(filt_seurat_object@meta.data) &lt;- sub(&quot;DF.classifications_.*$&quot;, &quot;DF.classifications&quot;, colnames(filt_seurat_object@meta.data)) # Summary doublets statsDoublets &lt;- filt_seurat_object@meta.data %&gt;% group_by(DF.classifications) %&gt;% summarize(Median_nCount_RNA = median(nCount_RNA), Median_nFeature_RNA = median(nFeature_RNA), Count = n()) ###Save the seurat object with doublets listed filt_seurat_object_doublets &lt;- filt_seurat_object filt_seurat_object &lt;- subset(filt_seurat_object, subset = DF.classifications == &#39;Singlet&#39;) # figures ggplot_list &lt;- list( ElbowPlot(filt_seurat_object) + labs(title = &#39;SD explained by each PC&#39;) + theme(text = element_text(size = 10)), FeatureScatter(filt_seurat_object, feature1 = &quot;nCount_RNA&quot;, feature2 = &quot;nFeature_RNA&quot;) + geom_smooth(method = &quot;lm&quot;) + NoLegend() + labs(title = &quot;Association between reads and \\nunique genes per cell AFTER filtering&quot;), DimPlot(filt_seurat_object, reduction = &quot;umap&quot;) + labs(color = &quot;Cluster \\n(from PCA)&quot;, title = &#39;&#39;) + theme(text = element_text(size = 10)), FeaturePlot(filt_seurat_object, reduction = &quot;umap&quot;, features = &#39;nCount_RNA&#39;) + labs(color = &quot;UMI count&quot;, title = &#39;&#39;) + theme(text = element_text(size = 10)), FeaturePlot(filt_seurat_object, reduction = &quot;umap&quot;, features = &#39;nFeature_RNA&#39;) + labs(color = str_wrap(&quot;Feature count (gene)&quot;, 15), title = &#39;&#39;) + theme(text = element_text(size = 10)), p2 ) combined_plots &lt;- plot_grid(plotlist = ggplot_list, ncol = 3) plot(combined_plots) Code plot(DimPlot(filt_seurat_object_doublets, reduction = &#39;umap&#39;, group.by = &quot;DF.classifications&quot;)) Code tbl_sts1 &lt;- tableGrob(statsDoublets) grid.newpage() grid.draw(tbl_sts1) Code stats_sumary &lt;- rbind(&quot;Sample ID&quot; = sample_id, &quot;Cells_before_filter&quot; = dim(seurat_object)[2], &quot;Cells_after_filter&quot; = dim(filt_seurat_object)[2], &quot;Median Feature per Cell before filter&quot; = median(seurat_object$nFeature_RNA), &quot;Median Reads per Gene before filter&quot; = median(seurat_object$nCount_RNA), &quot;Median Feature per Cell&quot; = median(filt_seurat_object$nFeature_RNA), &quot;Median Reads per Gene&quot; = median(filt_seurat_object$nCount_RNA), &quot;Max Features&quot; = max.features, &quot;Min Features&quot; = min.features, &quot;Min Counts&quot; = min.counts, &quot;Max Counts&quot; = max.counts, &quot;MT Percentage&quot; = MT, &quot;NPCs&quot; = npc, &quot;Median Percent MT before Filter&quot; = median(seurat_object@meta.data[[&quot;percent.mt&quot;]]), &quot;Median Percent MT after Filter&quot; = median(filt_seurat_object@meta.data[[&quot;percent.mt&quot;]]) ) tbl_sts2 &lt;- tableGrob(stats_sumary) grid.newpage() grid.draw(tbl_sts2) Code #save files saveRDS(filt_seurat_object, file = paste0(&quot;./output_files/QC/&quot;, sample_id, &quot;_umap_object.rds&quot;)) saveRDS(filt_seurat_object_doublets, file = paste0(&quot;./output_files/QC/&quot;,sample_id, &quot;_with_doublets_umap_object.rds&quot;)) write.table(stats_sumary, file = paste0(&quot;./output_files/QC/&quot;, sample_id, &quot;_stats.csv&quot;)) Now that we have filtered the object to ensure we retain high quality data we are going to add in the isoform level information. "],["add-isoform-counts-to-seurat-object.html", "Chapter 4 Add isoform counts to Seurat object 4.1 Create a Seurat object with isoform expression data 4.2 Filter the new Seurat object based on gene level information 4.3 Add the isoform assay to the Seurat object", " Chapter 4 Add isoform counts to Seurat object 4.1 Create a Seurat object with isoform expression data Now that we have 309 high-quality cells for our downstream analysis, let’s incorporate isoform-level information into our Seurat object. The first step is to read in the outputs from FLAMES, which provides isoform-level counts from Oarfish. We’ll create a new Seurat object for this data, specifically for the isoform counts, and add it as a new assay to our existing object. This setup will allow us to explore both gene-level and isoform-level counts within a single Seurat object, giving us a more comprehensive view of our data. Code #This function reads in Oarfish count files and creates a csv file of count data. The function also appends the gene symbol to the ENSTID process_oarfish_files_to_counts_matrix &lt;- function(flames_output_folder, sample_name, output_dir) { # Read in the resource table (transcript_id, gene_id, gene_symbol) # Define the file paths based on the sample name count_matrix_path &lt;- file.path(flames_output_folder, paste0(sample_name, &quot;.count.mtx&quot;)) barcodes_path &lt;- file.path(flames_output_folder, paste0(sample_name, &quot;.barcodes.txt&quot;)) features_path &lt;- file.path(flames_output_folder, paste0(sample_name, &quot;.features.txt&quot;)) # Read the data counts &lt;- readMM(count_matrix_path) barcodes &lt;- readLines(barcodes_path) features &lt;- read.delim(features_path, header = FALSE) # Transpose the matrix for Seurat compatibility counts &lt;- t(counts) # Set row and column names rownames(counts) &lt;- features$V1 colnames(counts) &lt;- barcodes # Convert to a data frame counts_df &lt;- as.data.frame(counts) # Add transcript_id as the first column counts_df$transcript_id &lt;- rownames(counts_df) counts_df &lt;- counts_df[, c(ncol(counts_df), 1:(ncol(counts_df)-1))] # Merge with the resource table to add gene symbols df_genesymbol &lt;- counts_df %&gt;% left_join(isoform_gene_dict, by = &quot;transcript_id&quot;) # Remove the gene_id column and reorder the columns df_genesymbol$gene_id &lt;- NULL df_genesymbol &lt;- df_genesymbol[, c(ncol(df_genesymbol), 1:(ncol(df_genesymbol)-1))] # Update row names to include gene symbol instead of transcript_id rownames(df_genesymbol) &lt;- paste0(df_genesymbol$transcript_id, &quot;_&quot;, df_genesymbol$gene_symbol) df_genesymbol$transcript_id &lt;- NULL df_genesymbol$gene_symbol &lt;- NULL # Write the output to a CSV file output_path &lt;- file.path(output_dir, paste0(&quot;gene_symbol_&quot;, sample_name, &quot;_counts.csv&quot;)) write.csv(df_genesymbol, output_path) cat(&quot;Processed sample:&quot;, sample_name, &quot;\\nOutput saved to:&quot;, output_path, &quot;\\n&quot;) return(df_genesymbol) } oarfish_counts &lt;- process_oarfish_files_to_counts_matrix( flames_output_folder = &quot;/data/scratch/users/yairp/FLAMES_Day55/outs/&quot;, sample_name = &quot;oarfish&quot;, output_dir = &quot;./output_files/counts/&quot; ) ## Processed sample: oarfish ## Output saved to: ./output_files/counts//gene_symbol_oarfish_counts.csv Code # Create the Seurat object with iso counts iso_seurat_obj &lt;- CreateSeuratObject(counts = oarfish_counts, project = sample_id) VlnPlot(iso_seurat_obj, features = c(&quot;nFeature_RNA&quot;, &quot;nCount_RNA&quot;), ncol = 2) + plot_annotation(title = &quot;QC plots (isoform level) BEFORE Filtering&quot;) 4.2 Filter the new Seurat object based on gene level information We have now created a Seurat object with isoform-level count data. Users can take this object and follow similar processing steps as at the gene level 3, which might include filtering out low-quality cells and removing ambient RNA counts. In our case, we evaluated these steps and found they don’t add much value as low quality cells are already removed at the gene level and we can leverage this information rather than processing the isoform counts in the same way. Additionally, tools like DecontX and SoupX haven’t been tested on isoform count data, so we decided to exclude this analysis. Instead, we believe the most valuable approach is to append the isoform data to our gene-level Seurat object, resulting in two assays: one for gene-level and one for isoform-level data. If users have short-read data, they could similarly add it as a third assay. Since we’ve already filtered out low-quality cells based on our gene-level data, we’ll use these high-quality cells to filter our isoform data. Code #### isoform assay ## filter the data so iso and gene cells match oarfish_iso_matched_gene &lt;- subset(iso_seurat_obj, cells =filt_seurat_object@graphs[[&quot;RNA_nn&quot;]]@Dimnames[[1]]) #Rejoin data sets after integration oarfish_iso_matched_gene &lt;- JoinLayers(oarfish_iso_matched_gene) counts_table_iso &lt;- oarfish_iso_matched_gene[[&quot;RNA&quot;]]$counts as.data.frame(counts_table_iso) -&gt; df_iso # Remove rows where the sum is 0 df_iso &lt;- df_iso[rowSums(df_iso) != 0, ] filt_seurat_object[[&quot;iso&quot;]] &lt;- CreateAssay5Object(counts = df_iso) # Normalize the new assay data filt_seurat_object &lt;- NormalizeData(filt_seurat_object, assay = &quot;iso&quot;) filt_seurat_object &lt;- FindVariableFeatures(filt_seurat_object, assay = &quot;iso&quot;) filt_seurat_object &lt;- ScaleData(filt_seurat_object, assay = &quot;iso&quot;) filt_seurat_object &lt;- RunPCA(filt_seurat_object, assay = &quot;iso&quot;, reduction.name = &quot;pca_iso&quot;) #Run UMAP filt_seurat_object &lt;- RunUMAP(filt_seurat_object, reduction = &quot;pca_iso&quot;, dims = 1:15, assay = &quot;iso&quot;, reduction.name = &quot;umap_iso&quot;) #check to see that we have two assays filt_seurat_object ## An object of class Seurat ## 93557 features across 309 samples within 3 assays ## Active assay: RNA (14906 features, 2000 variable features) ## 3 layers present: counts, data, scale.data ## 2 other assays present: joined, iso ## 4 dimensional reductions calculated: pca, umap, pca_iso, umap_iso Code # visualize the UMAP for Gene and isoform DimPlot(filt_seurat_object, label = TRUE, reduction = &quot;umap&quot;) + ggtitle(&quot;UMAP gene level clustering&quot;) | DimPlot(filt_seurat_object, label = TRUE, reduction = &quot;umap_iso&quot;) + ggtitle(&quot;UMAP isoform level clustering&quot;) Code seu_obj &lt;- filt_seurat_object saveRDS(seu_obj, file = &quot;./output_files/seu_objects/Day55_tutorial_gene_and_isoform_seurat.rds&quot;) 4.3 Add the isoform assay to the Seurat object Great! We now have an object containing both assays, so we can start by plotting some of our favorite genes and isoforms. This setup gives us the flexibility to visualize gene expression on isoform UMAPs and vice versa, allowing us to integrate and explore the expression of both gene and isoform expression within single cells on the same dimensional reduction. Let’s begin by plotting VIM and TBR1. VIM is a marker of progenitor cells, while TBR1 is a marker of deep layer neurons. Code ####### test plotting on iso assays ## features &lt;- rownames(filt_seurat_object@assays$iso@features) gene &lt;- &quot;VIM&quot; plot_features_list &lt;- grep(paste0(&quot;(^|-|\\\\b)&quot;, gene, &quot;($|\\\\b)&quot;), features, value = TRUE) #We can now plot our favorite gene and all its corresponding isoforms on either the gene or isoform UMAPs. To switch between them, simply change the reduction argument to the desired UMAP (either the gene or isoform reduction) FeaturePlot(filt_seurat_object, features = plot_features_list, reduction = &quot;umap_iso&quot;) Code FeaturePlot(filt_seurat_object, features = gene, reduction = &quot;umap&quot;) Code #let&#39;s also plot the isoform data on the gene level clusters. FeaturePlot(filt_seurat_object, features = plot_features_list, reduction = &quot;umap&quot;) + plot_annotation( title = &#39;VIM isoform expression plotted on gene level clusters&#39;, #caption = &#39;made with patchwork&#39;, theme = theme(plot.title = element_text(size = 20)) ) Code gene &lt;- &quot;TBR1&quot; plot_features_list &lt;- grep(paste0(&quot;(^|-|\\\\b)&quot;, gene, &quot;($|\\\\b)&quot;), features, value = TRUE) #We can now plot our favorite gene and all its corresponding isoforms on either the gene or isoform UMAPs. To switch between them, simply change the reduction argument to the desired UMAP (either the gene or isoform reduction) FeaturePlot(filt_seurat_object, features = plot_features_list, reduction = &quot;umap_iso&quot;) Code FeaturePlot(filt_seurat_object, features = gene, reduction = &quot;umap&quot;) Code #let&#39;s also plot the isoform data on the gene level clusters. FeaturePlot(filt_seurat_object, features = plot_features_list, reduction = &quot;umap&quot;) + plot_annotation( title = &#39;TBR1 isoform expression plotted on gene level clusters&#39;, #caption = &#39;made with patchwork&#39;, theme = theme(plot.title = element_text(size = 20)) ) We observe that the expression of VIM and TBR1 are localized to two distinct clusters, which aligns with our expectations. This suggests that some cells remain in the progenitor/radial glial stage, while others have already begun differentiating into neurons. Furthermore, our data reveals isoform-level expression for each of our genes, including TBR1, which shows distinct isoform expression patterns across different cell populations. To plot genes and expressed isoforms from that gene simply change the ‘gene’ value to your favorite gene and run the code chunk above. Now we have a count matrix with two assays, gene and isoform. There are many avenues for analysis. We will begin with finding DE genes and isoforms. Then we identify cell types and perform trajectory analysis. finally we look into interesting isoforms unique to each cluster "],["finding-marker-genes-and-isoforms.html", "Chapter 5 Finding marker genes and isoforms 5.1 Differentially expressed genes by cluster identity 5.2 Identifying cell types 5.3 DE genes and isoforms based on annotated cell types. 5.4 Volcano plots", " Chapter 5 Finding marker genes and isoforms 5.1 Differentially expressed genes by cluster identity First we can look at marker genes for each cluster. This will help us identify which genes are DE in each cluster and indicate the identity of each cluster. We will also look at DE isoforms using the same methodology. Code #Find markers for all clusters using the &quot;RNA&quot; and &quot;iso&quot; assay all_markers_gene_cluster &lt;- FindAllMarkers(seu_obj, assay = &quot;RNA&quot;, do.print = TRUE, logfc.threshold = 0.5, min.pct = 0.20, only.pos = TRUE) %&gt;% dplyr::filter(p_val_adj &lt; 0.05) all_markers_iso_cluster &lt;- FindAllMarkers(seu_obj, assay = &quot;iso&quot;, do.print = TRUE, logfc.threshold = 0.5, min.pct = 0.20, only.pos = TRUE) %&gt;% dplyr::filter(p_val_adj &lt; 0.05) #save the list of DE genes write.csv(all_markers_gene_cluster, &quot;./output_files/DE/all_markers_one_gene.csv&quot;) write.csv(all_markers_iso_cluster, &quot;./output_files/DE/all_markers_one_iso.csv&quot;) 5.2 Identifying cell types Based on these differentially expressed (DE) genes, we can identify the cell types present in our sample. This process is often complex and requires prior knowledge of cell markers as well as an understanding of the cell types expected in the sample. An alternative approach is to use automated cell type identification tools. In this tutorial, we will use ScType Ianevski et al. (2022) . However, it is important to note that the accuracy of automated tools varies and depends heavily on the reference database they utilize. Therefore, it is recommended to use a combination of methods to cross-validate cell type identification and ensure robust results. Code # load libraries from sctype invisible(lapply(c(&quot;ggraph&quot;,&quot;igraph&quot;,&quot;tidyverse&quot;, &quot;data.tree&quot;), library, character.only = T)) invisible(lapply(c(&quot;dplyr&quot;,&quot;Seurat&quot;,&quot;HGNChelper&quot;), library, character.only = T)) # load gene set preparation function source(&quot;https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/R/gene_sets_prepare.R&quot;) # load cell type annotation function source(&quot;https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/R/sctype_score_.R&quot;) #### # define functions perform_sctype_analysis &lt;- function(seurat_obj, db_, tissue, gs_removal_list = c(), metadata_col_prefix = &quot;db_prefix&quot;, figure_prefix =&quot;fig_name&quot;, cluster_res = &quot;RNA_snn_res.0.9&quot;, output_file = &quot;&quot;, reduction = &quot;umap&quot;) { # Prepare gene sets gs_list &lt;- gene_sets_prepare(db_, tissue) # Remove specified gene sets for (gs in gs_removal_list) { gs_list[[&quot;gs_positive&quot;]][[gs]] &lt;- NULL } # Calculate sctype scores es.max &lt;- sctype_score(scRNAseqData = seurat_obj@assays$RNA$scale.data, scaled = TRUE, gs = gs_list$gs_positive, gs2 = gs_list$gs_negative) # Set identities in Seurat object Idents(seurat_obj) &lt;- cluster_res # Merge by cluster cL_results &lt;- do.call(&quot;rbind&quot;, lapply(unique(seurat_obj@meta.data[[cluster_res]]), function(cl) { es.max.cl &lt;- sort(rowSums(es.max[, rownames(seurat_obj@meta.data[seurat_obj@meta.data[[cluster_res]] == cl, ])]), decreasing = TRUE) head(data.frame(cluster = cl, type = names(es.max.cl), scores = es.max.cl, ncells = sum(seurat_obj@meta.data[[cluster_res]] == cl)), 10) })) sctype_scores &lt;- cL_results %&gt;% group_by(cluster) %&gt;% top_n(n = 1, wt = scores) # Set low-confident clusters to &quot;Unknown&quot; sctype_scores$scores &lt;- as.numeric(sctype_scores$scores) sctype_scores$type[sctype_scores$scores &lt; sctype_scores$ncells / 4] &lt;- &quot;Unknown&quot; print(sctype_scores[, 1:3]) # Overlay the labels seurat_obj@meta.data[[metadata_col_prefix]] &lt;- &quot;&quot; for (j in unique(sctype_scores$cluster)) { cl_type &lt;- sctype_scores[sctype_scores$cluster == j,] seurat_obj@meta.data[[metadata_col_prefix]][seurat_obj@meta.data[[cluster_res]] == j] &lt;- as.character(cl_type$type[1]) } # Plotting pclass &lt;- DimPlot(seurat_obj, reduction = reduction, label = TRUE, repel = TRUE, group.by = metadata_col_prefix) print(pclass) # Save the plot to a PDF pdf(file = paste0(figure_prefix, &quot;_&quot;, metadata_col_prefix, &quot;_sctype_genes.pdf&quot;), width = 8, height = 8) print(pclass + ggtitle(figure_prefix)) dev.off() # Save the updated Seurat object to an RDS file #if (output_file != &quot;&quot;) { # saveRDS(seurat_obj, file = paste0(output_file, &quot;.rds&quot;)) #} # Return the updated Seurat object return(seurat_obj) } # Define variables db_ = &quot;https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/ScTypeDB_full.xlsx&quot;; # this is a default database from sctype tissue &lt;- &quot;Brain&quot; gs_removal_list &lt;- c(&quot;Tanycytes&quot;) # list of cell types from the db to remove seu_obj &lt;- perform_sctype_analysis(seu_obj, db_, tissue, gs_removal_list, metadata_col_prefix =&quot;sctype_db&quot;, figure_prefix = &quot;Day_55&quot;, output_file = &quot;Day_55&quot;, cluster_res = &quot;RNA_snn_res.0.9&quot;, reduction = &quot;umap&quot;) ## # A tibble: 8 × 3 ## # Groups: cluster [8] ## cluster type scores ## &lt;fct&gt; &lt;chr&gt; &lt;dbl&gt; ## 1 2 Immature neurons 81.3 ## 2 7 Myelinating Schwann cells 7.18 ## 3 0 Mature neurons 108. ## 4 6 Mature neurons 37.4 ## 5 3 Radial glial cells 85.1 ## 6 4 GABAergic neurons 82.8 ## 7 5 Radial glial cells 92.0 ## 8 1 Radial glial cells 94.0 ScType gives us some indication of which cell types we have in our data. We can use the DE genes to get some more specific info. Glutamatergic neuronal markers “SLC17A7”,“SLC17A6”,“GRIN1”,“GRIN2B” are all DE in cluster 0 - the mature neuron cluster. This suggests these cells are likely glutamatergic neurons. Code # markers for FeaturePlot(seu_obj, features = c(&quot;SLC17A7&quot;,&quot;SLC17A6&quot;,&quot;GRIN1&quot;,&quot;GRIN2B&quot;)) Code library(gprofiler2) set_base_url(&quot;https://biit.cs.ut.ee/gprofiler_beta&quot;) background_genes &lt;- rownames(GetAssayData(seu_obj, assay = &quot;RNA&quot;, layer = &quot;counts&quot;))[ Matrix::rowSums(GetAssayData(seu_obj, assay = &quot;RNA&quot;, layer = &quot;counts&quot;) &gt; 0) &gt; 0 ] # Filter for significant genes in the current cluster sig_genes &lt;- all_markers_gene_cluster %&gt;% filter(cluster == 0 &amp; p_val_adj &lt; 0.05) %&gt;% # Filter for cluster 0 and adjusted p-value &lt; 0.05 pull(gene) # Extract gene names # Step 5: Run g:Profiler for pathway enrichment analysis pathway_results &lt;- gprofiler2::gost( query = sig_genes, ordered_query = TRUE, correction_method = &#39;fdr&#39;, custom_bg = background_genes, sources = c(&quot;GO&quot;, &quot;KEGG&quot;, &quot;REACTOME&quot;) ) # Prepare the data for plotting df_path &lt;- as_tibble(pathway_results$result) %&gt;% filter(term_size &lt; 3000, term_size &gt; 5) %&gt;% filter(!term_id %in% unlist(pathway_results$parents)) # Step 6: Plot top 5 results per database df_path %&gt;% group_by(source) %&gt;% slice_min(p_value, n = 5, with_ties = TRUE) %&gt;% ungroup() %&gt;% ggplot(aes(x = reorder(term_name, -p_value), y = -log10(p_value), fill = source)) + geom_bar(stat = &#39;identity&#39;, position = position_identity()) + coord_flip() + theme_bw() + labs(x = &quot;&quot;) + facet_grid(source ~ ., space = &#39;free&#39;, scales = &#39;free&#39;) + theme(legend.position = &#39;none&#39;, axis.text.y = element_text(angle = 0, size = 8)) + # Rotate and adjust y-axis text size ggtitle(paste(&quot;Pathway Enrichment for cluster 0&quot;)) # Add title with cluster name Based on the enriched terms, we can confidently conclude that the cell type is neuronal. Both the KEGG and the GO:MF terms support the hypothesis that the cells in cluster 0 have glutamatergic synapses. This analysis can be done on all the clusters in the Seurat object. We can now change the Mature neurons label to Glutamatergic neurons and plot the updated UMAP. Code ## Change the names of ScType DF to Glutamatergic neurons in metadata seu_obj@meta.data$sctype_db &lt;- gsub(&quot;Mature neurons&quot;, &quot;Glutamatergic neurons&quot;, seu_obj@meta.data$sctype_db) DimPlot(seu_obj, group.by = &quot;sctype_db&quot;, reduction = &quot;umap&quot;) | DimPlot(seu_obj, reduction =&quot;umap_iso&quot;, group.by = &quot;sctype_db&quot;) Let’s take a closer look at the Myelinating Schwann cells. This cell type is somewhat unexpected given the cortical differentiation context. To better understand their identity, we’ll examine their marker expression, counts, and key features. Code VlnPlot(seu_obj, features = c(&quot;nCount_RNA&quot;, &quot;nFeature_RNA&quot;, &quot;percent.mt&quot;), group.by = &quot;sctype_db&quot;, pt.size = 0.1) Let’s look at some Radial glial Markers. Code FeaturePlot(seu_obj, features = c(&quot;VIM&quot;, &quot;SOX2&quot;, &quot;PAX6&quot;, &quot;NES&quot;), reduction = &quot;umap&quot;, ncol = 2) let’s look at the top marker genes in this cluster. Code # Filter top markers for cluster 7 top_cluster7 &lt;- all_markers_gene_cluster %&gt;% filter(cluster == 7) %&gt;% arrange(p_val_adj, desc(avg_log2FC)) %&gt;% slice_head(n = 20) # top 10 markers, adjust as needed # View the top genes print(top_cluster7$gene) ## [1] &quot;RPS16&quot; &quot;RPL35A&quot; &quot;RPL24&quot; &quot;ENSG00000293320&quot; &quot;RPL32&quot; &quot;IQCG&quot; &quot;RPS7&quot; ## [8] &quot;RPL37&quot; &quot;RPL26&quot; &quot;ENSG00000280441&quot; &quot;RPS3A&quot; &quot;RPL18&quot; &quot;RPS19&quot; &quot;FAU&quot; ## [15] &quot;RPL11&quot; &quot;RPS18&quot; &quot;RPL5&quot; &quot;STRAP&quot; &quot;SUMO2&quot; &quot;RPL10&quot; Based on the plots above, Myelinating Schwann cells show markedly fewer detected features and lower total counts compared to other populations. Additionally, the expression profiles indicate that this cluster lacks canonical radial glial markers such as VIM, SOX2, and PAX6 (shown above). Differential expression analysis using the FindAllMarkers function also revealed a high proportion of ribosomal genes among the top markers for this cluster. Taken together, these findings suggest that this cluster does not represent a bona fide neural lineage. Instead, these cells are likely low-complexity or low-quality cells that have passed the initial QC filters. Therefore, we will remove this cluster from downstream analyses. It would also be sensible to label these cells as “Unknown’ but for simplicity we will remove them Code ## Remove Myelinating Schwann cells seu_obj &lt;- subset(seu_obj, subset = sctype_db != &quot;Myelinating Schwann cells&quot;) DimPlot(seu_obj, group.by = &quot;sctype_db&quot;, reduction = &quot;umap&quot;) Cell type identification is an iterative process and often one of the most challenging aspects of single-cell analysis. For this example, we will assume that our combined approach, using automated cell type identification, differential expression (DE) analysis based on clusters and Gene set enrichment, provides a good indication of the cell types present in our data. It is possible to explore the these cell types in more detail as there are likely many subtypes. For the purposes of the tutorial we will leave this annotation as is. Based on this we have 3 main cell types. Radial glial cells (RG) Excitatory neurons (Glutamatergic neurons and Immature neurons) GABAergic neurons We can use a very nice package called dittoSeq (https://bioconductor.org/packages/devel/bioc/vignettes/dittoSeq/inst/doc/dittoSeq.html) to Visualise scRNA seq data directly from a Seurat object. We can plot the distribution of the 3 cell types in a few different ways using dittoBarPlot Code library(dittoSeq) dittoBarPlot(seu_obj, &quot;orig.ident&quot;, group.by = &quot;sctype_db&quot;, scale = &quot;count&quot;) | dittoBarPlot(seu_obj, &quot;sctype_db&quot;, group.by = &quot;orig.ident&quot;, scale = &quot;percent&quot;) 5.3 DE genes and isoforms based on annotated cell types. With this foundation, we can refine our DE analysis by focusing on cell types rather than clusters. This step is critical in nearly all transcriptomic analyses, offering a wide range of possibilities for downstream investigations. A common downstream approach involves generating volcano plots to visualize DE genes and isoforms. performing gene set enrichment analysis, In the following sections, we will demonstrate how to perform these types of analyses and explore their potential applications. The code chunk below provides an example of how to execute these analyses: Code #Set identities based on cell type Idents(seu_obj) &lt;- &quot;sctype_db&quot; all_markers_gene_celltype &lt;- FindAllMarkers( object = seu_obj, assay = &quot;RNA&quot;, group.by = &quot;sctype_db&quot;, # Replace with your metadata column name logfc.threshold = 0.5, min.pct = 0.20, only.pos = FALSE # changed this to false to get negatively DE genes to ) all_markers_iso_celltype &lt;- FindAllMarkers( object = seu_obj, assay = &quot;iso&quot;, group.by = &quot;sctype_db&quot;, # Replace with your metadata column name logfc.threshold = 0.5, min.pct = 0.20, only.pos = FALSE # changed this to false to get negatively DE genes to ) #save the list of DE genes write.csv(all_markers_gene_celltype, &quot;./output_files/DE/all_markers_one_gene_celltype.csv&quot;) write.csv(all_markers_iso_celltype, &quot;./output_files/DE/all_markers_one_iso_celltype.csv&quot;) A basic way of exploring this data is to plot these markers on a heatmap. Seurat has a nice function to do so. Let us plot the top 5 marker genes and isoforms in each cell type Code all_markers_gene_celltype %&gt;% group_by(cluster) %&gt;% dplyr::filter(avg_log2FC &gt; 1) %&gt;% slice_head(n = 5) %&gt;% ungroup() -&gt; G_top5 DoHeatmap(seu_obj, features = G_top5$gene, assay = &quot;RNA&quot;, size = 3) + NoLegend() Code all_markers_iso_celltype %&gt;% group_by(cluster) %&gt;% dplyr::filter(avg_log2FC &gt; 1) %&gt;% slice_head(n = 5) %&gt;% ungroup() -&gt; I_top5 DoHeatmap(seu_obj, features = I_top5$gene, assay = &quot;iso&quot;, size = 3) + NoLegend() Personally I find the same plots generated by dittoHeatmap much nicer. The function can also take a list of genes or isoforms of interest. Just remember to set the default assay accordingly. Code #list_of_genes &lt;- c(&quot;VIM&quot;, &quot;MAPT&quot;, &quot;KLC1&quot;, &quot;RBFOX1&quot;, &quot;RBFOX3&quot;) DefaultAssay(seu_obj) &lt;- &quot;RNA&quot; dittoHeatmap(seu_obj, head(G_top5$gene, 25), scaled.to.max = FALSE, complex = FALSE, heatmap.colors.max.scaled = FALSE, annot.by = c(&quot;sctype_db&quot;)) Code DefaultAssay(seu_obj) &lt;- &quot;iso&quot; dittoHeatmap(seu_obj, head(I_top5$gene, 25), scaled.to.max = FALSE, complex = FALSE, heatmap.colors.max.scaled = FALSE, annot.by = c(&quot;sctype_db&quot;)) 5.4 Volcano plots 5.4.1 FindAllMarkers DE Next we can explore this data by generating some volcano plots. This analysis can be useful to identify genes and isoforms that are DE and also have large fold changes. Often these types of features are the interesting for further analysis. This can be done for any of the cell types defined in our object. For the sake of brevity we will look at the glutamatergic neurons. When plotting the volcano plots, we observe that many genes exhibit both statistically significant p-values (p &lt; 0.05) and log2 fold changes -2&lt; or &gt;2. To highlight key findings, we have labeled some glutamatergic marker genes, demonstrating that the genes we expect to be upregulated in this cell type are indeed showing the expected pattern. Additionally, we have labeled VIM, a marker of radial glial and progenitor cells. As anticipated, VIM expression is downregulated in these neurons, which aligns with our expectations. Code library(EnhancedVolcano) #filter for the cell type of interest glut_DE_iso &lt;- dplyr::filter(all_markers_iso_celltype, cluster == &quot;Glutamatergic neurons&quot;) glut_DE_gene &lt;- dplyr::filter(all_markers_gene_celltype, cluster == &quot;Glutamatergic neurons&quot;) #we can plot our volcano plot EnhancedVolcano(glut_DE_gene, lab=glut_DE_gene$gene, x=&#39;avg_log2FC&#39;, y=&#39;p_val_adj&#39;, pCutoff=0.05, FCcutoff=2, boxedLabels = TRUE, drawConnectors = TRUE, selectLab= c(&quot;SLC17A7&quot;,&quot;SLC17A6&quot;,&#39;GRIN1&#39;,&quot;GRIN2B&quot;,&#39;VIM&#39;), title = &quot;Volcano Plot of Differentially Expressed Genes \\n in the Glutamatergic Neurons&quot;) Interestingly our long read data allows us to perform the same analysis but at the isoform level. This can be hard to interpret as there are many more features to plot on the volcano plot. for the sake of clarity we have just labelled TBR1 isoforms. This code below will allow users to plot all the isoforms from a given gene on the Volcano plot making interpretation of the data a bit cleaner. Here we can see two different isoforms of the TBR1 gene showing enrichment in this cell type. Code gene &lt;- &quot;TBR1&quot; plot_features_list &lt;- grep(paste0(&quot;(^|-|\\\\b)&quot;, gene, &quot;($|\\\\b)&quot;), features, value = TRUE) EnhancedVolcano(glut_DE_iso, lab=glut_DE_iso$gene, x=&#39;avg_log2FC&#39;, y=&#39;p_val_adj&#39;, pCutoff=0.05, FCcutoff=2, boxedLabels = TRUE, drawConnectors = TRUE, selectLab= plot_features_list, title = &quot;Volcano Plot of Differentially Expressed Isoforms \\n in the Glutamatergic Neurons&quot;) 5.4.2 FindMarkers DE Finding All Markers is just one type of differential expression (DE) analysis that can be performed. Seurat offers the FindAllMarkers function, which tests the cell type of interest against all other cells. While this approach is often sufficient for identifying marker genes, users may also want to test differences between two specific cell types. For instance, you might want to identify DE genes when comparing glutamatergic neurons to radial glial cells. Below, we demonstrate how to perform this type of analysis with the FindMarkers function. Code DefaultAssay(seu_obj) &lt;- &#39;RNA&#39; # difeine the gne assay as default glu_RG_gene &lt;- FindMarkers(seu_obj, ident.1 = &quot;Glutamatergic neurons&quot;, ident.2 = &quot;Radial glial cells&quot;, logfc.threshold = 0.5, min.pct = 0.02) DefaultAssay(seu_obj) &lt;- &#39;iso&#39; # difeine the gne assay as default glu_RG_iso &lt;- FindMarkers(seu_obj, ident.1 = &quot;Glutamatergic neurons&quot;, ident.2 = &quot;Radial glial cells&quot;, logfc.threshold = 0.5, min.pct = 0.02) #Volcano plots # to plot at gene level #EnhancedVolcano(glu_RG_gene, lab=rownames(glu_RG_gene), # x=&#39;avg_log2FC&#39;, y=&#39;p_val_adj&#39;, # #selectLab= &quot;VIM&quot;, # pCutoff=0.05, FCcutoff=2, # title = &quot;Volcano Plot of Differentially Expressed Gene \\n Glutamatergic Neurons vs Radial glial #Cells&quot;) #Volcano plots EnhancedVolcano(glu_RG_iso, lab=rownames(glu_RG_iso), x=&#39;avg_log2FC&#39;, y=&#39;p_val_adj&#39;, #selectLab= &quot;VIM&quot;, pCutoff=0.05, FCcutoff=2, title = &quot;Volcano Plot of Differentially Expressed Isoforms \\n Glutamatergic Neurons vs Radial glial Cells&quot;) The volcano plot above is a useful tool for visualizing DE isoforms between two cell types. In this plot, red-labeled isoforms on the right-hand side indicate those that are unregulated in glutamatergic neurons compared to RG cells, while red dots on the left represent isoforms that are unregulated in radial glial cells compared to glutamatergic neurons. This analysis serves as an initial overview, and users can further explore the DE list (glu_RG_iso) to select specific isoforms of interest for more detailed analysis. "],["exploring-isoforms-of-interest.html", "Chapter 6 Exploring isoforms of interest 6.1 Isoforms expressed per gene 6.2 Top 10 Genes with Most Isoforms 6.3 Exploring MACF1 isoforms 6.4 Expression of MACF1 isoforms Across Cell Types 6.5 Visualization of Isoform Structures", " Chapter 6 Exploring isoforms of interest One of the most powerful aspects of long-read single-cell sequencing is its ability to profile isoform-specific information at single-cell resolution. This capability opens up numerous avenues for analysis. In our lab we are interested in exploring the role of RNA isoforms in neuronal differentiation and there are many examples in the literature of isoforms regulating this process. We will cover some very general analysis with this focus in mind. 6.1 Isoforms expressed per gene With long-read single-cell data, we have the ability to analyze all the isoforms expressed by a given gene. In our data we can see that most genes express more than one isoform. Code # let&#39;s aggregate the expression data by cell type counts &lt;- AggregateExpression( seu_obj, assays = &quot;iso&quot;, return.seurat = FALSE, group.by = &quot;sctype_db&quot; ) as.data.frame(counts) -&gt; df row.names(df) -&gt; df$gene #split transcript ids into gene and transcript id pseudobulk_data &lt;- df %&gt;% separate(gene, into = c(&quot;transcript_id&quot;, &quot;gene_id&quot;), sep = &quot;-&quot;, extra = &quot;merge&quot;) #df$transcript_id &lt;- sub(&quot;\\\\..*&quot;, &quot;&quot;, df$transcript_id) # 2. Count the number of isoforms per gene isoform_count_per_gene &lt;- pseudobulk_data %&gt;% group_by(gene_id) %&gt;% summarise(n_isoforms = n_distinct(transcript_id)) # 3. count isoforms per category isoform_count_per_gene &lt;- isoform_count_per_gene %&gt;% mutate(isoform_category = case_when( n_isoforms == 1 ~ &quot;1&quot;, n_isoforms &gt;= 2 &amp; n_isoforms &lt;= 3 ~ &quot;2-3&quot;, n_isoforms &gt;= 4 &amp; n_isoforms &lt;= 5 ~ &quot;4-5&quot;, n_isoforms &gt;= 6 ~ &quot;6+&quot; )) # 4. Calculate the percentage of genes in each bin isoform_count_summary &lt;- isoform_count_per_gene %&gt;% dplyr::count(isoform_category) %&gt;% mutate(percent = (n / sum(n)) * 100) ggplot(isoform_count_summary, aes(x = isoform_category, y = percent)) + geom_bar(stat = &quot;identity&quot;, fill = &quot;lightblue&quot;, color = &quot;black&quot;) + labs(title = &quot;Number of Isoforms per Gene&quot;, x = &quot;Isoforms per Gene&quot;, y = &quot;Genes, %&quot;) + theme_minimal() + theme(legend.position = &quot;none&quot;, plot.title = element_text(hjust = 0.5)) 6.2 Top 10 Genes with Most Isoforms We can see that about 45% of genes express a single isoform, however there are some genes like MIR9-1HG that have a lot of unique isoforms, 97 in fact. The top 10 genes with the most isoforms are listed below. Code # Genes ranked by the number of transcript isoforms detected across all samples gene_transcript_counts &lt;- pseudobulk_data %&gt;% group_by(gene_id) %&gt;% summarise(unique_transcripts = n_distinct(transcript_id)) %&gt;% arrange(desc(unique_transcripts)) # Select the top 10 genes based on unique transcript counts top10 &lt;- gene_transcript_counts %&gt;% top_n(10, unique_transcripts) top10 ## # A tibble: 10 × 2 ## gene_id unique_transcripts ## &lt;chr&gt; &lt;int&gt; ## 1 MIR9-1HG 97 ## 2 GAS5 69 ## 3 NUTM2A-AS1 50 ## 4 SNHG1 50 ## 5 FRG1HP 43 ## 6 TMEM161B-DT 43 ## 7 SNHG29 42 ## 8 ENSG00000300022 41 ## 9 FAM66A 39 ## 10 SNHG14 38 We can also plot unique transcripts per gene on a log scale showing that the number of isoforms per gene varies across our data. Code # Plot ranked genes by unique &quot;BambuTx&quot; transcript count ggplot(gene_transcript_counts, aes(x = rank(desc(unique_transcripts)), y = unique_transcripts)) + geom_point(color = &quot;darkblue&quot;, size = 1) + # Points for each gene # Log scale for both axes scale_x_log10() + scale_y_log10() + # Title and labels labs( title = &quot;Unique Transcripts per Gene&quot;, x = &quot;Rank (log scale)&quot;, y = &quot;# Transcripts (log scale)&quot; ) + # Highlight and label the top 10 genes with gray background and black border around the text geom_label_repel( data = gene_transcript_counts %&gt;% filter(gene_id %in% top10$gene_id), aes(label = gene_id), fill = &quot;gray&quot;, # Gray background for the label color = &quot;black&quot;, # Black text color label.size = 0.25, # Border thickness around the label label.r = unit(0.15, &quot;lines&quot;), # Border radius (rounded corners) size = 3, box.padding = 0.2, max.overlaps = 14 ) + # Minimal theme and additional styling theme_minimal() + theme( plot.title = element_text(size = 14, face = &quot;bold&quot;, hjust = 0.5), # Centered title axis.text = element_text(size = 10, color = &quot;black&quot;), # Black axis tick labels axis.title = element_text(color = &quot;black&quot;), # Black axis titles panel.grid.minor = element_blank(), panel.border = element_rect(color = &quot;black&quot;, fill = NA, linewidth = 1) # Black border around the graph ) 6.3 Exploring MACF1 isoforms We are interested in isoforms that regulate neuronal differentiation, we can look at some genes of interest. Let’s look at gene MACF1. The gene seems to play some important role in neural migration which is not fully understood yet. First let’s try and visualize the expression of these isoforms on a UMAP to see if we can uncover anything interesting. MACF1 has 35 expressed isoforms so let’s only plot the top 12 most highly expressed. Code features &lt;- rownames(filt_seurat_object@assays$iso@features) # Define the gene of interest gene &lt;- &quot;MACF1&quot; # Access the data matrix for the &#39;iso&#39; assay expression_matrix &lt;- GetAssayData(filt_seurat_object, assay = &quot;iso&quot;, slot = &quot;data&quot;) # Filter features containing the gene name matching_features &lt;- grep(paste0(&quot;(^|-|\\\\b)&quot;, gene, &quot;($|\\\\b)&quot;), rownames(expression_matrix), value = TRUE) # Subset the expression matrix to include only the matching features subset_expression &lt;- expression_matrix[matching_features, , drop = FALSE] # Calculate the total expression for each matching feature total_expression &lt;- Matrix::rowSums(subset_expression) # Rank features by average expression top_features &lt;- names(sort(total_expression, decreasing = TRUE)) # Print the ranked features (optional) print(data.frame(Feature = top_features, Expression = total_expression[top_features])) ## Feature Expression ## ENST00000361689.7-MACF1 ENST00000361689.7-MACF1 143.862407 ## ENST00000289893.8-MACF1 ENST00000289893.8-MACF1 62.133601 ## ENST00000372925.6-MACF1 ENST00000372925.6-MACF1 45.932634 ## ENST00000372915.8-MACF1 ENST00000372915.8-MACF1 45.461522 ## ENST00000567887.5-MACF1 ENST00000567887.5-MACF1 45.092944 ## ENST00000686657.1-MACF1 ENST00000686657.1-MACF1 44.609476 ## ENST00000564288.6-MACF1 ENST00000564288.6-MACF1 40.689721 ## ENST00000524432.5-MACF1 ENST00000524432.5-MACF1 27.310250 ## ENST00000686687.1-MACF1 ENST00000686687.1-MACF1 19.939477 ## ENST00000497964.1-MACF1 ENST00000497964.1-MACF1 17.945311 ## ENST00000530275.3-MACF1 ENST00000530275.3-MACF1 16.728830 ## ENST00000691623.1-MACF1 ENST00000691623.1-MACF1 14.286232 ## ENST00000602528.2-MACF1 ENST00000602528.2-MACF1 13.942571 ## ENST00000687271.1-MACF1 ENST00000687271.1-MACF1 12.934634 ## ENST00000476350.1-MACF1 ENST00000476350.1-MACF1 12.210176 ## ENST00000496804.5-MACF1 ENST00000496804.5-MACF1 12.181141 ## ENST00000686067.1-MACF1 ENST00000686067.1-MACF1 10.238947 ## ENST00000690080.1-MACF1 ENST00000690080.1-MACF1 8.279051 ## ENST00000497807.1-MACF1 ENST00000497807.1-MACF1 8.021857 ## ENST00000693209.1-MACF1 ENST00000693209.1-MACF1 7.429056 ## ENST00000693392.1-MACF1 ENST00000693392.1-MACF1 7.317640 ## ENST00000472385.2-MACF1 ENST00000472385.2-MACF1 7.075353 ## ENST00000602421.5-MACF1 ENST00000602421.5-MACF1 6.698620 ## ENST00000686260.1-MACF1 ENST00000686260.1-MACF1 6.297806 ## ENST00000688426.1-MACF1 ENST00000688426.1-MACF1 6.232290 ## ENST00000687997.1-MACF1 ENST00000687997.1-MACF1 6.056226 ## ENST00000690939.1-MACF1 ENST00000690939.1-MACF1 5.445340 ## ENST00000683517.1-MACF1 ENST00000683517.1-MACF1 3.526815 ## ENST00000442046.5-MACF1 ENST00000442046.5-MACF1 3.018726 ## ENST00000689911.1-MACF1 ENST00000689911.1-MACF1 2.657853 ## ENST00000484793.5-MACF1 ENST00000484793.5-MACF1 2.181164 ## ENST00000467673.5-MACF1 ENST00000467673.5-MACF1 2.131094 ## ENST00000686941.1-MACF1 ENST00000686941.1-MACF1 1.058887 ## ENST00000672812.1-MACF1 ENST00000672812.1-MACF1 1.055652 ## ENST00000528611.1-MACF1 ENST00000528611.1-MACF1 0.401423 Code options(repr.plot.width=12, repr.plot.height=12) # Plot the top 16 features in descending order of their average expression plots &lt;- FeaturePlot( filt_seurat_object, features = head(top_features, 12), reduction = &quot;umap&quot;, order = TRUE, # Ensures higher-expressing cells are plotted on top pt.size = 1) # Adjust title size for each plot plots &lt;- lapply(plots, function(plot) { plot + theme(plot.title = element_text(size = 8)) }) # Combine the adjusted plots CombinePlots(plots = plots, ncol = 3) 6.4 Expression of MACF1 isoforms Across Cell Types Let’s look at isoforms ENST00000564288.6, ENST00000361689.7, ENST00000289893.8 and ENST00000524432.5 in some more detail and plot the normalized expression of these isoforms across each cell type. We can see that the expression of ENST00000524432.5 shows a cell type specific profile. Code features_MACF1 &lt;- c(&quot;ENST00000564288.6-MACF1&quot;, # canonical &quot;ENST00000361689.7-MACF1&quot;, # most cell types &quot;ENST00000289893.8-MACF1&quot;, # most cell types &quot;ENST00000524432.5-MACF1&quot;) # radial glia VlnPlot(seu_obj, features = features_MACF1, ncol = 2) We can also show this enrichment with a dotplot. Code dittoDotPlot(seu_obj, vars = features_MACF1, group.by = &quot;sctype_db&quot;, scale = FALSE) let’s look at our DE results comparing glutamatergic neurons and Radial glia cells that we calculated in the previous chapter and filter for significant MACF1 isoforms. If we plot these features on a Volcano plot we see isoform ENST00000524432.5 is enriched in radial glia cells. In fact its enrichment compared to glutamatergic neurons is pretty high with a Log2fold change of 4.16. Code glu_RG_iso %&gt;% rownames_to_column(&quot;isoform&quot;) %&gt;% filter(grepl(&quot;MACF1&quot;, isoform)) %&gt;% filter(p_val_adj &lt; 0.5) ## isoform p_val avg_log2FC pct.1 pct.2 p_val_adj ## 1 ENST00000524432.5-MACF1 1.025842e-10 -4.163237 0.011 0.384 6.539231e-06 Code EnhancedVolcano(glu_RG_iso, lab=rownames(glu_RG_iso), x=&#39;avg_log2FC&#39;, y=&#39;p_val_adj&#39;, #selectLab= &quot;VIM&quot;, pCutoff=0.05, FCcutoff=2, selectLab = &quot;ENST00000524432.5-MACF1&quot;, boxedLabels = TRUE, drawConnectors = TRUE, title = &quot;ENST00000524432.5-MACF1 is upregulated \\n in Radial glial Cells compared to Glutamatergic Neurons&quot;) 6.5 Visualization of Isoform Structures Now that we know some MACF1 isoforms expression is significantly different in these two cell populations it may be of interest to visualize the isoform structures. This analysis will help us explore the similarities and differences between our isoforms of interest. There are many visualization options available to us and many of these are available in R. In fact FLAMES has its own visualization function FLAMES::plot_isoform_reduced_dim. This function is designed to work on single cell experiment object and not Seurat object. Although it is possible to switch between these formats, for the purpose of this tutorial we want to keep file conversations to a minimum to keep the analysis simple. We instead recommend using IsoVis (Wan et al., 2024), which was developed in the Clark Lab. The tool is a web application specifically designed for visualizing isoform structures. This visualization can provide valuable insights into the potential functions of different isoforms. First let’s prepare the count data that we will load into Isovis1 Code #extract some isoform expression data to visualize in IsoVis #use pseudobulk counts we got from above pseudobulk_data -&gt; pseudobulk_data_IsoVis_format row.names(pseudobulk_data_IsoVis_format) &lt;- NULL write.csv(pseudobulk_data_IsoVis_format, &quot;output_files/Pseudobulk_exp.csv&quot;, row.names = FALSE) To use IsoVis click on the following link https://isomix.org/isovis/ and upload the isoform_annotated.gtf file located in the FLAMES output dir and Pseudobulk_exp.csv generated above. For more detail on how to use IsoVis click the ‘IsoVis tutorial’ button or read the publication. Embedded below is the figure generated by IsoVis2. Here we we will visualise our 4 isoforms of interest. We can see MACF1 is a very complex gene with many exons, a variety of alternative transcription start sites. Structural visualization aids in identifying critical variations such as alternative splicing events, unique protein-coding regions, and functional domains. Code knitr::include_graphics(&quot;images/IsoVis_ENSG00000127603.png&quot;) Figure 6.1: IsoVis visualization of 4 MACF1 isoforms. Our pseudobulk expression data clearly demonstrates that ENST00000524432.5 is predominantly expressed in radial glia cells. This isoform is particularly interesting, as it is significantly shorter than others and lacks many of the protein domains present in ENST00000564288.6 (the canonical isoform). Notably, all four isoforms exhibit different transcription start sites (TSS), suggesting that TSS variation may be linked to cell-type-specific expression or distinct proteaforms For example, ENST00000289893.8 shows comparably high expression levels across most cell types. However, a deeper exploration of this isoform reveals that it does not produce a functional protein. This is evident from examining the Ensembl data, accessible via the isoform hyperlink, where we can see that no open reading frames (ORFs) are associated with this transcript. There are lots of additional analysis that could be performed to further explore the function of our MACF1 isoforms, these include domain enrichment analysis and protein folding to name a few. Please be careful when interpreting pseudubulk expression data. Although the data can give you some indication of relative expression across cell types, this numbers can be affected by the number of cells in each cluster.↩︎ When Viewing this data in the web browser users will have more functionality. This includes a zoom function, looking at protein domains and rearranging isoform tracks and known visualizing open reading frames.↩︎ "],["isoform-classification.html", "Chapter 7 Isoform Classification 7.1 Classification with SQANTI 7.2 Cell type specific isoforms", " Chapter 7 Isoform Classification 7.1 Classification with SQANTI In the previous Chapter we looked at some genes of interest like MCAF1 and some of the isoforms related to this gene. As you can see MCAF1 is a highly complex gene with many exons, varied Transcription start sites and many splice junctions. Evaluating this information manually for each isoform is complex and time consuming. A tool that that is very useful here is SQANTI3 (Pardo-Palacios et al., 2024) which will categorize our isoforms3 and determine whether they are coding or non-coding. If you install SQANTI3 and run the following command in your FLAMES output folder you will generate a classifications.txt file. This output file is located in the data folder on the github page. SQANTI can also generate an HTML report with lots of figures summarizing your isoforms which can be very helpful. We will do something similar but instead plot this information stratified by cell type. Code GTF=&quot;gencode.v47.annotation.gtf&quot; genome=&quot;genome.fa&quot; #filter gtf file to remove annotation of unknown strands awk &#39;$7 == &quot;+&quot; || $7 == &quot;-&quot;&#39; isoform_annotated.gtf &gt; remove_unknownstrand.gtf #run SQANTIpython3 #you may need need to activate a conda environment SQANTI3-5.2.1/sqanti3_qc.py remove_unknownstrand.gtf ${GTF} ${genome} If we examine the classifications file, we can see that each isoform in our GTF file has been categorized based on its structural characteristics, coding potential, and additional attributes. Code SQANTI &lt;- read.csv(&quot;data/remove_unknownstrand_classification.txt&quot;, sep =&#39;\\t&#39;) #SQANTI$isoform &lt;- sub(&quot;\\\\..*&quot;, &quot;&quot;, SQANTI$isoform) # remove numbers after . head(SQANTI, 3) ## isoform chrom strand length exons structural_category associated_gene associated_transcript ref_length ## 1 BambuTx1 chr1 + 2381 3 novel_in_catalog ENSG00000294260.1 novel 1694 ## 2 BambuTx2 chr1 - 595 2 antisense novelGene_ENSG00000302070.1_AS novel NA ## 3 ENST00000003583.12 chr1 - 2544 8 full-splice_match ENSG00000001460.18 ENST00000003583.12 2544 ## ref_exons diff_to_TSS diff_to_TTS diff_to_gene_TSS diff_to_gene_TTS subcategory RTS_stage all_canonical ## 1 2 NA NA -2481 -17 combination_of_known_splicesites FALSE canonical ## 2 NA NA NA NA NA multi-exon FALSE canonical ## 3 8 0 0 0 0 reference_match FALSE canonical ## min_sample_cov min_cov min_cov_pos sd_cov FL n_indels n_indels_junc bite iso_exp gene_exp ratio_exp FSM_class coding ## 1 NA NA NA NA NA NA NA FALSE NA NA NA C non_coding ## 2 NA NA NA NA NA NA NA FALSE NA NA NA A non_coding ## 3 NA NA NA NA NA NA NA FALSE NA NA NA C coding ## ORF_length CDS_length CDS_start CDS_end CDS_genomic_start CDS_genomic_end predicted_NMD perc_A_downstream_TTS seq_A_downstream_TTS ## 1 NA NA NA NA NA NA NA 75 TAAAAAAAAAAAATAAGTGA ## 2 NA NA NA NA NA NA NA 95 AAAAAAAAAAAAAAGAAAAA ## 3 122 369 1009 1377 24358540 24358172 FALSE 15 TATTGAGCTTTTGGGTACCC ## dist_to_CAGE_peak within_CAGE_peak dist_to_polyA_site within_polyA_site polyA_motif polyA_dist polyA_motif_found ## 1 NA NA NA NA NA NA NA ## 2 NA NA NA NA NA NA NA ## 3 NA NA NA NA NA NA NA ## ORF_seq ## 1 &lt;NA&gt; ## 2 &lt;NA&gt; ## 3 MSHKVKENSSHQPTLPSVPRTFLRRRPIMSVAADNLGGGSTTLAWHPSRTAAIAFVLSWRHCSLETSPQPHRLQWLPEQKGGVDRAPWLLPHAPIQAAFRHDSLPQTEGTPEAQTSRRISPP ## ratio_TSS ## 1 NA ## 2 NA ## 3 NA There is a lots information one can extract from the classifications.txt file. to get a more complete picture of the isoforms in the sample Lets plot some of this information. Code #we can use the pseudobulk_data counts calculated previously # Select cell type columns and gather into long format long_data &lt;- pseudobulk_data %&gt;% pivot_longer( cols = starts_with(&quot;iso.&quot;), names_to = &quot;cell_type&quot;, values_to = &quot;expression&quot; ) # Filter for non-zero expression to identify genes and isoforms expressed in each cell type filtered_data &lt;- long_data %&gt;% filter(expression &gt; 0) %&gt;% dplyr::select(cell_type, transcript_id, gene_id) %&gt;% distinct() # Calculate unique gene and isoform counts for each cell type cell_type_summary &lt;- filtered_data %&gt;% group_by(cell_type) %&gt;% summarise( num_genes = n_distinct(gene_id), num_isoforms = n_distinct(transcript_id) ) %&gt;% pivot_longer(cols = c(num_genes, num_isoforms), names_to = &quot;Category&quot;, values_to = &quot;Count&quot;) # Plot the data p1 &lt;- ggplot(cell_type_summary, aes(x = cell_type, y = Count, fill = Category)) + geom_bar(stat = &quot;identity&quot;, position = &quot;dodge&quot;, color = &quot;black&quot;, width = 0.8) + theme_minimal() + labs(title = &quot;Number of genes and isoforms \\n per cell type&quot;, x = &quot;Cell Type&quot;, y = &quot;Count&quot;) + theme( plot.title = element_text(size = 20, face = &quot;bold&quot;, hjust = 0.5), axis.title.x = element_text(size = 14), axis.title.y = element_text(size = 14), axis.text.x = element_text(size = 12, angle = 45, hjust = 1), axis.text.y = element_text(size = 12), legend.title = element_blank() ) # plot the structural category per cell type merged_data &lt;- merge(pseudobulk_data, SQANTI, by.x = &quot;transcript_id&quot;, by.y = &quot;isoform&quot;, all.x = TRUE) # Pivot pseudobulk data to long format for cell types long_data &lt;- merged_data %&gt;% pivot_longer( cols = starts_with(&quot;iso.&quot;), names_to = &quot;cell_type&quot;, values_to = &quot;expression&quot; ) # Generate outr new df thatw e can use for plotting attributes deffiend by cell type filtered_data &lt;- long_data %&gt;% filter(expression &gt; 0) %&gt;% distinct() # Calculate unique counts of genes and isoforms per structural category and cell type category_summary &lt;- filtered_data %&gt;% group_by(cell_type, structural_category, subcategory, coding) %&gt;% summarise( num_genes = n_distinct(gene_id), num_isoforms = n_distinct(transcript_id), .groups = &quot;drop&quot; ) # Plot number of isoforms per structural category for each cell type p2 &lt;- ggplot(category_summary, aes(x = cell_type, y = num_isoforms, fill = structural_category)) + geom_bar(stat = &quot;identity&quot;, position = &quot;stack&quot;, width = 0.8) + theme_minimal() + labs( title = &quot;Isoforms by structural category \\n across cell types&quot;, x = &quot;Cell Type&quot;, y = &quot;Number of Isoforms&quot;, fill = &quot;Structural Category&quot; ) + theme( plot.title = element_text(size = 20, face = &quot;bold&quot;, hjust = 0.5), axis.title.x = element_text(size = 14), axis.title.y = element_text(size = 14), axis.text.x = element_text(size = 12, angle = 45, hjust = 1), axis.text.y = element_text(size = 12), legend.title = element_text(size = 14), legend.text = element_text(size = 12) ) p3 &lt;- ggplot(category_summary, aes(x = cell_type, y = num_isoforms, fill = subcategory)) + geom_bar(stat = &quot;identity&quot;, position = &quot;stack&quot;, width = 0.8) + theme_minimal() + labs( title = &quot;Isoforms by structural subcategory \\n across cell types&quot;, x = &quot;Cell Type&quot;, y = &quot;Number of Isoforms&quot;, fill = &quot;subcategory&quot; ) + theme( plot.title = element_text(size = 20, face = &quot;bold&quot;, hjust = 0.5), axis.title.x = element_text(size = 14), axis.title.y = element_text(size = 14), axis.text.x = element_text(size = 12, angle = 45, hjust = 1), axis.text.y = element_text(size = 12), legend.title = element_text(size = 14), legend.text = element_text(size = 12) ) p4 &lt;- ggplot(category_summary, aes(x = cell_type, y = num_isoforms, fill = coding)) + geom_bar(stat = &quot;identity&quot;, position = &quot;fill&quot;, width = 0.8) + theme_minimal() + labs( title = &quot;Proportion of coding isoforms \\n across cell types&quot;, x = &quot;Cell Type&quot;, y = &quot;Proportion of Isoforms&quot;, fill = &quot;Structural Category&quot; ) + scale_y_continuous(labels = scales::percent) + # This will show y-axis as percentages theme( plot.title = element_text(size = 20, face = &quot;bold&quot;, hjust = 0.5), axis.title.x = element_text(size = 14), axis.title.y = element_text(size = 14), axis.text.x = element_text(size = 12, angle = 45, hjust = 1), axis.text.y = element_text(size = 12), legend.title = element_text(size = 14), legend.text = element_text(size = 12) ) #Plots cowplot::plot_grid(p1, p2, p3, p4, ncol = 2) 7.2 Cell type specific isoforms We can also look at isoforms that are unique to each Cell type. We define unique as an isoforms that has 5 or more counts in one cell type and ≤ 1 count in all other cell types. Users can adjust the thresholds mentioned below4. Code # Filter the data based on the expression cutoff # Set expression cutoff threshold expression_cutoff &lt;- 5 max_expression_in_all_other_cells_types = 1 # Filter isoforms based on the new criteria exclusive_isoforms &lt;- long_data %&gt;% group_by(transcript_id) %&gt;% filter( # Only one cell type where expression &gt; cutoff sum(expression &gt; expression_cutoff) &lt;= 1, # Ensure all other cell types have 0 expression all(expression &lt; max_expression_in_all_other_cells_types | expression &gt; expression_cutoff) ) %&gt;% ungroup() # Count the unique isoforms per cell type # Adjust counting logic exclusive_isoforms_count &lt;- exclusive_isoforms %&gt;% group_by(cell_type) %&gt;% summarise( unique_isoforms = sum(expression &gt; expression_cutoff) # Count only isoforms with valid expression ) %&gt;% ungroup() # Plot the results ggplot(exclusive_isoforms_count, aes(x = cell_type, y = unique_isoforms, fill = cell_type)) + geom_bar(stat = &quot;identity&quot;, color = &quot;black&quot;, width = 0.8) + theme_minimal() + labs( title = &quot;Number of isoforms unique \\n to each cell type&quot;, x = &quot;Cell Type&quot;, y = &quot;Number of Unique Isoforms&quot; ) + theme( plot.title = element_text(size = 20, face = &quot;bold&quot;, hjust = 0.5), axis.title.x = element_text(size = 14), axis.title.y = element_text(size = 14), axis.text.x = element_text(size = 12, angle = 45, hjust = 1), axis.text.y = element_text(size = 12), legend.title = element_blank() ) These cell type specific isoforms may be particularly interesting to study further, as they likely play important roles in differentiation and cell function. We could extract these isoforms for further analysis. Lets use another helpful resource to explore these cell type specific isoforms. We can use the BioMart (Smedley et al., 2009) package to get some more metadata about each isoform. There is lots of data that can be extracted from BioMart. This is just a simple example of what can be done with this cell type specif data. Code library(&quot;biomaRt&quot;) exclusive_isoforms_uniq &lt;- exclusive_isoforms %&gt;% filter(expression &gt;= max_expression_in_all_other_cells_types) %&gt;% arrange(desc(expression)) exclusive_isoforms_uniq$transcript_id &lt;- sub(&quot;\\\\..*&quot;, &quot;&quot;, exclusive_isoforms_uniq$transcript_id) # Retrieve gene biotype from Ensembl mart &lt;- useMart(biomart = &quot;ensembl&quot;, dataset = &quot;hsapiens_gene_ensembl&quot;) biotype_info_transcript &lt;- getBM(attributes = c(&quot;ensembl_transcript_id&quot;, &quot;transcript_is_canonical&quot;, &#39;transcript_biotype&#39;, &#39;transcript_length&#39;), filters = &#39;ensembl_transcript_id&#39;, values = exclusive_isoforms_uniq$transcript_id, mart = mart) #merge excluive isoforms and biomart data togehter merged_biomart_data &lt;- merge(exclusive_isoforms_uniq, biotype_info_transcript, by.x = &quot;transcript_id&quot;, by.y = &quot;ensembl_transcript_id&quot;, all.x = TRUE) # Prepare the summary data category_summary &lt;- merged_biomart_data %&gt;% group_by(cell_type, transcript_biotype) %&gt;% summarise(num_isoforms = n(), .groups = &quot;drop&quot;) %&gt;% group_by(cell_type) %&gt;% mutate(proportion = num_isoforms / sum(num_isoforms)) %&gt;% ungroup() # Ensure consistent factor order for cell_type and transcript_biotype # Ensure consistent factor order for cell_type and transcript_biotype category_summary &lt;- category_summary %&gt;% mutate( cell_type = factor(cell_type, levels = unique(cell_type)), transcript_biotype = factor(transcript_biotype, levels = c( &quot;protein_coding&quot;, &quot;lncRNA&quot;, &quot;non_stop_decay&quot;, &quot;TEC&quot;, &quot;nonsense_mediated_decay&quot;, &quot;protein_coding_CDS_not_defined&quot;, &quot;retained_intron&quot;, &quot;processed_pseudogene&quot;, &quot;snoRNA&quot;, &quot;transcribed_processed_pseudogene&quot; )) ) # Create the plot p5 &lt;- ggplot(category_summary, aes(x = cell_type, y = proportion, fill = transcript_biotype)) + geom_bar(stat = &quot;identity&quot;, position = &quot;fill&quot;, width = 0.8) + geom_text(aes(label = scales::percent(proportion, accuracy = 0.1)), position = position_fill(vjust = 0.5), size = 2) + theme_minimal() + labs( title = &quot;BioMart Structural Categories \\n cell specific isoforms&quot;, x = &quot;Cell Type&quot;, y = &quot;Proportion of Isoforms&quot;, fill = &quot;BioMart structual Category&quot; ) + scale_y_continuous(labels = scales::percent) + theme( plot.title = element_text(size = 18, face = &quot;bold&quot;, hjust = 0.5), axis.title.x = element_text(size = 12), axis.title.y = element_text(size = 12), axis.text.x = element_text(size = 12, angle = 45, hjust = 1), axis.text.y = element_text(size = 12), legend.title = element_text(size = 10), legend.text = element_text(size = 6) ) p6 &lt;- ggplot(merged_biomart_data, aes(x = cell_type, y = transcript_length, fill = cell_type)) + geom_violin(trim = TRUE, alpha = 0.6) + # Use violin plot for distribution geom_boxplot(width = 0.1, outlier.size = 0.5, alpha = 0.8) + # Add boxplot for summary statistics theme_minimal() + labs( title = &quot;Transcript length distribution \\n across cell types&quot;, x = &quot;Cell Type&quot;, y = &quot;Transcript Length (nt)&quot;, fill = &quot;Cell Type&quot; ) + theme( plot.title = element_text(size = 18, face = &quot;bold&quot;, hjust = 0.5), axis.title.x = element_text(size = 10), axis.title.y = element_text(size = 10), axis.text.x = element_text(size = 12, angle = 45, hjust = 1), axis.text.y = element_text(size = 12), legend.position = &quot;none&quot; ) cowplot::plot_grid(p5, p6, ncol = 1) For more detail about the classification system see the SQANTI publication.↩︎ It is essential to keep in mind that cell type classification, sequencing depth, and the number of cells in each cluster can significantly impact the results, especially in cases where isoforms are expressed at very low levels.↩︎ "],["novel-isoforms.html", "Chapter 8 Novel isoforms 8.1 Find all the genes that express at least 1 novel isoform 8.2 Visualising OAZ2 novel isoform 8.3 Functional impacts of novel isoforms", " Chapter 8 Novel isoforms With long read sequencing it’s possible to explore both known and novel isoforms. Novel isoforms can be interesting feature to explore and here we will provide some simple analysis that one can use to extract novel isoforms and explore them in some more detail. Although the bar plots above show that the vast majority of isoforms are full-splice-matches i.e they match the reference GTF there are a few we could extract. 8.1 Find all the genes that express at least 1 novel isoform First let’s get a list of genes with at least one novel isoform Code # Find the genes that express at least one novel isoform and save them to a list # Convert row names to a data frame isoform_ids &lt;- as.data.frame(row.names(seu_obj@assays$iso$counts)) colnames(isoform_ids) &lt;- &quot;IDs&quot; #Add in total expression isoform_ids$Total_Expression &lt;- rowSums(seu_obj@assays$iso$counts) # Filter rows where &#39;IDs&#39; contains the string &quot;Bambu&quot; isoform_ids &lt;- as.data.frame(isoform_ids[grepl(&quot;Bambu&quot;, isoform_ids$IDs), ]) # can comment this out if we want to do this for all isoforms # Separate the &#39;IDs&#39; column into two columns filtered_df &lt;- isoform_ids %&gt;% separate(IDs, into = c(&quot;transcript_id&quot;, &quot;gene_id&quot;), sep = &quot;-&quot;, extra = &quot;merge&quot;) isoform_counts &lt;- filtered_df %&gt;% group_by(gene_id) %&gt;% summarise( Isoform_Count = n(), Total_Expression = sum(Total_Expression) ) %&gt;% arrange(desc(Total_Expression)) # Print or return the filtered data frame print(isoform_counts) ## # A tibble: 31 × 3 ## gene_id Isoform_Count Total_Expression ## &lt;chr&gt; &lt;int&gt; &lt;dbl&gt; ## 1 OAZ2 1 383. ## 2 ENSG00000291214 1 158. ## 3 BambuGene6113 1 140. ## 4 BambuGene19505 1 138. ## 5 ENSG00000305512 1 136. ## 6 ENSG00000305069 1 125 ## 7 BambuGene18812 1 94.8 ## 8 ZMAT5 1 70.5 ## 9 ENSG00000295459 1 68.7 ## 10 ENSG00000231748 1 62 ## # ℹ 21 more rows In this table we can see that we have a total of 31 novel isoforms. This number is smaller than we might expect but this is because Bambu (Chen et al., 2023) is quite conservative for single cell data and we haven’t sequenced these data very deeply. Users can change the sensitivity of Bambu when running FLAMES by setting the NDR parameter or using a different discovery method like stringtie2 (Kovaka et al., 2019). In the above table we have ordered the genes that contain a novel isoform by total expression. OAZ2 is our top hit. We can look at the isoform structure using IsoVis as described in the section 6.5. Code knitr::include_graphics(&quot;images/IsoVis_ENSG00000180304.png&quot;) Figure 8.1: IsoVis visualisation of Novel OAZ2 isoform. 8.2 Visualising OAZ2 novel isoform visualising OAZ2 reveals that the primary distinction between the novel isoform and the canonical isoform, OAZ2-201 seems to be a shorter 5’ UTR. This minor alteration at face value should not affect the canonical open reading frame (ORF). However, according to SQANTI, BambuTx25 is classified as a novel_in_catalog isoform, meaning it is an isoform not present in the reference GTF and SQANTI suggests that BambuTx25 is non-coding, which is quite surprising! Interestingly, SQANTI also indicates that the primary difference between BambuTx25 and the canonical isoforms lies in intron retention (Specified in the subcategory column). Code # Load necessary libraries SQANTI[grep(&#39;BambuTx25&#39;, SQANTI$isoform), ] ## isoform chrom strand length exons structural_category associated_gene associated_transcript ref_length ref_exons ## 21835 BambuTx25 chr15 - 1870 5 novel_in_catalog ENSG00000180304.14 novel 1934 6 ## diff_to_TSS diff_to_TTS diff_to_gene_TSS diff_to_gene_TTS subcategory RTS_stage all_canonical min_sample_cov min_cov ## 21835 NA NA -2 -1 intron_retention FALSE canonical NA NA ## min_cov_pos sd_cov FL n_indels n_indels_junc bite iso_exp gene_exp ratio_exp FSM_class coding ORF_length CDS_length ## 21835 NA NA NA NA NA FALSE NA NA NA C non_coding NA NA ## CDS_start CDS_end CDS_genomic_start CDS_genomic_end predicted_NMD perc_A_downstream_TTS seq_A_downstream_TTS dist_to_CAGE_peak ## 21835 NA NA NA NA NA 10 GTGGTTGGTCTATTCTTTAT NA ## within_CAGE_peak dist_to_polyA_site within_polyA_site polyA_motif polyA_dist polyA_motif_found ORF_seq ratio_TSS ## 21835 NA NA NA NA NA NA &lt;NA&gt; NA To better understand these SQANTI results let’s zoom in on exon 2 of OAZ2. Here, we observe a small break within the exon. The novel BambuTx25 does not contain this break so perhaps this change affects the resulting amino acid sequence. Code knitr::include_graphics(&quot;images/IsoVis_ENSG00000180304_zoom.png&quot;) Figure 8.2: IsoVis visualisation of exon 2 of OAZ2. 8.3 Functional impacts of novel isoforms There are many ways to investigate the translated sequence and compare the protein generated from canonical isoform and the novel one. Simple approaches may involve extracting the fasta sequence and looking for the open reading frames (ORFs) in an online tool like ‘expasy translate’ which can be found here https://web.expasy.org/translate/. Below we have written a function that will take a list of isoforms from a gene and plot the ORFs as defined by the package ORFik5 (Tjeldnes et al., 2021). We will visualise these ORFs in Gviz (Hahne &amp; Ivanek, 2016) an R package for visualising genomic features. This analysis will help us determine if the ORF in the transcript BambuTx25 has been impacted by the change in nucleotide sequence. Code # Global cache for TxDb txdb_cache &lt;- list() get_txdb &lt;- function(reference_gtf) { # Check if the TxDb for this file is already in cache if (!is.null(txdb_cache[[reference_gtf]])) { message(&quot;Using cached TxDb...&quot;) return(txdb_cache[[reference_gtf]]) } # Create TxDb and cache it message(&quot;Creating TxDb object from reference GTF. This may take time...&quot;) txdb &lt;- txdbmaker::makeTxDbFromGFF(reference_gtf) txdb_cache[[reference_gtf]] &lt;&lt;- txdb return(txdb) } plot_isoform_ORFs &lt;- function(reference_gtf, target_gtf, isoforms_of_interest, chromosome, plot_start, plot_end) { # Load genome reference genomedb &lt;- BSgenome.Hsapiens.UCSC.hg38 # Retrieve cached TxDb or create if not available txdb &lt;- get_txdb(reference_gtf) # Import and filter GTF for specific isoforms gtf_data &lt;- import(target_gtf) gtf_filtered &lt;- gtf_data[gtf_data$transcript_id %in% isoforms_of_interest] txdb_filtered &lt;- txdbmaker::makeTxDbFromGRanges(gtf_filtered) # Extract exons and convert to GRangesList txs &lt;- GenomicFeatures::exonsBy(txdb_filtered, by = c(&quot;tx&quot;, &quot;gene&quot;), use.names = TRUE) txs_grl &lt;- GRangesList(txs) # Extract transcript sequences and identify ORFs tx_seqs &lt;- extractTranscriptSeqs(genomedb, txs_grl) ORFs &lt;- findMapORFs(txs_grl, tx_seqs, groupByTx = FALSE, longestORF = FALSE, minimumLength = 30, startCodon = &quot;ATG&quot;, stopCodon = stopDefinition(1)) # Unlist and prepare ORF data for plotting ORFs_unlisted &lt;- unlist(ORFs) ORFs_unlisted$type &lt;- &quot;exon&quot; ORFs_unlisted$transcript &lt;- ORFs_unlisted$names ORFs_unlisted$transcript &lt;- paste0(ORFs_unlisted$transcript, &quot;_ORF&quot;) #could add in a filter for ORFs here # Define start and stop codons starts &lt;- startCodons(ORFs, is.sorted = TRUE) stops &lt;- stopCodons(ORFs, is.sorted = TRUE) # Visualisation Tracks gtrack &lt;- GenomeAxisTrack() itrack &lt;- IdeogramTrack(genome = &quot;hg38&quot;, chromosome = chromosome) ref_track &lt;- GeneRegionTrack( range = txdb, name = &quot;gencodev47&quot;, genome = &quot;hg38&quot;, chromosome = chromosome, col = &quot;darkblue&quot;, fill = &quot;lightblue&quot;, arrowHead = FALSE ) input_track &lt;- GeneRegionTrack( range = txdb_filtered, name = &quot;Isoforms (Exons)&quot;, genome = &quot;hg38&quot;, chromosome = chromosome, col = &quot;darkgreen&quot;, fill = &quot;lightgreen&quot;, arrowHead = FALSE ) orf_track &lt;- GeneRegionTrack( ORFs_unlisted, genome = &quot;hg38&quot;, chromosome = unique(seqnames(ORFs_unlisted)), transcriptAnnotation = &quot;transcript&quot;, name = &quot;ORFs&quot;, col = &quot;grey&quot;, fill = &quot;grey&quot;, stacking = &quot;squish&quot;, ) starts_track &lt;- AnnotationTrack( range = starts, name = &quot;Starts&quot;, genome = &quot;hg38&quot;, chromosome = seqnames(txs_grl[[1]])[1], col = &quot;green&quot;, fill = &quot;green&quot;, shape = &quot;box&quot;, # Ensure no arrows by using box shape stacking = &quot;dense&quot; ) stops_track &lt;- AnnotationTrack( range = stops, name = &quot;Stops&quot;, genome = &quot;hg38&quot;, chromosome = seqnames(txs_grl[[1]])[1], col = &quot;red&quot;, fill = &quot;red&quot;, shape = &quot;box&quot;, # Ensure no arrows by using box shape stacking = &quot;dense&quot; ) # Plot tracks plotTracks(list(itrack, gtrack, ref_track, input_track, orf_track, stops_track, starts_track), from = plot_start, to = plot_end, transcriptAnnotation = &quot;transcript&quot;) } # Example usage plot_isoform_ORFs( reference_gtf = &quot;data/gencode.v47.annotation.gtf&quot;, target_gtf = &quot;data/FLAMES_out/isoform_annotated_unfiltered.gtf&quot;, isoforms_of_interest = c(&quot;ENST00000326005.10&quot;, &quot;BambuTx25&quot;), chromosome = &quot;chr15&quot;, plot_start = 64687015, plot_end = 64703412 ) Code plot_isoform_ORFs( reference_gtf = &quot;data/gencode.v47.annotation.gtf&quot;, target_gtf = &quot;data/FLAMES_out/isoform_annotated_unfiltered.gtf&quot;, isoforms_of_interest = c(&quot;ENST00000326005.10&quot;, &quot;BambuTx25&quot;), chromosome = &quot;chr15&quot;, plot_start = 64691416, plot_end = 64691685 ) visualising ORFs using the above code chunk shows that the BambuTx25_1_ORF is incomplete. The additional sequence (retained intron as specified by SQANTI) results in a premature stop codon shown in red which likely triggers nonsense-mediated decay (NMD). The canonical ENST00000326005.10_3_ORF is complete. We can examine additional genes from our list. For instance, ZMAT5 has a novel isoform that utilizes a different, known splice junction in the 5’ UTR. Using the function above to examine ORFs, we can see that the ORF is unchanged compared to the canonical isoform. This may suggest some important regulatory role in the 5’ UTR yet the protein remains unchanged. Code knitr::include_graphics(&quot;images/IsoVis_ENSG00000100319.png&quot;) Figure 8.3: IsoVis visualisation of Novel ZMAT5 isoform. Code plot_isoform_ORFs( reference_gtf = &quot;../../../../resources/gencode.v47.annotation.gtf&quot;, target_gtf = &quot;/data/scratch/users/yairp/FLAMES_Day55/outs/isoform_annotated_unfiltered.gtf&quot;, isoforms_of_interest = c(&quot;BambuTx32&quot;, &quot;ENST00000344318.4&quot;), chromosome = &quot;chr22&quot;, plot_start = 29728956, plot_end = 29769011 ) ## Creating TxDb object from reference GTF. This may take time... ## Import genomic features from the file as a GRanges object ... OK ## Prepare the &#39;metadata&#39; data frame ... OK ## Make the TxDb object ... OK ORFs found by the package ORFik may need to be filtered based on length or position when analysing different genes or isoforms.↩︎ "],["profiling-isoform-diversity.html", "Chapter 9 Profiling Isoform Diversity 9.1 Measuring entropy with find_diversity() function 9.2 Example of a low entropy gene 9.3 Example of a high entropy gene 9.4 Broadening Entropy Analysis", " Chapter 9 Profiling Isoform Diversity While traditional analyses—such as differential gene expression (DGE), differential isoform expression (DIE), or pseudotime trajectory inference—reveal important biological patterns, long-read single-cell data allow us to ask a different kind of question: How is a gene’s expression distributed across its isoforms? This concept is what we refer to as isoform diversity. Rather than simply asking “Is isoform X upregulated in cluster A?”, we can instead explore: Does a single cell rely on one dominant isoform for a given gene? Or does it distribute expression more evenly across multiple isoforms? And do cells of the same type agree on which isoforms they use—or is there variation even within a single population? In the FLAMESv2 framework, we formalize this idea using Shannon’s entropy, implemented through the find_diversity() function, to quantify isoform diversity at single-cell resolution. In simple terms, entropy provides a numerical score describing how evenly a gene’s expression is split across its isoforms: Low entropy → the gene primarily expresses a single isoform in that cell. High entropy → the gene expresses multiple isoforms in roughly equal proportions. Code knitr::include_graphics(&quot;images/entropy_example.png&quot;) Figure 9.1: Isoform diversity schematic. For each gene, we measure how transcript usage is distributed across isoforms within individual cells. Cells dominated by a single isoform show low isoform diversity (low entropy), while cells that express multiple isoforms at similar levels show high isoform diversity (high entropy). 9.1 Measuring entropy with find_diversity() function Let’s focus on the Radial Glial cells and explore the diversity of gene expression within individual cells. In the FLAMESv2 software, we provide a dedicated function called find_diversity(). This function offers a simple way to calculate Shannon’s entropy for every gene in every cell, providing a quantitative measure of isoform or gene expression diversity. In FLAMESv2, This function is designed to operate on SingleCellExperiment (SCE) objects; however, in this tutorial we use a Seurat object. Therefore, the function has been appropriately modified to accept a Seurat object as input. For detailed explanations of the parameters and outputs, please refer to the FLAMES Bioconductor manual. In the following section, we will examine the diversity metrics across approximately 100 Radial Glial cells to illustrate this functionality in action. We can load and run the function. It may take a while if you are processing many genes or many isofroms. We will subset the object and run the diversity function Code #load diversity source(&quot;code/find_diversity.R&quot;) # Subset to RG RG_seu_obj &lt;- subset(seu_obj , subset = sctype_db == &quot;Radial glial cells&quot;) DimPlot(RG_seu_obj, reduction = &quot;umap&quot;) Code DefaultAssay(RG_seu_obj) &lt;- &quot;RNA&quot; Code #select genes we want to test. #In this case all genes genes &lt;- rownames(RG_seu_obj) library(progressr) handlers(&quot;txtprogressbar&quot;) # Use with_progress and create progressor inside res &lt;- find_diversity( obj = RG_seu_obj, min_counts_per_cell = 10, assay = &quot;iso&quot;, genes = genes ) ## save file #saveRDS(res, &quot;output_files/res.rds&quot;) Code # load res files res &lt;- readRDS(file = &quot;./output_files/res.rds&quot;) dim(res$raw_entropy) ## [1] 269 112 After running the diversity function, we identified 269 genes for which we could calculate isoform diversity metrics. By default, these tend to be highly expressed genes that are detected in at least 20% of cells. These parameters can be changed by the user, but because single-cell data are sparse we recommend being conservative. This helps make sure that each gene has enough counts per cell to accurately estimate diversity. We can summarise these results in a heatmap. In this plot, each column is a single cell and each row is a gene that passed filtering. Grey regions indicate cell–gene combinations where there were not enough counts to calculate entropy for that gene in that cell. Code library(pheatmap) pheatmap(res$normalized_entropy, show_rownames = FALSE, show_colnames = FALSE, cluster_rows = TRUE, cluster_cols = TRUE, main = &quot;Entropy heatmap&quot;, na_col = &quot;darkgrey&quot;, ) We can summarise these data by examining the top and bottom entropy genes—those showing the highest and lowest levels of isoform diversity across Radial Glial cells. Code library(ggplot2) # Median entropy per gene df &lt;- data.frame( gene = rownames(res$normalized_entropy), median_entropy = apply(res$normalized_entropy, 1, median, na.rm = TRUE) ) # Global median global_median &lt;- median(df$median_entropy, na.rm = TRUE) #Select bottom 25 nonzero genes, always include VIM df_nonzero &lt;- df %&gt;% dplyr::filter(median_entropy &gt; 0 | gene == &quot;VIM&quot;) df_low &lt;- df_nonzero %&gt;% dplyr::mutate(median_entropy = as.numeric(median_entropy)) %&gt;% dplyr::arrange(median_entropy) %&gt;% dplyr::slice(1:25) # Top 25 by highest median entropy df_high &lt;- df %&gt;% dplyr::mutate(median_entropy = as.numeric(median_entropy)) %&gt;% # ensure it&#39;s numeric dplyr::arrange(desc(median_entropy)) %&gt;% dplyr::slice(1:25) # --- Low entropy plot (blue) with scale break --- p_low &lt;- ggplot(df_low, aes(x = median_entropy, y = reorder(gene, median_entropy), fill = median_entropy)) + geom_col() + geom_vline(xintercept = global_median, linetype = &quot;dashed&quot;, color = &quot;black&quot;) + scale_fill_gradient(low = &quot;darkblue&quot;, high = &quot;skyblue&quot;) + labs(x = &quot;Median Normalised Entropy&quot;, y = &quot;Low Entropy Genes&quot;) + theme_bw(base_size = 12) + theme(legend.position = &quot;none&quot;) # --- High entropy plot (red) --- p_high &lt;- ggplot(df_high, aes(x = median_entropy, y = reorder(gene, median_entropy), fill = median_entropy)) + geom_col() + geom_vline(xintercept = global_median, linetype = &quot;dashed&quot;, color = &quot;black&quot;) + scale_fill_gradient(low = &quot;mistyrose&quot;, high = &quot;firebrick&quot;) + labs(x = &quot;Median Normalised Entropy&quot;, y = &quot;High Entropy Genes&quot;) + theme_bw(base_size = 12) + theme(legend.position = &quot;none&quot;) p_high | p_low Lets choose two genes to have a closer look at. We will choose one with low entropy - VIM, and one with high entropy NFIA. We can use some plotting functions to explore entropy in each cell and the expression of these isofroms for each gene. As you can see most cells for VIM show low entropy while cells expressing NFIA show comparatively high entropy. Code # Choose the genes we want to plot genes &lt;- c(&quot;VIM&quot;, &quot;NFIA&quot;) # Pull norm entropy and filter for genes we want df_entropy &lt;- res$normalized_entropy[genes, , drop = FALSE] # Restructure the df df_long &lt;- df_entropy %&gt;% as.data.frame() %&gt;% tibble::rownames_to_column(&quot;gene&quot;) %&gt;% pivot_longer( cols = -gene, names_to = &quot;cell&quot;, values_to = &quot;entropy&quot; ) # Add the cluster Identity df_long$sctype_db &lt;- RG_seu_obj$sctype_db[df_long$cell] library(ggplot2) library(ggbeeswarm) plot_entropy &lt;- function(df, gene_name) { df_gene &lt;- df %&gt;% filter(gene == gene_name) med_val &lt;- median(df_gene$entropy, na.rm = TRUE) ggplot(df_gene, aes(x = sctype_db, y = entropy)) + geom_quasirandom(alpha = 0.4, varwidth = TRUE) + stat_summary(fun = median, geom = &quot;crossbar&quot;, width = 0.6, fatten = 2, color = &quot;red&quot;) + labs( title = paste0(&quot;Isoform entropy: &quot;, gene_name), subtitle = paste0(&quot;Median = &quot;, round(med_val, 3)), x = &quot;Cell type&quot;, y = &quot;Normalised Shannon entropy&quot; ) + theme_minimal() + theme( axis.text.x = element_text(angle = 45, hjust = 1), plot.subtitle = element_text(color = &quot;grey40&quot;) ) } # Plot p_VIM &lt;- plot_entropy(df_long, &quot;VIM&quot;) p_NFIA &lt;- plot_entropy(df_long, &quot;NFIA&quot;) p_VIM | p_NFIA ## Warning: Removed 2 rows containing non-finite outside the scale range (`stat_summary()`). ## Warning: Removed 2 rows containing missing values or values outside the scale range (`position_quasirandom()`). ## Warning: Removed 43 rows containing non-finite outside the scale range (`stat_summary()`). ## Warning: Removed 43 rows containing missing values or values outside the scale range (`position_quasirandom()`). 9.2 Example of a low entropy gene Let’s look at VIM in a bit more detail. VIM is a simple in the sense that nearly all counts for these gene belong to the canonical isoform. We can plot this on a UMAP as shown bellow. Code # load Visualize fucntions # You can find the code on the github page or from the release which you can download - instructions on the first page source(&quot;code/plot_isoforms_exp_umap.R&quot;) source(&quot;code/plot_isoform_entropy.R&quot;) source(&quot;code/plotIsoformPieCells.R&quot;) plot_isoforms_exp_umap( obj = RG_seu_obj, gene = &quot;VIM&quot;, reduction = &quot;umap&quot;, slot = &quot;data&quot;, assay = &quot;iso&quot;, ncol = 2, n_features = 10 #, # Optional: limit to top 5 isoforms #entropy_mat = res$normalized_entropy ) ## Feature Expression ## ENST00000224237.9-VIM ENST00000224237.9-VIM 488.094333 ## ENST00000487938.5-VIM ENST00000487938.5-VIM 11.304910 ## ENST00000469543.5-VIM ENST00000469543.5-VIM 7.051489 ## ENST00000485947.1-VIM ENST00000485947.1-VIM 3.992523 We can also look at the proportion of isoform expression for VIM in each cell. As clearly shown bellow nearly all cells use a single isofroms. Code plotIsoformPieCells(seurat_obj = RG_seu_obj, gene = &quot;VIM&quot;, assay = &quot;iso&quot;, slot = &quot;counts&quot;, top_n = 3, n_cells = 12, # change this to plot more cells plot_col=4) 9.3 Example of a high entropy gene Let’s contrast this to a gene with high entropy, NFIA. In this case NFIA is far more complex. Many cells show expression of multiple isofroms. Code plot_isoforms_exp_umap( obj = RG_seu_obj, gene = &quot;NFIA&quot;, reduction = &quot;umap&quot;, slot = &quot;data&quot;, assay = &quot;iso&quot;, ncol = 2, n_features = 4 #, # Optional: limit to top 4 isoforms #entropy_mat = res$normalized_entropy ) ## Feature Expression ## ENST00000403491.8-NFIA ENST00000403491.8-NFIA 161.913441 ## ENST00000603233.2-NFIA ENST00000603233.2-NFIA 157.623083 ## ENST00000664149.1-NFIA ENST00000664149.1-NFIA 7.102752 ## ENST00000371187.7-NFIA ENST00000371187.7-NFIA 5.396720 The pie charts bellow show that, in contrast to VIM, cells expressing NFIA utilize at least two isoforms, often in nearly equal proportions. This pattern explains the high entropy observed for NFIA and suggests a more complex expression profile compared to a simpler, single-isoform gene like VIM. Interestingly, there are numerous NFIA isoforms. The two most highly expressed isoforms shown here are quite distinct, as illustrated in the IsoVis plot below — one is protein-coding, containing critical functional domains, while the other represents a non-coding RNA variant. Code plotIsoformPieCells(seurat_obj = RG_seu_obj, gene = &quot;NFIA&quot;, assay = &quot;iso&quot;, slot = &quot;counts&quot;, top_n = 5, n_cells = 12, plot_col=4) Using IsoVis, we can further explore the structural differences between these isoforms and visualize how they contribute to transcriptomic complexity within individual cells. Code knitr::include_graphics(&quot;images/IsoVis_ENSG00000162599.png&quot;) Figure 9.2: Isoform diversity in NFIA (ENSG00000162599). Structural comparison of NFIA isoforms highlights the diversity of transcript usage detected in single-cell long-read data. The canonical and user-discovered isoforms differ markedly in exon structure and domain composition. One isoform encodes a full-length protein containing key functional domains (Nuclear factor, MH1, and CTF/NF-I), while another represents a non-coding or truncated transcript lacking these regions. By quantifying entropy at the single-cell level, we can distinguish simple genes - those dominated by one isoform, from complex genes that express multiple isoforms with variable expression across cells. In the case of Radial Glial cells, this approach reveals a mixture of both expression modes: some genes like VIM exhibit low isoform diversity, consistent with stable structural roles, whereas others like NFIA show high entropy, reflecting more dynamic or context-dependent regulation. 9.4 Broadening Entropy Analysis For simplicity, in this example we explored isoform entropy in only a small subset of cells. However, this analysis can easily be expanded to include broader cell populations or even the entire dataset. Doing so enables more comprehensive, cell type–specific investigations, for example, assessing whether certain genes show different entropy levels across different cell types. Such comparisons can reveal important biological insights: some cell types may display low entropy, consistent with a simple and stable transcriptional program, while others—particularly more mature or specialized lineages may exhibit higher entropy, reflecting more complex isoform regulation and splicing diversity. "],["multisample-analysis.html", "Chapter 10 Multisample analysis 10.1 Standard pre-processing and quality control 10.2 Multisample integration 10.3 Add isoform counts 10.4 Identify cell types", " Chapter 10 Multisample analysis The FLAMES pipeline supports the analysis of multiple samples simultaneously, allowing users to handle more complex experimental designs without having to process each sample independently. This is implemented through the FLAMES::MultiSampleSCPipeline() function, which produces outputs that are analogous to the single-sample workflow described in earlier chapters, but extends it to multi-sample experiments and ensures that novel isoform discovery is performed consistently across the entire dataset. To take full advantage of these features, we first need to perform a few initial processing steps: Sample QC – Basic preprocessing and quality control are largely the same as for a single sample. Here, we also show how to start directly from FLAMES output and perform initial QC without empty droplet removal or ambient RNA normalisation. These extra steps are recommended, but may not always be required depending on the dataset. Sample integration – Combining multiple samples into a single integrated object to remove batch effects and align shared biological structure. Adding isoform counts – Incorporating isoform-level counts into the integrated Seurat object so that gene- and isoform-level analyses can be performed side by side. Cell type identification – Annotating the integrated object with biologically meaningful cell type labels. In this chapter, we will walk through these steps using a small subset of a multi-sample dataset (described below). Once we have an integrated object that contains both gene and isoform counts, we can use it as the foundation for a range of downstream analyses. In the following chapters, we will illustrate two key examples: Trajectory analysis – using pseudotime to identify genes and isoforms that change along differentiation paths. Differential transcript usage (DTU) analysis – investigating changes in isoform proportions between conditions. 10.0.1 Dataset Information For this analysis, we use a subset of the neuronal differentiation dataset described in Wang et al. (2025). The full dataset contains eight samples spanning four time points from an excitatory neuronal differentiation protocol. To keep the tutorial runtime manageable, we randomly selected 2000 cells in total drawn from four samples at the first two timepoints: two stem cell (STC) samples and two Day 25 samples. This subset still captures the early stages of neuronal differentiation and allows us to explore temporal changes in gene and isoform expression between stem cells and early neuronal progenitors. 10.1 Standard pre-processing and quality control As before we will modify the count matrix for each sample so we use gene_symbol instead of ENSGID. The data generated from this multisample experiment is quite large. This is especially the case with Oarfish isoform quantification as there are many more features to consider. This means much of the workflow below is time consuming and computationally intensive. Please keep this in mind when processing your samples. In the tutorial we provide code for the required steps but do not evaluate many of the sections below due to these computational constraints. The raw counts are available in the multisample data folder if users wish to run through the analysis. First we will make the isoform gene dictionary for the mutisample mode. Code # The FLAMES ref can be found in your selected output folder after running the Flames pipeline. FLAMES_gtf_file &lt;- &quot;data/multi_sample_subset/isoform_annotated.gtf&quot; #ensure file is unzipped reference_gtf_file &lt;- &quot;data/gencode.v47.annotation.gtf&quot; # ensure file is unzipped output_file &lt;- &quot;isoform_gene_dict_mutlisample_subset.csv&quot; # Call the helper function defined in code block above to create a dictionary containing corresponding gene information for each isoform # This may take a few minutes isoform_gene_dict_mutlisample &lt;- make_isoform_gene_symbol_dict(FLAMES_gtf_file, reference_gtf_file, output_file) Code # convert Gene_id to gene symbol for all counts #run a loop to run this function on all count files. # Directory with input files input_dir &lt;- &quot;./data/multi_sample_subset/&quot; output_dir &lt;- &quot;./data/multi_sample_subset/&quot; # List all CSV files in the input directory input_files &lt;- list.files(input_dir, pattern = &quot;\\\\count_subset.csv$&quot;, full.names = TRUE) # Initialize an empty list to store data frames result_list &lt;- list() # Process each file in the directory total_files &lt;- length(input_files) # Total number of files for (i in seq_along(input_files)) { file_path &lt;- input_files[i] # Extract file name without extension file_name &lt;- tools::file_path_sans_ext(basename(file_path)) # Construct the output file name output_file &lt;- file.path(output_dir, paste0(file_name, &quot;_gene_symbol.csv&quot;)) # Show progress to the user message(sprintf(&quot;Processing file %d of %d: %s&quot;, i, total_files, file_name)) # Call the function with return_df = TRUE to store the result result_list[[file_name]] &lt;- convert_ENSGID_to_geneSymbol( id_symbol_df = isoform_gene_dict_mutlisample, gene_count_matrix_path = file_path, output_file = output_file, return_df = TRUE ) } ## Processing file 1 of 4: C1_STC_matched_reads_gene_count_subset ## Processing file 2 of 4: C2_Day25_matched_reads_gene_count_subset ## Processing file 3 of 4: C4_STC_matched_reads_gene_count_subset ## Processing file 4 of 4: C5_Day25_matched_reads_gene_count_subset 10.1.1 Define QC function We have developed a multisample QC function @ref(Multisample QC function) for processing count matrices and constructing filtered Seurat objects, following best practices outlined in the Seurat tutorial. This function includes steps to identify and remove doublets, as well as generate key diagnostic plots for data inspection. We encourage users to customize this function to fit their specific needs, such as applying additional filtering criteria. For the purposes of presenting concise and readable code we will apply the default filtering parameters to all objects. If users wish to be more specific about filtering each sample independently this is possible and can be done by running the perform_qc_filtering function on each sample with desired parameters. Code # Define sample names sample_names &lt;- c(&quot;C1_STC&quot;, &quot;C4_STC&quot;, &quot;C2_Day25&quot;, &quot;C5_Day25&quot;) # Initialize a list to store UMAP objects umap_objects &lt;- list() # Start the PDF for output pdf(file = &quot;./output_files/multi_sample_subset/QC/multisample_QC.pdf&quot;, width = 10, height = 6) # Loop through each sample and apply the QC filtering function for (i in seq_along(sample_names)) { sample_name &lt;- sample_names[i] # Print progress message message(paste0(&quot;Processing sample &quot;, i, &quot; of &quot;, length(sample_names), &quot;: &quot;, sample_name)) # Perform QC filtering result &lt;- perform_qc_filtering( result_list[paste0(sample_name, &quot;_matched_reads_gene_count_subset&quot;)], fig_name = sample_name, project = sample_name ) # Store the UMAP object from the result umap_objects[[sample_name]] &lt;- result[[1]] } # Close the PDF device dev.off() #save the object #saveRDS(umap_objects, file = &quot;./output_files/multi_sample_subset//umap_objects.rds&quot;) 10.2 Multisample integration First we will merge the Seurat objects together and then perform integration. There are many options for sample integration and Seurat provides many wrappers for these functions. Here we will use Harmony (Korsunsky et al., 2019) for fast and effective integration. The code chunk bellow takes our samples and merges them together. Code # integrate samples #from the function above pull the filtered seurat object umap_objects &lt;- readRDS(&quot;./output_files/multi_sample_subset//umap_objects.rds&quot;) merged_seurat &lt;- merge( umap_objects[[&quot;C1_STC&quot;]], y = list( umap_objects[[&quot;C4_STC&quot;]], umap_objects[[&quot;C2_Day25&quot;]], umap_objects[[&quot;C5_Day25&quot;]] ), add.cell.ids = c( &quot;C1_STC&quot;, &quot;C4_STC&quot;, &quot;C2_Day25&quot;, &quot;C5_Day25&quot; ), project = &quot;Multi-sample_tutorial&quot; ) # create a sample column merged_seurat$sample &lt;- rownames(merged_seurat@meta.data) ## split sample column to make a batch col merged_seurat@meta.data &lt;- separate(merged_seurat@meta.data, col = &#39;sample&#39;, into = c(&#39;batch&#39;, &#39;Day&#39;, &#39;Barcode&#39;), sep = &#39;_&#39;) #check some QC metrics VlnPlot(merged_seurat, features = c(&quot;nFeature_RNA&quot;, &quot;nCount_RNA&quot;, &quot;percent.mt&quot;), ncol = 3, group.by = &quot;Day&quot;) + plot_annotation(title = &quot;Vln plots grouped by Day&quot;) Code #can plot based on any metadata col #VlnPlot(merged_seurat, features = c(&quot;nFeature_RNA&quot;, &quot;nCount_RNA&quot;, &quot;percent.mt&quot;), ncol = 3, group.by = &quot;orig.ident&quot;) # Number of cells per group table(merged_seurat$orig.ident) ## ## C1_STC C2_Day25 C4_STC C5_Day25 ## 225 330 328 138 Code table(merged_seurat$Day) ## ## Day25 STC ## 468 553 Code # Apply normal preprocessing steps to merged file merged_seurat &lt;- NormalizeData(object = merged_seurat) ## Normalizing layer: counts.C1_STC ## Normalizing layer: counts.C4_STC ## Normalizing layer: counts.C2_Day25 ## Normalizing layer: counts.C5_Day25 Code merged_seurat &lt;- FindVariableFeatures(object = merged_seurat) ## Finding variable features for layer counts.C1_STC ## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : pseudoinverse used at -2.0512 ## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : neighborhood radius 0.30103 ## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : reciprocal condition number ## 2.3467e-16 ## Finding variable features for layer counts.C4_STC ## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : pseudoinverse used at -2.2148 ## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : neighborhood radius 0.30103 ## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : reciprocal condition number ## 4.1338e-16 ## Finding variable features for layer counts.C2_Day25 ## Finding variable features for layer counts.C5_Day25 ## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : pseudoinverse used at -1.8388 ## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : neighborhood radius 0.30103 ## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : reciprocal condition number ## 5.5033e-16 Code merged_seurat &lt;- ScaleData(object = merged_seurat) ## Centering and scaling data matrix Code merged_seurat &lt;- RunPCA(object = merged_seurat) ## PC_ 1 ## Positive: L1TD1, MGST1, GRID2, CACNA2D3, PRDX1, MT-CO3, HSPA8, GALNT17, POLR3G, ADGRV1 ## ENSG00000248605, MT-ATP6, RBFOX1, ROR1, SHISA9, GPR176, RBM47, MT-CO2, SNTG2, PTPRG ## BNC2, SPATS2L, ENSG00000274090, HDAC2-AS2, MCM3, MT-CYB, FRAS1, ENSG00000203279, RPL22L1, CALN1 ## Negative: MALAT1, ENSG00000280441, ENSG00000278996, DACH1, ENSG00000280614, ENSG00000280800, ZEB1, ENSG00000281181, SOX5, TUBA1A ## DLK1, ENSG00000257060, ENSG00000281383, WNT5B, NNAT, MAP2, ZFHX4, MEIS2, GPM6A, NPAS3 ## MAPK10, CKB, FGF13, KCNQ3, ZBTB20, GREB1L, VIM, SSBP2, SOX6, LINC01414 ## PC_ 2 ## Positive: ENSG00000259316, HMGB2, RPS24, SOX2-OT, VIM, DEK, CENPH, HMGN2, PTTG1, TUBA1B ## H2AZ2, CDC20, BIRC5, FRZB, LINC01830, MIR99AHG, LIX1, MXD3, H2AX, SMC4 ## RPS3A, TYMS, CCNB2, MT-ND3, UBE2C, PBK, NUSAP1, ENSG00000285920, CCN1, IGFBP2 ## Negative: RIMS2, STMN2, AKAP6, NFASC, XKR4, NALF1, CHN2, RMST, GAP43, KIF5C ## PCSK2, NRXN1, ANK3, PTPRD, ERC2, CADPS, NSG2, MYT1L, CACNA2D1, ENSG00000283982 ## LINC01917, CTNNA2, ELAVL2, PBX1, CELF3, SLIT1, INA, DST, ELAVL4, CACNA1B ## PC_ 3 ## Positive: JPT1, TUBB2A, TMSB10, UBE2S, RBP1, S100A11, CRABP1, TUBB, BDNF-AS, NEFM ## PLAAT3, S100A10, TUBB2B, STMN2, ID2, DYNLL1, INA, IGFBPL1, MT1X, GDAP1L1 ## GNG8, ST18, GAP43, CELF3, ID3, INSM1, TAGLN, PCSK1N, NSG2, LDHA ## Negative: GPC6, FBXL7, B3GALT1, FAT3, DLG2, ENSG00000228222, QKI, EFNA5, PLEKHA5, PARD3B ## XYLT1, TOX, NRG3, LINC03077, STK3, NLGN1, PTPRK, KCNT2, SDK1, EXT1 ## GRIP1, RAD51B, PRKD1, DAB1, LDB2, SUPT3H, CDK14, TTC28, NAV3, KIAA1217 ## PC_ 4 ## Positive: DANT2, RPL22L1, RPS24, BDNF-AS, RPS3A, PCDH11X, ENSG00000271860, MT-RNR2, PLAAT3, PRKG1 ## TPM1, MT-CO3, DANT1, S100A11, ADAMTS6, ENSG00000272449, BST2, MT1X, LINC01414, DIAPH2 ## MT-RNR1, DGKB, RPL34, ENSG00000289195, MT-CO1, ENSG00000239920, ATP2B4, USP38-DT, ID3, ENSG00000297419 ## Negative: PBK, NUSAP1, PRC1, TOP2A, NUF2, ENSG00000285920, MXD3, TPX2, GAS2L3, NEK2 ## CENPA, HMGB2, MKI67, KIF18A, CKAP2L, CDCA3, TUBB4B, KIF2C, FAM72C, GTSE1 ## SGO2, KIFC1, CENPE, FAM72A, H2AX, FAM72D, ASPM, CDCA8, NDC80, RACGAP1 ## PC_ 5 ## Positive: CDH18, LINC02609, LHX5-AS1, TBR1, EBF1, RSPO3, GPR149, SLC4A10, ENSG00000286446, SLIT1 ## ENSG00000296399, SLC17A6, FSTL5, EPB41L3, ANKFN1, ROBO1, PCSK2, LHX1-DT, ENSG00000293110, LHX5 ## PCDH9, TRH, EPHA3, ENSG00000227681, SAMD5, PCSK1N, GABBR2, RORB, ENSG00000259316, ENSG00000224658 ## Negative: ASCL1, RASD1, DLX6-AS1, GADD45G, RGS16, NRXN3, MEST, NXPH1, GAD2, SMOC1 ## COPG2IT1, ENSG00000258416, SOX4, COPG2, DLL1, SLCO5A1, GNG8, LINC02106, ENSG00000258637, MYT1 ## ATP2B4, ENSG00000234710, PXDN, RND3, TH, ENSG00000295572, NOL4, ENSG00000270953, ISL1, PCP4 Code merged_seurat &lt;- FindNeighbors(object = merged_seurat, dims = 1:16) ## Computing nearest neighbor graph ## Computing SNN Code merged_seurat &lt;- FindClusters(object = merged_seurat, resolution = 0.6) ## Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck ## ## Number of nodes: 1021 ## Number of edges: 29966 ## ## Running Louvain algorithm... ## Maximum modularity in 10 random starts: 0.8700 ## Number of communities: 8 ## Elapsed time: 0 seconds Code merged_seurat &lt;- RunUMAP(object = merged_seurat, dims = 1:30) ## 12:41:32 UMAP embedding parameters a = 0.9922 b = 1.112 ## 12:41:32 Read 1021 rows and found 30 numeric columns ## 12:41:32 Using Annoy for neighbor search, n_neighbors = 30 ## 12:41:32 Building Annoy index with metric = cosine, n_trees = 50 ## 0% 10 20 30 40 50 60 70 80 90 100% ## [----|----|----|----|----|----|----|----|----|----| ## **************************************************| ## 12:41:32 Writing NN index file to temp file /tmp/RtmpSqzgLk/file35f6113b834dc ## 12:41:32 Searching Annoy index using 1 thread, search_k = 3000 ## 12:41:32 Annoy recall = 100% ## 12:41:34 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30 ## 12:41:36 Found 2 connected components, falling back to &#39;spca&#39; initialization with init_sdev = 1 ## 12:41:36 Using &#39;irlba&#39; for PCA ## 12:41:36 PCA: 2 components explained 51.16% variance ## 12:41:36 Scaling init to sdev = 1 ## 12:41:36 Commencing optimization for 500 epochs, with 39318 positive edges ## 12:41:38 Optimization finished Code ##save merged object saveRDS(merged_seurat, file = &quot;./output_files/multi_sample_subset//merged_seurat.rds&quot;) We then integrate the samples using Harmony and generate UMAPs from both the merged (non-integrated) and integrated data. This allows us to visually compare how well integration has reduced sample-specific batch effects. In this dataset, the integrated UMAP shows that cells from different samples cluster together based on their biological state rather than their sample of origin, indicating that there is no obvious sample-driven bias in the clustering. Code set.seed(00003) merged_seurat &lt;- readRDS(&quot;./output_files/multi_sample_subset/merged_seurat.rds&quot;) #Let&#39;s plot the merged file. p1 &lt;- FeaturePlot(merged_seurat, reduction = &#39;umap&#39;, features = &#39;nCount_RNA&#39;) p2 &lt;- FeaturePlot(merged_seurat, reduction = &quot;umap&quot;, features = &#39;nFeature_RNA&#39;) p3 &lt;- DimPlot(merged_seurat, reduction = &#39;umap&#39;, group.by = &#39;Day&#39;) p4 &lt;- DimPlot(merged_seurat, reduction = &#39;umap&#39;, group.by = &#39;orig.ident&#39;) grid.arrange(p1, p2, p3, p4, ncol = 2) Code merged_seurat &lt;- JoinLayers(object = merged_seurat) merged_seurat[[&quot;RNA&quot;]] &lt;- split(merged_seurat[[&quot;RNA&quot;]], f = merged_seurat$orig.ident) #perform integration with Harmony obj &lt;- IntegrateLayers(object = merged_seurat, method = HarmonyIntegration, orig.reduction = &quot;pca&quot;, new.reduction = &#39;integrated.harm&#39;, verbose = FALSE, ) ## Warning in harmony::HarmonyMatrix(data_mat = Embeddings(object = orig), : HarmonyMatrix is deprecated and will be removed in the ## future from the API in the future Code obj &lt;- FindNeighbors(obj, reduction=&quot;integrated.harm&quot;) obj &lt;- FindClusters(obj, resolution=0.4, cluster.name=&quot;harm_cluster&quot;) ## Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck ## ## Number of nodes: 1021 ## Number of edges: 29472 ## ## Running Louvain algorithm... ## Maximum modularity in 10 random starts: 0.8720 ## Number of communities: 7 ## Elapsed time: 0 seconds Code obj &lt;- RunUMAP(obj, reduction=&quot;integrated.harm&quot;, dims=1:50, reduction.name = &quot;umap.harm&quot;) DimPlot(obj, reduction = &quot;umap.harm&quot;, group.by = c(&quot;Day&quot;, &quot;orig.ident&quot;, &quot;harm_cluster&quot;), label = T) Code ### save object saveRDS(obj, file = &quot;./output_files/multi_sample_subset//integrated_harm_seurat.rds&quot;) 10.3 Add isoform counts Now we can add isoform level information to the integrated Seurat object. When doing this you may need to convert the Oarfish files into a count.csv file with the row names in the ENSTID_genesymbol form. The function to do so can be found here @ref(Convert Oarfish files to count matrix). The function also allows you to include or exclude novel bambu genes quantified by Oarfish; for the sake of simplicity in this tutorial, we will exclude these novel bambu genes. Code # Define sample names sample_names &lt;- c(&quot;C1_STC&quot;, &quot;C4_STC&quot;, &quot;C2_Day25&quot;, &quot;C5_Day25&quot;) # Loop through each sample and process the count files for (sample in sample_names) { # Use tryCatch to handle errors tryCatch({ # Call the function to process the sample process_oarfish_files_to_counts_matrix( sample_name = sample, resource_table_path = &quot;./output_files/ref_files/isoform_gene_dict_mutlisample_subset.csv&quot;, output_dir = &quot;./output_files/multi_sample_subset/oarfish_counts/&quot;, input_dir = &quot;./data/multi_sample_subset/oarfsih/&quot;, filter_bambu_Genes = TRUE ) }, error = function(e) { # Print the error message and exit the loop cat(&quot;Error processing sample:&quot;, sample, &quot;\\nError message:&quot;, e$message, &quot;\\nExiting loop.\\n&quot;) stop(e) }) } Once we have created the CSV files with the correct structure (ENSTID_genesymbol), we can add the isoform information back into our gene-level object. First, we create an isoform-level Seurat object for each sample and merge these into a single isoform Seurat object. Next, we filter the merged isoform object to retain only high-quality cells, using the cell types and QC filters defined in the gene-level analysis above. Code ############ read in count matrix and add isoform assay to Seurat object ######### #Make Seurat objects not filtered # Function to read a CSV file and create a Seurat object create_seurat_object &lt;- function(sample_name, input_dir, project_name) { # Construct file path file_path &lt;- file.path(input_dir, paste0(&quot;gene_symbol_oarfish_&quot;, sample_name, &quot;_counts.csv&quot;)) # Read the CSV file counts &lt;- fread(file_path) counts &lt;- as.data.frame(counts) rownames(counts) &lt;- counts[[1]] # Set row names from the first column counts[[1]] &lt;- NULL # Create the Seurat object seurat_obj &lt;- CreateSeuratObject(counts = counts, project = project_name, min.cells = 5, min.features = 500) return(seurat_obj) } # Directory where the CSV files are stored input_directory &lt;- &quot;./output_files/multi_sample_subset/oarfish_counts/&quot; # Create an empty list to store Seurat objects iso_seurat_objects &lt;- list() total_samples &lt;- length(sample_names) for (i in seq_along(sample_names)) { sample &lt;- sample_names[i] message(sprintf(&quot;Processing sample %d of %d: %s&quot;, i, total_samples, sample)) iso_seurat_objects[[sample]] &lt;- create_seurat_object( sample_name = sample, input_dir = input_directory, project_name = sample ) } ####### Merge the samples into one object ###### iso.merged_seurat &lt;- merge( iso_seurat_objects[[&quot;C1_STC&quot;]], y = list( iso_seurat_objects[[&quot;C4_STC&quot;]], iso_seurat_objects[[&quot;C2_Day25&quot;]], iso_seurat_objects[[&quot;C5_Day25&quot;]] ), add.cell.ids = c( &quot;C1_STC&quot;, &quot;C4_STC&quot;, &quot;C2_Day25&quot;, &quot;C5_Day25&quot; ), project = &quot;iso-Multi-sample_tutorial&quot; ) # create a sample column iso.merged_seurat$sample &lt;- rownames(iso.merged_seurat@meta.data) # split sample column to makw a batch col iso.merged_seurat@meta.data &lt;- separate(iso.merged_seurat@meta.data, col = &#39;sample&#39;, into = c(&#39;batch&#39;, &#39;Day&#39;, &#39;Barcode&#39;), sep = &#39;_&#39;) ## filter the data to iso and gene cells match merged_seurat_isoform_filtered &lt;- subset(iso.merged_seurat, cells =obj@graphs[[&quot;RNA_nn&quot;]]@Dimnames[[1]]) VlnPlot(merged_seurat_isoform_filtered, features = c(&quot;nFeature_RNA&quot;, &quot;nCount_RNA&quot;, &quot;percent.mt&quot;), ncol = 3) # perform standard workflow steps merged_seurat_isoform_filtered &lt;- NormalizeData(object = merged_seurat_isoform_filtered) # if using SCT dont run this merged_seurat_isoform_filtered &lt;- FindVariableFeatures(object = merged_seurat_isoform_filtered) # if using SCT dont run this merged_seurat_isoform_filtered &lt;- ScaleData(object = merged_seurat_isoform_filtered) # if using SCT dont run this merged_seurat_isoform_filtered &lt;- RunPCA(object = merged_seurat_isoform_filtered) #ElbowPlot(merged_seurat_isoform_filtered) merged_seurat_isoform_filtered &lt;- FindNeighbors(object = merged_seurat_isoform_filtered, dims = 1:10) merged_seurat_isoform_filtered &lt;- FindClusters(object = merged_seurat_isoform_filtered, resolution = 0.6) merged_seurat_isoform_filtered &lt;- RunUMAP(object = merged_seurat_isoform_filtered, dims = 1:10) #Save file saveRDS(merged_seurat_isoform_filtered, file = &quot;./output_files/multi_sample_subset//merged_seurat_isoform_filtered.rds&quot;) We can then add this merged isoform object as a new assay in the gene-level Seurat object, allowing gene- and isoform-level analyses to be performed side by side. In principle, the isoform assay could also be integrated across samples (e.g. using Harmony) to further remove sample-specific batch effects, but for simplicity we do not perform isoform-level integration in this tutorial and rely on gene level integration. Code merged_seurat_isoform_filtered &lt;- readRDS(file = &quot;./output_files/multi_sample_subset//merged_seurat_isoform_filtered.rds&quot;) #plots p5 &lt;- DimPlot(merged_seurat_isoform_filtered, reduction = &#39;umap&#39;, group.by = &#39;orig.ident&#39;) p6 &lt;- DimPlot(merged_seurat_isoform_filtered, reduction = &#39;umap&#39;, group.by = &#39;Day&#39;) p7 &lt;- FeaturePlot(merged_seurat_isoform_filtered, reduction = &#39;umap&#39;, features = &#39;nCount_RNA&#39;) p8 &lt;- FeaturePlot(merged_seurat_isoform_filtered, reduction = &quot;umap&quot;, features = &#39;nFeature_RNA&#39;) grid.arrange(p5, p6, p7, p8, ncol = 2) Code ##### merged_seurat_isoform_filtered &lt;- JoinLayers(merged_seurat_isoform_filtered) counts_table &lt;- merged_seurat_isoform_filtered[[&quot;RNA&quot;]]$counts obj[[&quot;iso&quot;]] &lt;- CreateAssay5Object(counts = counts_table) # Step 1: Normalize the new assay data obj &lt;- NormalizeData(obj, assay = &quot;iso&quot;) obj &lt;- FindVariableFeatures(obj, assay = &quot;iso&quot;) obj &lt;- ScaleData(obj, assay = &quot;iso&quot;) # Step 4: Perform PCA obj &lt;- RunPCA(obj, assay = &quot;iso&quot;, reduction.name = &quot;pca_iso&quot;) ## Warning: Key &#39;PC_&#39; taken, using &#39;pcaiso_&#39; instead Code # Step 5: Run UMAP obj &lt;- RunUMAP(obj, reduction = &quot;pca_iso&quot;, dims = 1:15, assay = &quot;iso&quot;, reduction.name = &quot;umap_iso&quot;) # Visualize the UMAP DimPlot(obj, label = TRUE, reduction = &quot;umap.harm&quot;) | DimPlot(obj, label = TRUE, reduction = &quot;umap_iso&quot;) Now we have a complete object to work with that contains an integrated gene-level assay and isoform counts for the same set of cells. As with any single-cell analysis, the next step is to annotate cell types, so that downstream analyses can be interpreted in a biologically meaningful way. 10.4 Identify cell types Here, we annotate cell types using a small set of key marker genes. We keep this step deliberately simple, as automated annotation methods and GO-enrichment-based strategies have already been described in earlier chapters. Cluster 1 2 and 3 are stem ells Code # We can annoate Day 0 FeaturePlot(obj, reduction = &quot;umap.harm&quot;, features = c(&quot;MKI67&quot;, &quot;NANOG&quot;, &quot;POU5F1&quot;), ncol = 3) Cluster 0 and 4 - Radial Glia Code FeaturePlot(obj, reduction = &quot;umap.harm&quot;, features = c(&quot;VIM&quot;, &quot;SOX2&quot;, &quot;PAX6&quot;), ncol = 3) Cluster 5 - Inhibitory neurons Code FeaturePlot(obj, reduction = &quot;umap.harm&quot;, features = c(&quot;GAD1&quot;, &quot;GAD2&quot;, &quot;DLX5&quot;, &quot;DLX6&quot;),ncol = 4) Cluster 6 - Excitatory neurons (NPC) Code #Clsuter 6 Excitorty neurons (NPC) FeaturePlot(obj, reduction = &quot;umap.harm&quot;, features = c(&quot;EOMES&quot;, &quot;TBR1&quot;)) Now we will assign these labels to each cluster. Code new_ids &lt;- c( &quot;0&quot; = &quot;Radial glia&quot;, &quot;1&quot; = &quot;Stem cells&quot;, &quot;2&quot; = &quot;Stem cells&quot;, &quot;3&quot; = &quot;Stem cells&quot;, &quot;4&quot; = &quot;Radial glia&quot;, &quot;5&quot; = &quot;Inhibitory neurons&quot;, &quot;6&quot; = &quot;Excitatory neurons&quot; ) obj &lt;- RenameIdents(obj, new_ids) # store as a metadata column for later obj$cell_type &lt;- Idents(obj) # plot by cell type instead of numeric cluster DimPlot(obj, group.by = &quot;cell_type&quot;, reduction = &quot;umap.harm&quot;) Code #saveRDS(obj, file = &quot;./output_files/multi_sample/multisample_seurat.intergrated_harm.isoform.rds&quot;) Now that we have an integrated Seurat object containing both gene- and isoform-level counts, along with curated cell type annotations, we can move beyond static clustering to explore how these transcriptional programs change over time and across lineages. In the next sections, we will use this object as the foundation for trajectory analysis, to reconstruct developmental paths and cell state transitions, and for differential transcript usage (DTU) analysis, to identify genes whose isoform composition shifts between conditions, lineages, or cell types. "],["trajectory-analysis.html", "Chapter 11 Trajectory analysis 11.1 Running pseudotime analysis on genes 11.2 Running pseudotime analysis on isoforms 11.3 Summary and downstream applications", " Chapter 11 Trajectory analysis Trajectory analysis is a powerful tool in single-cell RNA-seq allowing us to track how cells transition between different states over time, rather than simply classifying them into discrete clusters. This approach is particularly useful for studying dynamic processes such as cellular differentiation, cell cycle progression, or disease progression. One of the key advantages of trajectory analysis is the ability to identify genes or in the case of long read data, isoforms whose expression patterns are correlated with pseudotime. In our example dataset we are interested in looking at genes or isoforms that change as a function of pseudotime as this will highlight important features that control stem cell to neuronal differentiation. In the below code block is the perform_trajectory_analysis function which uses monocle3 (Trapnell et al., 2014) to learn the trajectory and order the cells by pseudotime. We also provide an optional mode to test for gene or isoforms that are correlated with pseudotime6. Code perform_trajectory_analysis &lt;- function( seurat_obj, assay, prefix, cluster_name = &quot;harm_cluster&quot;, root_cells = NULL, cores = 8, order_features_by_pseudotime = FALSE, number_of_features = 500 ) { library(monocle3) library(SeuratWrappers) library(dplyr) # container for plots plot_list &lt;- list() # Step 1: Set assay and join layers DefaultAssay(seurat_obj) &lt;- assay seurat_obj &lt;- JoinLayers(seurat_obj) # Step 2: Convert to Monocle cell_data_set object cds &lt;- as.cell_data_set(seurat_obj) # Add gene_short_name to feature data (gene metadata) fData(cds)$gene_short_name &lt;- rownames(fData(cds)) # Estimate size factors cds &lt;- estimate_size_factors(cds) # Step 3: Assign cluster info and UMAP coordinates recreate_partition &lt;- as.factor(rep(1, length(colnames(seurat_obj)))) names(recreate_partition) &lt;- colnames(seurat_obj) cds@clusters$UMAP$partitions &lt;- recreate_partition # Clustering information from Seurat (can change to cluster_name if you want) cds@clusters$UMAP$clusters &lt;- seurat_obj@meta.data[[&quot;orig.ident&quot;]] # UMAP embeddings from Seurat ## change umap.harm here to another dim if you plot traj on a different embeding cds@int_colData@listData$reducedDims$UMAP &lt;- seurat_obj@reductions$umap.harm@cell.embeddings # Plot before trajectory cluster_before_trajectory &lt;- plot_cells(cds, color_cells_by = &quot;orig.ident&quot;) + theme(legend.position = &quot;right&quot;) plot_list$cluster_before_trajectory &lt;- cluster_before_trajectory # Step 4: Learn trajectory graph cds &lt;- learn_graph(cds, use_partition = FALSE, close_loop = FALSE) # Plot learned trajectory plot_trajectory &lt;- plot_cells(cds, color_cells_by = cluster_name) + theme(legend.position = &quot;right&quot;) plot_list$trajectory_clusters &lt;- plot_trajectory # Step 5: Order cells in pseudotime cds &lt;- order_cells(cds, reduction_method = &quot;UMAP&quot;, root_cells = root_cells) # Plot pseudotime p_pseudotime &lt;- plot_cells(cds, color_cells_by = &quot;pseudotime&quot;) + theme(legend.position = &quot;right&quot;) plot_list$pseudotime &lt;- p_pseudotime # Combined trajectory + pseudotime panel (patchwork) plot_list$trajectory_and_pseudotime &lt;- plot_trajectory | p_pseudotime # Save pseudotime to Seurat object seurat_obj$pseudotime &lt;- pseudotime(cds) MI_sig &lt;- NULL top_genes &lt;- NULL if (order_features_by_pseudotime) { # Step 6: genes that change along pseudotime seurat_obj &lt;- FindVariableFeatures( seurat_obj, selection.method = &quot;vst&quot;, nfeatures = number_of_features ) top_variable_genes &lt;- VariableFeatures(seurat_obj) cds_subset &lt;- cds[top_variable_genes, ] deg_results &lt;- graph_test( cds_subset, neighbor_graph = &quot;principal_graph&quot;, cores = cores ) MI_sig &lt;- deg_results %&gt;% filter(q_value &lt; 0.01, morans_I &gt; 0.5, status == &quot;OK&quot;) %&gt;% arrange(q_value) # Save table write.csv(MI_sig, paste0(prefix, &quot;_sig_genes_pseudotime.csv&quot;)) # Top genes top_genes &lt;- MI_sig %&gt;% arrange(desc(morans_I)) %&gt;% head(12) # FeaturePlot of top genes (this is usually a patchwork object) fp &lt;- FeaturePlot( seurat_obj, features = top_genes$gene_short_name, reduction = &quot;umap.harm&quot; ) plot_list$top_genes_featureplot &lt;- fp # Pseudotime expression plots for top genes my_genes &lt;- rownames( subset( fData(cds_subset), gene_short_name %in% top_genes$gene_short_name ) ) cds_top_genes &lt;- cds_subset[my_genes, ] monocle_plot &lt;- monocle3::plot_genes_in_pseudotime( cds = cds_top_genes, min_expr = 0.5, cell_size = 0.5, nrow = NULL, ncol = 4, panel_order = NULL, label_by_short_name = TRUE, color_cells_by = cluster_name ) plot_list$top_genes_pseudotime &lt;- monocle_plot } # Return everything you might want later return(list( seurat_obj = seurat_obj, cds = cds, plots = plot_list, MI_sig = MI_sig, top_genes = top_genes )) } 11.1 Running pseudotime analysis on genes We can use the function above to run a pseudotime analysis on our multi-sample data generated in the previous chapter. All we need to do is run the code chunk bellow. We can also set the order_features_by_pseudotime = TRUE and this will test for genes that are correlated with the trajectory. in this case we only test 500 genes as we set number_of_features = 500. Code traj_res &lt;- perform_trajectory_analysis(seurat_obj = obj, assay = &quot;RNA&quot;, prefix = &quot;Multi-sample_subsample_tutorial&quot;, cluster_name=&quot;cell_type&quot;, root_cells = NULL, cores = 8, order_features_by_pseudotime = TRUE, number_of_features = 500) ## | | 0%, ETA NA | | 0%, ETA 01:05 |= | 0%, ETA 00:33 |= | 1%, ETA 00:22 |= | 1%, ETA 00:17 |= | 1%, ETA 00:14 |== | 1%, ETA 00:11 |== | 1%, ETA 00:10 |== | 2%, ETA 00:09 |== | 2%, ETA 00:08 |=== | 2%, ETA 00:07 |=== | 2%, ETA 00:06 |=== | 2%, ETA 00:06 |==== | 3%, ETA 00:06 |==== | 3%, ETA 00:05 |==== | 3%, ETA 00:05 |==== | 3%, ETA 00:05 |===== | 3%, ETA 00:04 |===== | 4%, ETA 00:04 |===== | 4%, ETA 00:04 |===== | 4%, ETA 00:04 |====== | 4%, ETA 00:04 |====== | 4%, ETA 00:03 |====== | 5%, ETA 00:03 |====== | 5%, ETA 00:03 |======= | 5%, ETA 00:03 |======= | 5%, ETA 00:03 |======= | 5%, ETA 00:03 |======== | 6%, ETA 00:03 |======== | 6%, ETA 00:03 |======== | 6%, ETA 00:03 |======== | 6%, ETA 00:03 |========= | 6%, ETA 00:03 |========= | 7%, ETA 00:03 |========= | 7%, ETA 00:02 |========= | 7%, ETA 00:02 |========== | 7%, ETA 00:02 |========== | 7%, ETA 00:02 |========== | 8%, ETA 00:02 |=========== | 8%, ETA 00:02 |=========== | 8%, ETA 00:02 |=========== | 8%, ETA 00:02 |=========== | 8%, ETA 00:02 |============ | 9%, ETA 00:02 |============ | 9%, ETA 00:02 |============ | 9%, ETA 00:02 |============ | 9%, ETA 00:02 |============= | 9%, ETA 00:02 |============= | 10%, ETA 00:02 |============= | 10%, ETA 00:02 |============== | 10%, ETA 00:02 |============== | 10%, ETA 00:02 |============== | 10%, ETA 00:02 |============== | 11%, ETA 00:02 |=============== | 11%, ETA 00:02 |=============== | 11%, ETA 00:02 |=============== | 11%, ETA 00:02 |=============== | 11%, ETA 00:02 |================ | 12%, ETA 00:02 |================ | 12%, ETA 00:02 |================ | 12%, ETA 00:02 |================ | 12%, ETA 00:02 |================= | 12%, ETA 00:02 |================= | 13%, ETA 00:02 |================= | 13%, ETA 00:02 |================== | 13%, ETA 00:02 |================== | 13%, ETA 00:02 |================== | 13%, ETA 00:02 |================== | 14%, ETA 00:02 |=================== | 14%, ETA 00:02 |=================== | 14%, ETA 00:02 |=================== | 14%, ETA 00:02 |=================== | 14%, ETA 00:02 |==================== | 15%, ETA 00:02 |==================== | 15%, ETA 00:02 |==================== | 15%, ETA 00:02 |===================== | 15%, ETA 00:01 |===================== | 15%, ETA 00:01 |===================== | 16%, ETA 00:01 |===================== | 16%, ETA 00:01 |====================== | 16%, ETA 00:01 |====================== | 16%, ETA 00:01 |====================== | 16%, ETA 00:01 |====================== | 17%, ETA 00:01 |======================= | 17%, ETA 00:01 |======================= | 17%, ETA 00:01 |======================= | 17%, ETA 00:01 |======================= | 17%, ETA 00:01 |======================== | 18%, ETA 00:01 |======================== | 18%, ETA 00:01 |======================== | 18%, ETA 00:01 |========================= | 18%, ETA 00:01 |========================= | 18%, ETA 00:01 |========================= | 19%, ETA 00:01 |========================= | 19%, ETA 00:01 |========================== | 19%, ETA 00:01 |========================== | 19%, ETA 00:01 |========================== | 19%, ETA 00:01 |========================== | 20%, ETA 00:01 |=========================== | 20%, ETA 00:01 |=========================== | 20%, ETA 00:01 |=========================== | 20%, ETA 00:01 |============================ | 20%, ETA 00:01 |============================ | 21%, ETA 00:01 |============================ | 21%, ETA 00:01 |============================ | 21%, ETA 00:01 |============================= | 21%, ETA 00:01 |============================= | 21%, ETA 00:01 |============================= | 22%, ETA 00:01 |============================= | 22%, ETA 00:01 |============================== | 22%, ETA 00:01 |============================== | 22%, ETA 00:01 |============================== | 22%, ETA 00:01 |=============================== | 23%, ETA 00:01 |=============================== | 23%, ETA 00:01 |=============================== | 23%, ETA 00:01 |=============================== | 23%, ETA 00:01 |================================ | 23%, ETA 00:01 |================================ | 24%, ETA 00:01 |================================ | 24%, ETA 00:01 |================================ | 24%, ETA 00:01 |================================= | 24%, ETA 00:01 |================================= | 24%, ETA 00:01 |================================= | 25%, ETA 00:01 |================================= | 25%, ETA 00:01 |================================== | 25%, ETA 00:01 |================================== | 25%, ETA 00:01 |================================== | 25%, ETA 00:01 |=================================== | 26%, ETA 00:01 |=================================== | 26%, ETA 00:01 |=================================== | 26%, ETA 00:01 |=================================== | 26%, ETA 00:01 |==================================== | 26%, ETA 00:01 |==================================== | 27%, ETA 00:01 |==================================== | 27%, ETA 00:01 |==================================== | 27%, ETA 00:01 |===================================== | 27%, ETA 00:01 |===================================== | 27%, ETA 00:01 |===================================== | 28%, ETA 00:01 |====================================== | 28%, ETA 00:01 |====================================== | 28%, ETA 00:01 |====================================== | 28%, ETA 00:01 |====================================== | 28%, ETA 00:01 |======================================= | 29%, ETA 00:01 |======================================= | 29%, ETA 00:01 |======================================= | 29%, ETA 00:01 |======================================= | 29%, ETA 00:01 |======================================== | 29%, ETA 00:01 |======================================== | 30%, ETA 00:01 |======================================== | 30%, ETA 00:01 |======================================== | 30%, ETA 00:01 |========================================= | 30%, ETA 00:01 |========================================= | 30%, ETA 00:01 |========================================= | 31%, ETA 00:01 |========================================== | 31%, ETA 00:01 |========================================== | 31%, ETA 00:01 |========================================== | 31%, ETA 00:01 |========================================== | 31%, ETA 00:01 |=========================================== | 32%, ETA 00:01 |=========================================== | 32%, ETA 00:01 |=========================================== | 32%, ETA 00:01 |=========================================== | 32%, ETA 00:01 |============================================ | 32%, ETA 00:01 |============================================ | 33%, ETA 00:01 |============================================ | 33%, ETA 00:01 |============================================= | 33%, ETA 00:01 |============================================= | 33%, ETA 00:01 |============================================= | 33%, ETA 00:01 |============================================= | 34%, ETA 00:01 |============================================== | 34%, ETA 00:01 |============================================== | 34%, ETA 00:01 |============================================== | 34%, ETA 00:01 |============================================== | 34%, ETA 00:01 |=============================================== | 35%, ETA 00:01 |=============================================== | 35%, ETA 00:01 |=============================================== | 35%, ETA 00:01 |================================================ | 35%, ETA 00:01 |================================================ | 35%, ETA 00:01 |================================================ | 36%, ETA 00:01 |================================================ | 36%, ETA 00:01 |================================================= | 36%, ETA 00:01 |================================================= | 36%, ETA 00:01 |================================================= | 36%, ETA 00:01 |================================================= | 37%, ETA 00:01 |================================================== | 37%, ETA 00:01 |================================================== | 37%, ETA 00:01 |================================================== | 37%, ETA 00:01 |================================================== | 37%, ETA 00:01 |=================================================== | 38%, ETA 00:01 |=================================================== | 38%, ETA 00:01 |=================================================== | 38%, ETA 00:01 |==================================================== | 38%, ETA 00:01 |==================================================== | 38%, ETA 00:01 |==================================================== | 39%, ETA 00:01 |==================================================== | 39%, ETA 00:01 |===================================================== | 39%, ETA 00:01 |===================================================== | 39%, ETA 00:01 |===================================================== | 39%, ETA 00:01 |===================================================== | 40%, ETA 00:01 |====================================================== | 40%, ETA 00:01 |====================================================== | 40%, ETA 00:01 |====================================================== | 40%, ETA 00:01 |======================================================= | 40%, ETA 00:01 |======================================================= | 41%, ETA 00:01 |======================================================= | 41%, ETA 00:01 |======================================================= | 41%, ETA 00:01 |======================================================== | 41%, ETA 00:01 |======================================================== | 41%, ETA 00:01 |======================================================== | 42%, ETA 00:01 |======================================================== | 42%, ETA 00:01 |========================================================= | 42%, ETA 00:01 |========================================================= | 42%, ETA 00:01 |========================================================= | 42%, ETA 00:01 |========================================================== | 43%, ETA 00:01 |========================================================== | 43%, ETA 00:01 |========================================================== | 43%, ETA 00:01 |========================================================== | 43%, ETA 00:01 |=========================================================== | 43%, ETA 00:01 |=========================================================== | 44%, ETA 00:01 |=========================================================== | 44%, ETA 00:01 |=========================================================== | 44%, ETA 00:01 |============================================================ | 44%, ETA 00:01 |============================================================ | 44%, ETA 00:01 |============================================================ | 45%, ETA 00:01 |============================================================ | 45%, ETA 00:01 |============================================================= | 45%, ETA 00:01 |============================================================= | 45%, ETA 00:01 |============================================================= | 45%, ETA 00:01 |============================================================== | 46%, ETA 00:01 |============================================================== | 46%, ETA 00:01 |============================================================== | 46%, ETA 00:01 |============================================================== | 46%, ETA 00:01 |=============================================================== | 46%, ETA 00:01 |=============================================================== | 47%, ETA 00:01 |=============================================================== | 47%, ETA 00:01 |=============================================================== | 47%, ETA 00:01 |================================================================ | 47%, ETA 00:01 |================================================================ | 47%, ETA 00:01 |================================================================ | 48%, ETA 00:01 |================================================================= | 48%, ETA 00:01 |================================================================= | 48%, ETA 00:01 |================================================================= | 48%, ETA 00:01 |================================================================= | 48%, ETA 00:01 |================================================================== | 49%, ETA 00:01 |================================================================== | 49%, ETA 00:01 |================================================================== | 49%, ETA 00:01 |================================================================== | 49%, ETA 00:01 |=================================================================== | 49%, ETA 00:01 |=================================================================== | 50%, ETA 00:01 |=================================================================== | 50%, ETA 00:01 |==================================================================== | 50%, ETA 00:01 |==================================================================== | 50%, ETA 00:01 |==================================================================== | 50%, ETA 00:01 |==================================================================== | 51%, ETA 00:01 |===================================================================== | 51%, ETA 00:01 |===================================================================== | 51%, ETA 00:01 |===================================================================== | 51%, ETA 00:01 |===================================================================== | 51%, ETA 00:01 |====================================================================== | 52%, ETA 00:01 |====================================================================== | 52%, ETA 00:01 |====================================================================== | 52%, ETA 00:01 |====================================================================== | 52%, ETA 00:01 |======================================================================= | 52%, ETA 00:01 |======================================================================= | 53%, ETA 00:01 |======================================================================= | 53%, ETA 00:01 |======================================================================== | 53%, ETA 00:01 |======================================================================== | 53%, ETA 00:01 |======================================================================== | 53%, ETA 00:01 |======================================================================== | 54%, ETA 00:01 |========================================================================= | 54%, ETA 00:01 |========================================================================= | 54%, ETA 00:01 |========================================================================= | 54%, ETA 00:01 |========================================================================= | 54%, ETA 00:01 |========================================================================== | 55%, ETA 00:01 |========================================================================== | 55%, ETA 00:01 |========================================================================== | 55%, ETA 00:01 |=========================================================================== | 55%, ETA 00:01 |=========================================================================== | 55%, ETA 00:01 |=========================================================================== | 56%, ETA 00:01 |=========================================================================== | 56%, ETA 00:01 |============================================================================ | 56%, ETA 00:01 |============================================================================ | 56%, ETA 00:01 |============================================================================ | 56%, ETA 00:01 |============================================================================ | 57%, ETA 00:01 |============================================================================= | 57%, ETA 00:01 |============================================================================= | 57%, ETA 00:00 |============================================================================= | 57%, ETA 00:00 |============================================================================= | 57%, ETA 00:00 |============================================================================== | 58%, ETA 00:00 |============================================================================== | 58%, ETA 00:00 |============================================================================== | 58%, ETA 00:00 |=============================================================================== | 58%, ETA 00:00 |=============================================================================== | 58%, ETA 00:00 |=============================================================================== | 59%, ETA 00:00 |=============================================================================== | 59%, ETA 00:00 |================================================================================ | 59%, ETA 00:00 |================================================================================ | 59%, ETA 00:00 |================================================================================ | 59%, ETA 00:00 |================================================================================ | 60%, ETA 00:00 |================================================================================= | 60%, ETA 00:00 |================================================================================= | 60%, ETA 00:00 |================================================================================= | 60%, ETA 00:00 |================================================================================== | 60%, ETA 00:00 |================================================================================== | 61%, ETA 00:00 |================================================================================== | 61%, ETA 00:00 |================================================================================== | 61%, ETA 00:00 |=================================================================================== | 61%, ETA 00:00 |=================================================================================== | 61%, ETA 00:00 |=================================================================================== | 62%, ETA 00:00 |=================================================================================== | 62%, ETA 00:00 |==================================================================================== | 62%, ETA 00:00 |==================================================================================== | 62%, ETA 00:00 |==================================================================================== | 62%, ETA 00:00 |===================================================================================== | 63%, ETA 00:00 |===================================================================================== | 63%, ETA 00:00 |===================================================================================== | 63%, ETA 00:00 |===================================================================================== | 63%, ETA 00:00 |====================================================================================== | 63%, ETA 00:00 |====================================================================================== | 64%, ETA 00:00 |====================================================================================== | 64%, ETA 00:00 |====================================================================================== | 64%, ETA 00:00 |======================================================================================= | 64%, ETA 00:00 |======================================================================================= | 64%, ETA 00:00 |======================================================================================= | 65%, ETA 00:00 |======================================================================================= | 65%, ETA 00:00 |======================================================================================== | 65%, ETA 00:00 |======================================================================================== | 65%, ETA 00:00 |======================================================================================== | 65%, ETA 00:00 |========================================================================================= | 66%, ETA 00:00 |========================================================================================= | 66%, ETA 00:00 |========================================================================================= | 66%, ETA 00:00 |========================================================================================= | 66%, ETA 00:00 |========================================================================================== | 66%, ETA 00:00 |========================================================================================== | 67%, ETA 00:00 |========================================================================================== | 67%, ETA 00:00 |========================================================================================== | 67%, ETA 00:00 |=========================================================================================== | 67%, ETA 00:00 |=========================================================================================== | 67%, ETA 00:00 |=========================================================================================== | 68%, ETA 00:00 |============================================================================================ | 68%, ETA 00:00 |============================================================================================ | 68%, ETA 00:00 |============================================================================================ | 68%, ETA 00:00 |============================================================================================ | 68%, ETA 00:00 |============================================================================================= | 69%, ETA 00:00 |============================================================================================= | 69%, ETA 00:00 |============================================================================================= | 69%, ETA 00:00 |============================================================================================= | 69%, ETA 00:00 |============================================================================================== | 69%, ETA 00:00 |============================================================================================== | 70%, ETA 00:00 |============================================================================================== | 70%, ETA 00:00 |============================================================================================== | 70%, ETA 00:00 |=============================================================================================== | 70%, ETA 00:00 |=============================================================================================== | 70%, ETA 00:00 |=============================================================================================== | 71%, ETA 00:00 |================================================================================================ | 71%, ETA 00:00 |================================================================================================ | 71%, ETA 00:00 |================================================================================================ | 71%, ETA 00:00 |================================================================================================ | 71%, ETA 00:00 |================================================================================================= | 72%, ETA 00:00 |================================================================================================= | 72%, ETA 00:00 |================================================================================================= | 72%, ETA 00:00 |================================================================================================= | 72%, ETA 00:00 |================================================================================================== | 72%, ETA 00:00 |================================================================================================== | 73%, ETA 00:00 |================================================================================================== | 73%, ETA 00:00 |=================================================================================================== | 73%, ETA 00:00 |=================================================================================================== | 73%, ETA 00:00 |=================================================================================================== | 73%, ETA 00:00 |=================================================================================================== | 74%, ETA 00:00 |==================================================================================================== | 74%, ETA 00:00 |==================================================================================================== | 74%, ETA 00:00 |==================================================================================================== | 74%, ETA 00:00 |==================================================================================================== | 74%, ETA 00:00 |===================================================================================================== | 75%, ETA 00:00 |===================================================================================================== | 75%, ETA 00:00 |===================================================================================================== | 75%, ETA 00:00 |====================================================================================================== | 75%, ETA 00:00 |====================================================================================================== | 75%, ETA 00:00 |====================================================================================================== | 76%, ETA 00:00 |====================================================================================================== | 76%, ETA 00:00 |======================================================================================================= | 76%, ETA 00:00 |======================================================================================================= | 76%, ETA 00:00 |======================================================================================================= | 76%, ETA 00:00 |======================================================================================================= | 77%, ETA 00:00 |======================================================================================================== | 77%, ETA 00:00 |======================================================================================================== | 77%, ETA 00:00 |======================================================================================================== | 77%, ETA 00:00 |======================================================================================================== | 77%, ETA 00:00 |========================================================================================================= | 78%, ETA 00:00 |========================================================================================================= | 78%, ETA 00:00 |========================================================================================================= | 78%, ETA 00:00 |========================================================================================================== | 78%, ETA 00:00 |========================================================================================================== | 78%, ETA 00:00 |========================================================================================================== | 79%, ETA 00:00 |========================================================================================================== | 79%, ETA 00:00 |=========================================================================================================== | 79%, ETA 00:00 |=========================================================================================================== | 79%, ETA 00:00 |=========================================================================================================== | 79%, ETA 00:00 |=========================================================================================================== | 80%, ETA 00:00 |============================================================================================================ | 80%, ETA 00:00 |============================================================================================================ | 80%, ETA 00:00 |============================================================================================================ | 80%, ETA 00:00 |============================================================================================================= | 80%, ETA 00:00 |============================================================================================================= | 81%, ETA 00:00 |============================================================================================================= | 81%, ETA 00:00 |============================================================================================================= | 81%, ETA 00:00 |============================================================================================================== | 81%, ETA 00:00 |============================================================================================================== | 81%, ETA 00:00 |============================================================================================================== | 82%, ETA 00:00 |============================================================================================================== | 82%, ETA 00:00 |=============================================================================================================== | 82%, ETA 00:00 |=============================================================================================================== | 82%, ETA 00:00 |=============================================================================================================== | 82%, ETA 00:00 |================================================================================================================ | 83%, ETA 00:00 |================================================================================================================ | 83%, ETA 00:00 |================================================================================================================ | 83%, ETA 00:00 |================================================================================================================ | 83%, ETA 00:00 |================================================================================================================= | 83%, ETA 00:00 |================================================================================================================= | 84%, ETA 00:00 |================================================================================================================= | 84%, ETA 00:00 |================================================================================================================= | 84%, ETA 00:00 |================================================================================================================== | 84%, ETA 00:00 |================================================================================================================== | 84%, ETA 00:00 |================================================================================================================== | 85%, ETA 00:00 |================================================================================================================== | 85%, ETA 00:00 |=================================================================================================================== | 85%, ETA 00:00 |=================================================================================================================== | 85%, ETA 00:00 |=================================================================================================================== | 85%, ETA 00:00 |==================================================================================================================== | 86%, ETA 00:00 |==================================================================================================================== | 86%, ETA 00:00 |==================================================================================================================== | 86%, ETA 00:00 |==================================================================================================================== | 86%, ETA 00:00 |===================================================================================================================== | 86%, ETA 00:00 |===================================================================================================================== | 87%, ETA 00:00 |===================================================================================================================== | 87%, ETA 00:00 |===================================================================================================================== | 87%, ETA 00:00 |====================================================================================================================== | 87%, ETA 00:00 |====================================================================================================================== | 87%, ETA 00:00 |====================================================================================================================== | 88%, ETA 00:00 |======================================================================================================================== | 89%, ETA 00:00 |======================================================================================================================== | 89%, ETA 00:00 |======================================================================================================================== | 89%, ETA 00:00 |======================================================================================================================== | 89%, ETA 00:00 |========================================================================================================================= | 89%, ETA 00:00 |========================================================================================================================= | 90%, ETA 00:00 |========================================================================================================================= | 90%, ETA 00:00 |========================================================================================================================== | 90%, ETA 00:00 |========================================================================================================================== | 90%, ETA 00:00 |========================================================================================================================== | 90%, ETA 00:00 |========================================================================================================================== | 91%, ETA 00:00 |=========================================================================================================================== | 91%, ETA 00:00 |=========================================================================================================================== | 91%, ETA 00:00 |=========================================================================================================================== | 91%, ETA 00:00 |=========================================================================================================================== | 91%, ETA 00:00 |============================================================================================================================ | 92%, ETA 00:00 |============================================================================================================================ | 92%, ETA 00:00 |============================================================================================================================ | 92%, ETA 00:00 |============================================================================================================================ | 92%, ETA 00:00 |============================================================================================================================= | 92%, ETA 00:00 |============================================================================================================================= | 93%, ETA 00:00 |============================================================================================================================= | 93%, ETA 00:00 |============================================================================================================================== | 93%, ETA 00:00 |============================================================================================================================== | 93%, ETA 00:00 |============================================================================================================================== | 93%, ETA 00:00 |============================================================================================================================== | 94%, ETA 00:00 |=============================================================================================================================== | 94%, ETA 00:00 |=============================================================================================================================== | 94%, ETA 00:00 |=============================================================================================================================== | 94%, ETA 00:00 |=============================================================================================================================== | 94%, ETA 00:00 |================================================================================================================================ | 95%, ETA 00:00 |================================================================================================================================ | 95%, ETA 00:00 |================================================================================================================================ | 95%, ETA 00:00 |================================================================================================================================= | 95%, ETA 00:00 |================================================================================================================================= | 95%, ETA 00:00 |================================================================================================================================= | 96%, ETA 00:00 |================================================================================================================================= | 96%, ETA 00:00 |================================================================================================================================== | 96%, ETA 00:00 |================================================================================================================================== | 96%, ETA 00:00 |================================================================================================================================== | 96%, ETA 00:00 |================================================================================================================================== | 97%, ETA 00:00 |=================================================================================================================================== | 97%, ETA 00:00 |=================================================================================================================================== | 97%, ETA 00:00 |=================================================================================================================================== | 97%, ETA 00:00 |=================================================================================================================================== | 97%, ETA 00:00 |==================================================================================================================================== | 98%, ETA 00:00 |==================================================================================================================================== | 98%, ETA 00:00 |==================================================================================================================================== | 98%, ETA 00:00 |===================================================================================================================================== | 98%, ETA 00:00 |===================================================================================================================================== | 98%, ETA 00:00 |===================================================================================================================================== | 99%, ETA 00:00 |===================================================================================================================================== | 99%, ETA 00:00 |====================================================================================================================================== | 99%, ETA 00:00 |====================================================================================================================================== | 99%, ETA 00:00 |====================================================================================================================================== | 99%, ETA 00:00 |====================================================================================================================================== | 100%, ETA 00:00 |=======================================================================================================================================| 100%, ETA 00:00 |===================================================================================================================================| 100%, Elapsed 00:01 We can plot the trajectory and psedutime plot with the code bellow. From this example data we observe a trajectory that transitions from stem cells to to radial glial cells, and finally toward more mature neuronal sub types. This trajectory aligns with known biological transitions of cells undergoing neuronal differentiation. Code traj_res$plots$trajectory_and_pseudotime Given this biologically meaningful trajectory, we can examine genes whose expression changes are correlated with pseudotime. The function above returns this information in traj_res$MI_sig. Below are 12 top hits, selected from all tested features, that show strong and significant associations between expression and trajectory progression. We visualise these results using both a Seurat feature plot and a Monocle3 pseudotime gene-expression plot. Code traj_res$plots$top_genes_featureplot Code traj_res$plots$top_genes_pseudotime 11.2 Running pseudotime analysis on isoforms The same analysis can be performed at the isoform level by setting assay = \"iso\". This allows identification of isoforms whose expression is correlated with the trajectory. Users can also compute trajectories based on isoform-level clustering. We do not show this here, but if this is of interest, ensure that the isoform-level data are properly integrated and modify the function above to use the appropriate dimensional reduction method for trajectory learning. Code traj_iso_res &lt;- perform_trajectory_analysis(seurat_obj = obj, assay=&quot;iso&quot;, prefix = &quot;iso_Multi-sample_subsample_tutorial&quot;, cluster_name=&quot;cell_type&quot;, root_cells = NULL, cores = 8, order_features_by_pseudotime = TRUE, number_of_features = 1000) ## | | 0%, ETA NA | | 0%, ETA 01:45 | | 0%, ETA 00:53 | | 0%, ETA 00:36 |= | 0%, ETA 00:27 |= | 0%, ETA 00:22 |= | 1%, ETA 00:19 |= | 1%, ETA 00:16 |= | 1%, ETA 00:14 |= | 1%, ETA 00:13 |= | 1%, ETA 00:12 |= | 1%, ETA 00:11 |== | 1%, ETA 00:10 |== | 1%, ETA 00:09 |== | 1%, ETA 00:09 |== | 2%, ETA 00:08 |== | 2%, ETA 00:08 |== | 2%, ETA 00:07 |== | 2%, ETA 00:07 |=== | 2%, ETA 00:07 |=== | 2%, ETA 00:06 |=== | 2%, ETA 00:06 |=== | 2%, ETA 00:06 |=== | 2%, ETA 00:06 |=== | 2%, ETA 00:06 |=== | 2%, ETA 00:05 |=== | 3%, ETA 00:05 |==== | 3%, ETA 00:05 |==== | 3%, ETA 00:05 |==== | 3%, ETA 00:05 |==== | 3%, ETA 00:05 |==== | 3%, ETA 00:05 |==== | 3%, ETA 00:04 |==== | 3%, ETA 00:04 |===== | 3%, ETA 00:04 |===== | 4%, ETA 00:04 |===== | 4%, ETA 00:04 |===== | 4%, ETA 00:04 |===== | 4%, ETA 00:04 |===== | 4%, ETA 00:04 |===== | 4%, ETA 00:04 |===== | 4%, ETA 00:04 |====== | 4%, ETA 00:04 |====== | 4%, ETA 00:04 |====== | 4%, ETA 00:04 |====== | 4%, ETA 00:04 |====== | 5%, ETA 00:03 |====== | 5%, ETA 00:03 |====== | 5%, ETA 00:03 |======= | 5%, ETA 00:03 |======= | 5%, ETA 00:03 |======= | 5%, ETA 00:03 |======= | 5%, ETA 00:03 |======= | 5%, ETA 00:03 |======= | 5%, ETA 00:03 |======= | 6%, ETA 00:03 |======== | 6%, ETA 00:03 |======== | 6%, ETA 00:03 |======== | 6%, ETA 00:03 |======== | 6%, ETA 00:03 |======== | 6%, ETA 00:03 |======== | 6%, ETA 00:03 |======== | 6%, ETA 00:03 |======== | 6%, ETA 00:03 |========= | 6%, ETA 00:03 |========= | 6%, ETA 00:03 |========= | 7%, ETA 00:03 |========= | 7%, ETA 00:03 |========= | 7%, ETA 00:03 |========= | 7%, ETA 00:03 |========= | 7%, ETA 00:03 |========== | 7%, ETA 00:03 |========== | 7%, ETA 00:03 |========== | 7%, ETA 00:03 |========== | 7%, ETA 00:03 |========== | 8%, ETA 00:02 |========== | 8%, ETA 00:02 |========== | 8%, ETA 00:02 |========== | 8%, ETA 00:02 |=========== | 8%, ETA 00:02 |=========== | 8%, ETA 00:02 |=========== | 8%, ETA 00:02 |=========== | 8%, ETA 00:02 |=========== | 8%, ETA 00:02 |=========== | 8%, ETA 00:02 |=========== | 8%, ETA 00:02 |============ | 9%, ETA 00:02 |============ | 9%, ETA 00:02 |============ | 9%, ETA 00:02 |============ | 9%, ETA 00:02 |============ | 9%, ETA 00:02 |============ | 9%, ETA 00:02 |============ | 9%, ETA 00:02 |============ | 9%, ETA 00:02 |============= | 9%, ETA 00:02 |============= | 10%, ETA 00:02 |============= | 10%, ETA 00:02 |============= | 10%, ETA 00:02 |============= | 10%, ETA 00:02 |============= | 10%, ETA 00:02 |============= | 10%, ETA 00:02 |============== | 10%, ETA 00:02 |============== | 10%, ETA 00:02 |============== | 10%, ETA 00:02 |============== | 10%, ETA 00:02 |============== | 10%, ETA 00:02 |============== | 11%, ETA 00:02 |============== | 11%, ETA 00:02 |============== | 11%, ETA 00:02 |=============== | 11%, ETA 00:02 |=============== | 11%, ETA 00:02 |=============== | 11%, ETA 00:02 |=============== | 11%, ETA 00:02 |=============== | 11%, ETA 00:02 |=============== | 11%, ETA 00:02 |=============== | 12%, ETA 00:02 |================ | 12%, ETA 00:02 |================ | 12%, ETA 00:02 |================ | 12%, ETA 00:02 |================ | 12%, ETA 00:02 |================ | 12%, ETA 00:02 |================ | 12%, ETA 00:02 |================ | 12%, ETA 00:02 |================ | 12%, ETA 00:02 |================= | 12%, ETA 00:02 |================= | 12%, ETA 00:02 |================= | 13%, ETA 00:02 |================= | 13%, ETA 00:02 |================= | 13%, ETA 00:02 |================= | 13%, ETA 00:02 |================= | 13%, ETA 00:02 |================== | 13%, ETA 00:02 |================== | 13%, ETA 00:02 |================== | 13%, ETA 00:02 |================== | 13%, ETA 00:02 |================== | 14%, ETA 00:02 |================== | 14%, ETA 00:02 |================== | 14%, ETA 00:02 |================== | 14%, ETA 00:02 |=================== | 14%, ETA 00:02 |=================== | 14%, ETA 00:02 |=================== | 14%, ETA 00:01 |=================== | 14%, ETA 00:01 |=================== | 14%, ETA 00:01 |=================== | 14%, ETA 00:01 |=================== | 14%, ETA 00:01 |==================== | 15%, ETA 00:01 |==================== | 15%, ETA 00:01 |==================== | 15%, ETA 00:01 |==================== | 15%, ETA 00:01 |==================== | 15%, ETA 00:01 |==================== | 15%, ETA 00:01 |==================== | 15%, ETA 00:01 |===================== | 15%, ETA 00:01 |===================== | 15%, ETA 00:01 |===================== | 16%, ETA 00:01 |===================== | 16%, ETA 00:01 |===================== | 16%, ETA 00:01 |===================== | 16%, ETA 00:01 |===================== | 16%, ETA 00:01 |===================== | 16%, ETA 00:01 |====================== | 16%, ETA 00:01 |====================== | 16%, ETA 00:01 |====================== | 16%, ETA 00:01 |====================== | 16%, ETA 00:01 |====================== | 16%, ETA 00:01 |====================== | 17%, ETA 00:01 |====================== | 17%, ETA 00:01 |======================= | 17%, ETA 00:01 |======================= | 17%, ETA 00:01 |======================= | 17%, ETA 00:01 |======================= | 17%, ETA 00:01 |======================= | 17%, ETA 00:01 |======================= | 17%, ETA 00:01 |======================= | 17%, ETA 00:01 |======================= | 18%, ETA 00:01 |======================== | 18%, ETA 00:01 |======================== | 18%, ETA 00:01 |======================== | 18%, ETA 00:01 |======================== | 18%, ETA 00:01 |======================== | 18%, ETA 00:01 |======================== | 18%, ETA 00:01 |======================== | 18%, ETA 00:01 |========================= | 18%, ETA 00:01 |========================= | 18%, ETA 00:01 |========================= | 18%, ETA 00:01 |========================= | 19%, ETA 00:01 |========================= | 19%, ETA 00:01 |========================= | 19%, ETA 00:01 |========================= | 19%, ETA 00:01 |========================= | 19%, ETA 00:01 |========================== | 19%, ETA 00:01 |========================== | 19%, ETA 00:01 |========================== | 19%, ETA 00:01 |========================== | 19%, ETA 00:01 |========================== | 20%, ETA 00:01 |========================== | 20%, ETA 00:01 |========================== | 20%, ETA 00:01 |=========================== | 20%, ETA 00:01 |=========================== | 20%, ETA 00:01 |=========================== | 20%, ETA 00:01 |=========================== | 20%, ETA 00:01 |=========================== | 20%, ETA 00:01 |=========================== | 20%, ETA 00:01 |=========================== | 20%, ETA 00:01 |=========================== | 20%, ETA 00:01 |============================ | 21%, ETA 00:01 |============================ | 21%, ETA 00:01 |============================ | 21%, ETA 00:01 |============================ | 21%, ETA 00:01 |============================ | 21%, ETA 00:01 |============================ | 21%, ETA 00:01 |============================ | 21%, ETA 00:01 |============================= | 21%, ETA 00:01 |============================= | 21%, ETA 00:01 |============================= | 22%, ETA 00:01 |============================= | 22%, ETA 00:01 |============================= | 22%, ETA 00:01 |============================= | 22%, ETA 00:01 |============================= | 22%, ETA 00:01 |============================= | 22%, ETA 00:01 |============================== | 22%, ETA 00:01 |============================== | 22%, ETA 00:01 |============================== | 22%, ETA 00:01 |============================== | 22%, ETA 00:01 |============================== | 22%, ETA 00:01 |============================== | 23%, ETA 00:01 |============================== | 23%, ETA 00:01 |=============================== | 23%, ETA 00:01 |=============================== | 23%, ETA 00:01 |=============================== | 23%, ETA 00:01 |=============================== | 23%, ETA 00:01 |=============================== | 23%, ETA 00:01 |=============================== | 23%, ETA 00:01 |=============================== | 23%, ETA 00:01 |=============================== | 24%, ETA 00:01 |================================ | 24%, ETA 00:01 |================================ | 24%, ETA 00:01 |================================ | 24%, ETA 00:01 |================================ | 24%, ETA 00:01 |================================ | 24%, ETA 00:01 |================================ | 24%, ETA 00:01 |================================ | 24%, ETA 00:01 |================================= | 24%, ETA 00:01 |================================= | 24%, ETA 00:01 |================================= | 24%, ETA 00:01 |================================= | 25%, ETA 00:01 |================================= | 25%, ETA 00:01 |================================= | 25%, ETA 00:01 |================================= | 25%, ETA 00:01 |================================== | 25%, ETA 00:01 |================================== | 25%, ETA 00:01 |================================== | 25%, ETA 00:01 |================================== | 25%, ETA 00:01 |================================== | 25%, ETA 00:01 |================================== | 26%, ETA 00:01 |================================== | 26%, ETA 00:01 |================================== | 26%, ETA 00:01 |=================================== | 26%, ETA 00:01 |=================================== | 26%, ETA 00:01 |=================================== | 26%, ETA 00:01 |=================================== | 26%, ETA 00:01 |=================================== | 26%, ETA 00:01 |=================================== | 26%, ETA 00:01 |=================================== | 26%, ETA 00:01 |==================================== | 26%, ETA 00:01 |==================================== | 27%, ETA 00:01 |==================================== | 27%, ETA 00:01 |==================================== | 27%, ETA 00:01 |==================================== | 27%, ETA 00:01 |==================================== | 27%, ETA 00:01 |==================================== | 27%, ETA 00:01 |===================================== | 27%, ETA 00:01 |===================================== | 27%, ETA 00:01 |===================================== | 28%, ETA 00:01 |===================================== | 28%, ETA 00:01 |===================================== | 28%, ETA 00:01 |===================================== | 28%, ETA 00:01 |===================================== | 28%, ETA 00:01 |====================================== | 28%, ETA 00:01 |====================================== | 28%, ETA 00:01 |====================================== | 28%, ETA 00:01 |====================================== | 28%, ETA 00:01 |====================================== | 28%, ETA 00:01 |====================================== | 28%, ETA 00:01 |====================================== | 29%, ETA 00:01 |====================================== | 29%, ETA 00:01 |======================================= | 29%, ETA 00:01 |======================================= | 29%, ETA 00:01 |======================================= | 29%, ETA 00:01 |======================================= | 29%, ETA 00:01 |======================================= | 29%, ETA 00:01 |======================================= | 29%, ETA 00:01 |======================================= | 29%, ETA 00:01 |======================================== | 30%, ETA 00:01 |======================================== | 30%, ETA 00:01 |======================================== | 30%, ETA 00:01 |======================================== | 30%, ETA 00:01 |======================================== | 30%, ETA 00:01 |======================================== | 30%, ETA 00:01 |======================================== | 30%, ETA 00:01 |======================================== | 30%, ETA 00:01 |========================================= | 30%, ETA 00:01 |========================================= | 30%, ETA 00:01 |========================================= | 30%, ETA 00:01 |========================================= | 31%, ETA 00:01 |========================================= | 31%, ETA 00:01 |========================================= | 31%, ETA 00:01 |========================================= | 31%, ETA 00:01 |========================================== | 31%, ETA 00:01 |========================================== | 31%, ETA 00:01 |========================================== | 31%, ETA 00:01 |========================================== | 31%, ETA 00:01 |========================================== | 31%, ETA 00:01 |========================================== | 32%, ETA 00:01 |========================================== | 32%, ETA 00:01 |========================================== | 32%, ETA 00:01 |=========================================== | 32%, ETA 00:01 |=========================================== | 32%, ETA 00:01 |=========================================== | 32%, ETA 00:01 |=========================================== | 32%, ETA 00:01 |=========================================== | 32%, ETA 00:01 |=========================================== | 32%, ETA 00:01 |=========================================== | 32%, ETA 00:01 |============================================ | 32%, ETA 00:01 |============================================ | 33%, ETA 00:01 |============================================ | 33%, ETA 00:01 |============================================ | 33%, ETA 00:01 |============================================ | 33%, ETA 00:01 |============================================ | 33%, ETA 00:01 |============================================ | 33%, ETA 00:01 |============================================ | 33%, ETA 00:01 |============================================= | 33%, ETA 00:01 |============================================= | 33%, ETA 00:01 |============================================= | 34%, ETA 00:01 |============================================= | 34%, ETA 00:01 |============================================= | 34%, ETA 00:01 |============================================= | 34%, ETA 00:01 |============================================= | 34%, ETA 00:01 |============================================== | 34%, ETA 00:01 |============================================== | 34%, ETA 00:01 |============================================== | 34%, ETA 00:01 |============================================== | 34%, ETA 00:01 |============================================== | 34%, ETA 00:01 |============================================== | 34%, ETA 00:01 |============================================== | 35%, ETA 00:01 |============================================== | 35%, ETA 00:01 |=============================================== | 35%, ETA 00:01 |=============================================== | 35%, ETA 00:01 |=============================================== | 35%, ETA 00:01 |=============================================== | 35%, ETA 00:01 |=============================================== | 35%, ETA 00:01 |=============================================== | 35%, ETA 00:01 |=============================================== | 35%, ETA 00:01 |================================================ | 36%, ETA 00:01 |================================================ | 36%, ETA 00:01 |================================================ | 36%, ETA 00:01 |================================================ | 36%, ETA 00:01 |================================================ | 36%, ETA 00:01 |================================================ | 36%, ETA 00:01 |================================================ | 36%, ETA 00:01 |================================================= | 36%, ETA 00:01 |================================================= | 36%, ETA 00:01 |================================================= | 36%, ETA 00:01 |================================================= | 36%, ETA 00:01 |================================================= | 37%, ETA 00:01 |================================================= | 37%, ETA 00:01 |================================================= | 37%, ETA 00:01 |================================================= | 37%, ETA 00:01 |================================================== | 37%, ETA 00:01 |================================================== | 37%, ETA 00:01 |================================================== | 37%, ETA 00:01 |================================================== | 37%, ETA 00:01 |================================================== | 37%, ETA 00:01 |================================================== | 38%, ETA 00:01 |================================================== | 38%, ETA 00:01 |=================================================== | 38%, ETA 00:01 |=================================================== | 38%, ETA 00:01 |=================================================== | 38%, ETA 00:01 |=================================================== | 38%, ETA 00:01 |=================================================== | 38%, ETA 00:01 |=================================================== | 38%, ETA 00:01 |=================================================== | 38%, ETA 00:01 |=================================================== | 38%, ETA 00:01 |==================================================== | 38%, ETA 00:01 |==================================================== | 39%, ETA 00:01 |==================================================== | 39%, ETA 00:01 |==================================================== | 39%, ETA 00:01 |==================================================== | 39%, ETA 00:01 |==================================================== | 39%, ETA 00:01 |==================================================== | 39%, ETA 00:01 |===================================================== | 39%, ETA 00:01 |===================================================== | 39%, ETA 00:01 |===================================================== | 39%, ETA 00:01 |===================================================== | 40%, ETA 00:01 |===================================================== | 40%, ETA 00:01 |===================================================== | 40%, ETA 00:01 |===================================================== | 40%, ETA 00:01 |===================================================== | 40%, ETA 00:01 |====================================================== | 40%, ETA 00:01 |====================================================== | 40%, ETA 00:01 |====================================================== | 40%, ETA 00:01 |====================================================== | 40%, ETA 00:01 |====================================================== | 40%, ETA 00:01 |====================================================== | 40%, ETA 00:01 |====================================================== | 41%, ETA 00:01 |======================================================= | 41%, ETA 00:01 |======================================================= | 41%, ETA 00:01 |======================================================= | 41%, ETA 00:01 |======================================================= | 41%, ETA 00:01 |======================================================= | 41%, ETA 00:01 |======================================================= | 41%, ETA 00:01 |======================================================= | 41%, ETA 00:01 |======================================================= | 41%, ETA 00:01 |======================================================== | 42%, ETA 00:01 |======================================================== | 42%, ETA 00:01 |======================================================== | 42%, ETA 00:01 |======================================================== | 42%, ETA 00:01 |======================================================== | 42%, ETA 00:01 |======================================================== | 42%, ETA 00:01 |======================================================== | 42%, ETA 00:01 |========================================================= | 42%, ETA 00:01 |========================================================= | 42%, ETA 00:01 |========================================================= | 42%, ETA 00:01 |========================================================= | 42%, ETA 00:01 |========================================================= | 43%, ETA 00:01 |========================================================= | 43%, ETA 00:01 |========================================================= | 43%, ETA 00:01 |========================================================= | 43%, ETA 00:01 |========================================================== | 43%, ETA 00:01 |========================================================== | 43%, ETA 00:01 |========================================================== | 43%, ETA 00:01 |========================================================== | 43%, ETA 00:01 |========================================================== | 43%, ETA 00:01 |========================================================== | 44%, ETA 00:01 |========================================================== | 44%, ETA 00:01 |=========================================================== | 44%, ETA 00:01 |=========================================================== | 44%, ETA 00:01 |=========================================================== | 44%, ETA 00:01 |=========================================================== | 44%, ETA 00:01 |=========================================================== | 44%, ETA 00:01 |=========================================================== | 44%, ETA 00:01 |=========================================================== | 44%, ETA 00:01 |=========================================================== | 44%, ETA 00:01 |============================================================ | 44%, ETA 00:01 |============================================================ | 45%, ETA 00:01 |============================================================ | 45%, ETA 00:01 |============================================================ | 45%, ETA 00:01 |============================================================ | 45%, ETA 00:01 |============================================================ | 45%, ETA 00:01 |============================================================ | 45%, ETA 00:01 |============================================================= | 45%, ETA 00:01 |============================================================= | 45%, ETA 00:01 |============================================================= | 45%, ETA 00:01 |============================================================= | 46%, ETA 00:01 |============================================================= | 46%, ETA 00:01 |============================================================= | 46%, ETA 00:01 |============================================================= | 46%, ETA 00:01 |============================================================== | 46%, ETA 00:01 |============================================================== | 46%, ETA 00:01 |============================================================== | 46%, ETA 00:01 |============================================================== | 46%, ETA 00:01 |============================================================== | 46%, ETA 00:01 |============================================================== | 46%, ETA 00:01 |============================================================== | 46%, ETA 00:01 |============================================================== | 47%, ETA 00:01 |=============================================================== | 47%, ETA 00:01 |=============================================================== | 47%, ETA 00:01 |=============================================================== | 47%, ETA 00:01 |=============================================================== | 47%, ETA 00:01 |=============================================================== | 47%, ETA 00:01 |=============================================================== | 47%, ETA 00:01 |=============================================================== | 47%, ETA 00:01 |================================================================ | 47%, ETA 00:01 |================================================================ | 48%, ETA 00:01 |================================================================ | 48%, ETA 00:01 |================================================================ | 48%, ETA 00:01 |================================================================ | 48%, ETA 00:01 |================================================================ | 48%, ETA 00:01 |================================================================ | 48%, ETA 00:01 |================================================================ | 48%, ETA 00:01 |================================================================= | 48%, ETA 00:01 |================================================================= | 48%, ETA 00:01 |================================================================= | 48%, ETA 00:01 |================================================================= | 48%, ETA 00:01 |================================================================= | 49%, ETA 00:01 |================================================================= | 49%, ETA 00:01 |================================================================= | 49%, ETA 00:01 |================================================================== | 49%, ETA 00:01 |================================================================== | 49%, ETA 00:01 |================================================================== | 49%, ETA 00:01 |================================================================== | 49%, ETA 00:01 |================================================================== | 49%, ETA 00:01 |================================================================== | 49%, ETA 00:01 |================================================================== | 50%, ETA 00:01 |================================================================== | 50%, ETA 00:01 |=================================================================== | 50%, ETA 00:01 |=================================================================== | 50%, ETA 00:01 |=================================================================== | 50%, ETA 00:01 |=================================================================== | 50%, ETA 00:01 |=================================================================== | 50%, ETA 00:01 |=================================================================== | 50%, ETA 00:01 |=================================================================== | 50%, ETA 00:01 |==================================================================== | 50%, ETA 00:01 |==================================================================== | 50%, ETA 00:01 |==================================================================== | 51%, ETA 00:01 |==================================================================== | 51%, ETA 00:01 |==================================================================== | 51%, ETA 00:01 |==================================================================== | 51%, ETA 00:01 |==================================================================== | 51%, ETA 00:01 |==================================================================== | 51%, ETA 00:01 |===================================================================== | 51%, ETA 00:01 |===================================================================== | 51%, ETA 00:01 |===================================================================== | 51%, ETA 00:01 |===================================================================== | 52%, ETA 00:00 |===================================================================== | 52%, ETA 00:00 |===================================================================== | 52%, ETA 00:00 |===================================================================== | 52%, ETA 00:00 |====================================================================== | 52%, ETA 00:00 |====================================================================== | 52%, ETA 00:00 |====================================================================== | 52%, ETA 00:00 |====================================================================== | 52%, ETA 00:00 |====================================================================== | 52%, ETA 00:00 |====================================================================== | 52%, ETA 00:00 |====================================================================== | 52%, ETA 00:00 |====================================================================== | 53%, ETA 00:00 |======================================================================= | 53%, ETA 00:00 |======================================================================= | 53%, ETA 00:00 |======================================================================= | 53%, ETA 00:00 |======================================================================= | 53%, ETA 00:00 |======================================================================= | 53%, ETA 00:00 |======================================================================= | 53%, ETA 00:00 |======================================================================= | 53%, ETA 00:00 |======================================================================== | 53%, ETA 00:00 |======================================================================== | 54%, ETA 00:00 |======================================================================== | 54%, ETA 00:00 |======================================================================== | 54%, ETA 00:00 |======================================================================== | 54%, ETA 00:00 |======================================================================== | 54%, ETA 00:00 |======================================================================== | 54%, ETA 00:00 |======================================================================== | 54%, ETA 00:00 |========================================================================= | 54%, ETA 00:00 |========================================================================= | 54%, ETA 00:00 |========================================================================= | 54%, ETA 00:00 |========================================================================= | 55%, ETA 00:00 |========================================================================= | 55%, ETA 00:00 |========================================================================= | 55%, ETA 00:00 |========================================================================= | 55%, ETA 00:00 |========================================================================== | 55%, ETA 00:00 |========================================================================== | 55%, ETA 00:00 |========================================================================== | 55%, ETA 00:00 |========================================================================== | 55%, ETA 00:00 |========================================================================== | 55%, ETA 00:00 |========================================================================== | 55%, ETA 00:00 |========================================================================== | 56%, ETA 00:00 |=========================================================================== | 56%, ETA 00:00 |=========================================================================== | 56%, ETA 00:00 |=========================================================================== | 56%, ETA 00:00 |=========================================================================== | 56%, ETA 00:00 |=========================================================================== | 56%, ETA 00:00 |=========================================================================== | 56%, ETA 00:00 |=========================================================================== | 56%, ETA 00:00 |=========================================================================== | 56%, ETA 00:00 |============================================================================ | 56%, ETA 00:00 |============================================================================ | 56%, ETA 00:00 |============================================================================ | 57%, ETA 00:00 |============================================================================ | 57%, ETA 00:00 |============================================================================ | 57%, ETA 00:00 |============================================================================ | 57%, ETA 00:00 |============================================================================ | 57%, ETA 00:00 |============================================================================= | 57%, ETA 00:00 |============================================================================= | 57%, ETA 00:00 |============================================================================= | 57%, ETA 00:00 |============================================================================= | 57%, ETA 00:00 |============================================================================= | 57%, ETA 00:00 |============================================================================= | 58%, ETA 00:00 |============================================================================= | 58%, ETA 00:00 |============================================================================= | 58%, ETA 00:00 |============================================================================== | 58%, ETA 00:00 |============================================================================== | 58%, ETA 00:00 |============================================================================== | 58%, ETA 00:00 |============================================================================== | 58%, ETA 00:00 |============================================================================== | 58%, ETA 00:00 |============================================================================== | 58%, ETA 00:00 |============================================================================== | 58%, ETA 00:00 |=============================================================================== | 59%, ETA 00:00 |=============================================================================== | 59%, ETA 00:00 |=============================================================================== | 59%, ETA 00:00 |=============================================================================== | 59%, ETA 00:00 |=============================================================================== | 59%, ETA 00:00 |=============================================================================== | 59%, ETA 00:00 |=============================================================================== | 59%, ETA 00:00 |=============================================================================== | 59%, ETA 00:00 |================================================================================ | 59%, ETA 00:00 |================================================================================ | 60%, ETA 00:00 |================================================================================ | 60%, ETA 00:00 |================================================================================ | 60%, ETA 00:00 |================================================================================ | 60%, ETA 00:00 |================================================================================ | 60%, ETA 00:00 |================================================================================ | 60%, ETA 00:00 |================================================================================= | 60%, ETA 00:00 |================================================================================= | 60%, ETA 00:00 |================================================================================= | 60%, ETA 00:00 |================================================================================= | 60%, ETA 00:00 |================================================================================= | 60%, ETA 00:00 |================================================================================= | 61%, ETA 00:00 |================================================================================= | 61%, ETA 00:00 |================================================================================= | 61%, ETA 00:00 |================================================================================== | 61%, ETA 00:00 |================================================================================== | 61%, ETA 00:00 |================================================================================== | 61%, ETA 00:00 |================================================================================== | 61%, ETA 00:00 |================================================================================== | 61%, ETA 00:00 |================================================================================== | 61%, ETA 00:00 |================================================================================== | 62%, ETA 00:00 |=================================================================================== | 62%, ETA 00:00 |=================================================================================== | 62%, ETA 00:00 |=================================================================================== | 62%, ETA 00:00 |=================================================================================== | 62%, ETA 00:00 |=================================================================================== | 62%, ETA 00:00 |=================================================================================== | 62%, ETA 00:00 |=================================================================================== | 62%, ETA 00:00 |=================================================================================== | 62%, ETA 00:00 |==================================================================================== | 62%, ETA 00:00 |==================================================================================== | 62%, ETA 00:00 |==================================================================================== | 63%, ETA 00:00 |==================================================================================== | 63%, ETA 00:00 |==================================================================================== | 63%, ETA 00:00 |==================================================================================== | 63%, ETA 00:00 |==================================================================================== | 63%, ETA 00:00 |===================================================================================== | 63%, ETA 00:00 |===================================================================================== | 63%, ETA 00:00 |===================================================================================== | 63%, ETA 00:00 |===================================================================================== | 63%, ETA 00:00 |===================================================================================== | 64%, ETA 00:00 |===================================================================================== | 64%, ETA 00:00 |===================================================================================== | 64%, ETA 00:00 |===================================================================================== | 64%, ETA 00:00 |====================================================================================== | 64%, ETA 00:00 |====================================================================================== | 64%, ETA 00:00 |====================================================================================== | 64%, ETA 00:00 |====================================================================================== | 64%, ETA 00:00 |====================================================================================== | 64%, ETA 00:00 |====================================================================================== | 64%, ETA 00:00 |====================================================================================== | 64%, ETA 00:00 |======================================================================================= | 65%, ETA 00:00 |======================================================================================= | 65%, ETA 00:00 |======================================================================================= | 65%, ETA 00:00 |======================================================================================= | 65%, ETA 00:00 |======================================================================================= | 65%, ETA 00:00 |======================================================================================= | 65%, ETA 00:00 |======================================================================================= | 65%, ETA 00:00 |======================================================================================== | 65%, ETA 00:00 |======================================================================================== | 65%, ETA 00:00 |======================================================================================== | 66%, ETA 00:00 |======================================================================================== | 66%, ETA 00:00 |======================================================================================== | 66%, ETA 00:00 |======================================================================================== | 66%, ETA 00:00 |======================================================================================== | 66%, ETA 00:00 |======================================================================================== | 66%, ETA 00:00 |========================================================================================= | 66%, ETA 00:00 |========================================================================================= | 66%, ETA 00:00 |========================================================================================= | 66%, ETA 00:00 |========================================================================================= | 66%, ETA 00:00 |========================================================================================= | 66%, ETA 00:00 |========================================================================================= | 67%, ETA 00:00 |========================================================================================= | 67%, ETA 00:00 |========================================================================================== | 67%, ETA 00:00 |========================================================================================== | 67%, ETA 00:00 |========================================================================================== | 67%, ETA 00:00 |========================================================================================== | 67%, ETA 00:00 |========================================================================================== | 67%, ETA 00:00 |========================================================================================== | 67%, ETA 00:00 |========================================================================================== | 67%, ETA 00:00 |========================================================================================== | 68%, ETA 00:00 |=========================================================================================== | 68%, ETA 00:00 |=========================================================================================== | 68%, ETA 00:00 |=========================================================================================== | 68%, ETA 00:00 |=========================================================================================== | 68%, ETA 00:00 |=========================================================================================== | 68%, ETA 00:00 |=========================================================================================== | 68%, ETA 00:00 |=========================================================================================== | 68%, ETA 00:00 |============================================================================================ | 68%, ETA 00:00 |============================================================================================ | 68%, ETA 00:00 |============================================================================================ | 68%, ETA 00:00 |============================================================================================ | 69%, ETA 00:00 |============================================================================================ | 69%, ETA 00:00 |============================================================================================ | 69%, ETA 00:00 |============================================================================================ | 69%, ETA 00:00 |============================================================================================ | 69%, ETA 00:00 |============================================================================================= | 69%, ETA 00:00 |============================================================================================= | 69%, ETA 00:00 |============================================================================================= | 69%, ETA 00:00 |============================================================================================= | 69%, ETA 00:00 |============================================================================================= | 70%, ETA 00:00 |============================================================================================= | 70%, ETA 00:00 |============================================================================================= | 70%, ETA 00:00 |============================================================================================== | 70%, ETA 00:00 |============================================================================================== | 70%, ETA 00:00 |============================================================================================== | 70%, ETA 00:00 |============================================================================================== | 70%, ETA 00:00 |============================================================================================== | 70%, ETA 00:00 |============================================================================================== | 70%, ETA 00:00 |============================================================================================== | 70%, ETA 00:00 |============================================================================================== | 70%, ETA 00:00 |=============================================================================================== | 71%, ETA 00:00 |=============================================================================================== | 71%, ETA 00:00 |=============================================================================================== | 71%, ETA 00:00 |=============================================================================================== | 71%, ETA 00:00 |=============================================================================================== | 71%, ETA 00:00 |=============================================================================================== | 71%, ETA 00:00 |=============================================================================================== | 71%, ETA 00:00 |================================================================================================ | 71%, ETA 00:00 |================================================================================================ | 71%, ETA 00:00 |================================================================================================ | 72%, ETA 00:00 |================================================================================================ | 72%, ETA 00:00 |================================================================================================ | 72%, ETA 00:00 |================================================================================================ | 72%, ETA 00:00 |================================================================================================ | 72%, ETA 00:00 |================================================================================================ | 72%, ETA 00:00 |================================================================================================= | 72%, ETA 00:00 |================================================================================================= | 72%, ETA 00:00 |================================================================================================= | 72%, ETA 00:00 |================================================================================================= | 72%, ETA 00:00 |================================================================================================= | 72%, ETA 00:00 |================================================================================================= | 73%, ETA 00:00 |================================================================================================= | 73%, ETA 00:00 |================================================================================================== | 73%, ETA 00:00 |================================================================================================== | 73%, ETA 00:00 |================================================================================================== | 73%, ETA 00:00 |================================================================================================== | 73%, ETA 00:00 |================================================================================================== | 73%, ETA 00:00 |================================================================================================== | 73%, ETA 00:00 |================================================================================================== | 73%, ETA 00:00 |================================================================================================== | 74%, ETA 00:00 |=================================================================================================== | 74%, ETA 00:00 |=================================================================================================== | 74%, ETA 00:00 |=================================================================================================== | 74%, ETA 00:00 |=================================================================================================== | 74%, ETA 00:00 |=================================================================================================== | 74%, ETA 00:00 |=================================================================================================== | 74%, ETA 00:00 |=================================================================================================== | 74%, ETA 00:00 |==================================================================================================== | 74%, ETA 00:00 |==================================================================================================== | 74%, ETA 00:00 |==================================================================================================== | 74%, ETA 00:00 |==================================================================================================== | 75%, ETA 00:00 |==================================================================================================== | 75%, ETA 00:00 |==================================================================================================== | 75%, ETA 00:00 |==================================================================================================== | 75%, ETA 00:00 |==================================================================================================== | 75%, ETA 00:00 |===================================================================================================== | 75%, ETA 00:00 |===================================================================================================== | 75%, ETA 00:00 |===================================================================================================== | 75%, ETA 00:00 |===================================================================================================== | 75%, ETA 00:00 |===================================================================================================== | 76%, ETA 00:00 |===================================================================================================== | 76%, ETA 00:00 |===================================================================================================== | 76%, ETA 00:00 |====================================================================================================== | 76%, ETA 00:00 |====================================================================================================== | 76%, ETA 00:00 |====================================================================================================== | 76%, ETA 00:00 |====================================================================================================== | 76%, ETA 00:00 |====================================================================================================== | 76%, ETA 00:00 |====================================================================================================== | 76%, ETA 00:00 |====================================================================================================== | 76%, ETA 00:00 |======================================================================================================= | 76%, ETA 00:00 |======================================================================================================= | 77%, ETA 00:00 |======================================================================================================= | 77%, ETA 00:00 |======================================================================================================= | 77%, ETA 00:00 |======================================================================================================= | 77%, ETA 00:00 |======================================================================================================= | 77%, ETA 00:00 |======================================================================================================= | 77%, ETA 00:00 |======================================================================================================= | 77%, ETA 00:00 |======================================================================================================== | 77%, ETA 00:00 |======================================================================================================== | 77%, ETA 00:00 |======================================================================================================== | 78%, ETA 00:00 |======================================================================================================== | 78%, ETA 00:00 |======================================================================================================== | 78%, ETA 00:00 |======================================================================================================== | 78%, ETA 00:00 |======================================================================================================== | 78%, ETA 00:00 |========================================================================================================= | 78%, ETA 00:00 |========================================================================================================= | 78%, ETA 00:00 |========================================================================================================= | 78%, ETA 00:00 |========================================================================================================= | 78%, ETA 00:00 |========================================================================================================= | 78%, ETA 00:00 |========================================================================================================= | 78%, ETA 00:00 |========================================================================================================= | 79%, ETA 00:00 |========================================================================================================= | 79%, ETA 00:00 |========================================================================================================== | 79%, ETA 00:00 |========================================================================================================== | 79%, ETA 00:00 |========================================================================================================== | 79%, ETA 00:00 |========================================================================================================== | 79%, ETA 00:00 |========================================================================================================== | 79%, ETA 00:00 |========================================================================================================== | 79%, ETA 00:00 |========================================================================================================== | 79%, ETA 00:00 |=========================================================================================================== | 80%, ETA 00:00 |=========================================================================================================== | 80%, ETA 00:00 |=========================================================================================================== | 80%, ETA 00:00 |=========================================================================================================== | 80%, ETA 00:00 |=========================================================================================================== | 80%, ETA 00:00 |=========================================================================================================== | 80%, ETA 00:00 |=========================================================================================================== | 80%, ETA 00:00 |=========================================================================================================== | 80%, ETA 00:00 |============================================================================================================ | 80%, ETA 00:00 |============================================================================================================ | 80%, ETA 00:00 |============================================================================================================ | 80%, ETA 00:00 |============================================================================================================ | 81%, ETA 00:00 |============================================================================================================ | 81%, ETA 00:00 |============================================================================================================ | 81%, ETA 00:00 |============================================================================================================ | 81%, ETA 00:00 |============================================================================================================= | 81%, ETA 00:00 |============================================================================================================= | 81%, ETA 00:00 |============================================================================================================= | 81%, ETA 00:00 |============================================================================================================= | 81%, ETA 00:00 |============================================================================================================= | 81%, ETA 00:00 |============================================================================================================= | 82%, ETA 00:00 |============================================================================================================= | 82%, ETA 00:00 |============================================================================================================= | 82%, ETA 00:00 |============================================================================================================== | 82%, ETA 00:00 |============================================================================================================== | 82%, ETA 00:00 |============================================================================================================== | 82%, ETA 00:00 |============================================================================================================== | 82%, ETA 00:00 |============================================================================================================== | 82%, ETA 00:00 |============================================================================================================== | 82%, ETA 00:00 |============================================================================================================== | 82%, ETA 00:00 |=============================================================================================================== | 82%, ETA 00:00 |=============================================================================================================== | 83%, ETA 00:00 |=============================================================================================================== | 83%, ETA 00:00 |=============================================================================================================== | 83%, ETA 00:00 |=============================================================================================================== | 83%, ETA 00:00 |=============================================================================================================== | 83%, ETA 00:00 |=============================================================================================================== | 83%, ETA 00:00 |=============================================================================================================== | 83%, ETA 00:00 |================================================================================================================ | 83%, ETA 00:00 |================================================================================================================ | 83%, ETA 00:00 |================================================================================================================ | 84%, ETA 00:00 |================================================================================================================ | 84%, ETA 00:00 |================================================================================================================ | 84%, ETA 00:00 |================================================================================================================ | 84%, ETA 00:00 |================================================================================================================ | 84%, ETA 00:00 |================================================================================================================= | 84%, ETA 00:00 |================================================================================================================= | 84%, ETA 00:00 |================================================================================================================= | 84%, ETA 00:00 |================================================================================================================= | 84%, ETA 00:00 |================================================================================================================= | 84%, ETA 00:00 |================================================================================================================= | 84%, ETA 00:00 |================================================================================================================= | 85%, ETA 00:00 |================================================================================================================= | 85%, ETA 00:00 |================================================================================================================== | 85%, ETA 00:00 |================================================================================================================== | 85%, ETA 00:00 |================================================================================================================== | 85%, ETA 00:00 |================================================================================================================== | 85%, ETA 00:00 |================================================================================================================== | 85%, ETA 00:00 |================================================================================================================== | 85%, ETA 00:00 |================================================================================================================== | 85%, ETA 00:00 |=================================================================================================================== | 86%, ETA 00:00 |=================================================================================================================== | 86%, ETA 00:00 |=================================================================================================================== | 86%, ETA 00:00 |=================================================================================================================== | 86%, ETA 00:00 |=================================================================================================================== | 86%, ETA 00:00 |=================================================================================================================== | 86%, ETA 00:00 |=================================================================================================================== | 86%, ETA 00:00 |==================================================================================================================== | 86%, ETA 00:00 |==================================================================================================================== | 86%, ETA 00:00 |==================================================================================================================== | 86%, ETA 00:00 |==================================================================================================================== | 86%, ETA 00:00 |==================================================================================================================== | 87%, ETA 00:00 |==================================================================================================================== | 87%, ETA 00:00 |==================================================================================================================== | 87%, ETA 00:00 |==================================================================================================================== | 87%, ETA 00:00 |===================================================================================================================== | 87%, ETA 00:00 |===================================================================================================================== | 87%, ETA 00:00 |===================================================================================================================== | 87%, ETA 00:00 |===================================================================================================================== | 87%, ETA 00:00 |===================================================================================================================== | 87%, ETA 00:00 |===================================================================================================================== | 88%, ETA 00:00 |===================================================================================================================== | 88%, ETA 00:00 |====================================================================================================================== | 88%, ETA 00:00 |====================================================================================================================== | 88%, ETA 00:00 |====================================================================================================================== | 88%, ETA 00:00 |====================================================================================================================== | 88%, ETA 00:00 |====================================================================================================================== | 88%, ETA 00:00 |====================================================================================================================== | 88%, ETA 00:00 |====================================================================================================================== | 88%, ETA 00:00 |====================================================================================================================== | 88%, ETA 00:00 |======================================================================================================================= | 88%, ETA 00:00 |======================================================================================================================= | 89%, ETA 00:00 |======================================================================================================================= | 89%, ETA 00:00 |======================================================================================================================= | 89%, ETA 00:00 |======================================================================================================================= | 89%, ETA 00:00 |======================================================================================================================= | 89%, ETA 00:00 |======================================================================================================================= | 89%, ETA 00:00 |======================================================================================================================== | 89%, ETA 00:00 |======================================================================================================================== | 89%, ETA 00:00 |======================================================================================================================== | 89%, ETA 00:00 |======================================================================================================================== | 90%, ETA 00:00 |======================================================================================================================== | 90%, ETA 00:00 |======================================================================================================================== | 90%, ETA 00:00 |======================================================================================================================== | 90%, ETA 00:00 |======================================================================================================================== | 90%, ETA 00:00 |========================================================================================================================= | 90%, ETA 00:00 |========================================================================================================================= | 90%, ETA 00:00 |========================================================================================================================= | 90%, ETA 00:00 |========================================================================================================================= | 90%, ETA 00:00 |========================================================================================================================= | 90%, ETA 00:00 |========================================================================================================================= | 90%, ETA 00:00 |========================================================================================================================= | 91%, ETA 00:00 |========================================================================================================================== | 91%, ETA 00:00 |========================================================================================================================== | 91%, ETA 00:00 |========================================================================================================================== | 91%, ETA 00:00 |========================================================================================================================== | 91%, ETA 00:00 |========================================================================================================================== | 91%, ETA 00:00 |========================================================================================================================== | 91%, ETA 00:00 |========================================================================================================================== | 91%, ETA 00:00 |========================================================================================================================== | 91%, ETA 00:00 |=========================================================================================================================== | 92%, ETA 00:00 |=========================================================================================================================== | 92%, ETA 00:00 |=========================================================================================================================== | 92%, ETA 00:00 |=========================================================================================================================== | 92%, ETA 00:00 |=========================================================================================================================== | 92%, ETA 00:00 |=========================================================================================================================== | 92%, ETA 00:00 |=========================================================================================================================== | 92%, ETA 00:00 |============================================================================================================================ | 92%, ETA 00:00 |============================================================================================================================ | 92%, ETA 00:00 |============================================================================================================================ | 92%, ETA 00:00 |============================================================================================================================ | 92%, ETA 00:00 |============================================================================================================================ | 93%, ETA 00:00 |============================================================================================================================ | 93%, ETA 00:00 |============================================================================================================================ | 93%, ETA 00:00 |============================================================================================================================ | 93%, ETA 00:00 |============================================================================================================================= | 93%, ETA 00:00 |============================================================================================================================= | 93%, ETA 00:00 |============================================================================================================================= | 93%, ETA 00:00 |============================================================================================================================= | 93%, ETA 00:00 |============================================================================================================================= | 93%, ETA 00:00 |============================================================================================================================= | 94%, ETA 00:00 |============================================================================================================================= | 94%, ETA 00:00 |============================================================================================================================== | 94%, ETA 00:00 |============================================================================================================================== | 94%, ETA 00:00 |============================================================================================================================== | 94%, ETA 00:00 |============================================================================================================================== | 94%, ETA 00:00 |============================================================================================================================== | 94%, ETA 00:00 |============================================================================================================================== | 94%, ETA 00:00 |============================================================================================================================== | 94%, ETA 00:00 |============================================================================================================================== | 94%, ETA 00:00 |=============================================================================================================================== | 94%, ETA 00:00 |=============================================================================================================================== | 95%, ETA 00:00 |=============================================================================================================================== | 95%, ETA 00:00 |=============================================================================================================================== | 95%, ETA 00:00 |=============================================================================================================================== | 95%, ETA 00:00 |=============================================================================================================================== | 95%, ETA 00:00 |=============================================================================================================================== | 95%, ETA 00:00 |================================================================================================================================ | 95%, ETA 00:00 |================================================================================================================================ | 95%, ETA 00:00 |================================================================================================================================ | 95%, ETA 00:00 |================================================================================================================================ | 96%, ETA 00:00 |================================================================================================================================ | 96%, ETA 00:00 |================================================================================================================================ | 96%, ETA 00:00 |================================================================================================================================ | 96%, ETA 00:00 |================================================================================================================================= | 96%, ETA 00:00 |================================================================================================================================= | 96%, ETA 00:00 |================================================================================================================================= | 96%, ETA 00:00 |================================================================================================================================= | 96%, ETA 00:00 |================================================================================================================================= | 96%, ETA 00:00 |================================================================================================================================= | 96%, ETA 00:00 |================================================================================================================================= | 96%, ETA 00:00 |================================================================================================================================= | 97%, ETA 00:00 |================================================================================================================================== | 97%, ETA 00:00 |================================================================================================================================== | 97%, ETA 00:00 |================================================================================================================================== | 97%, ETA 00:00 |================================================================================================================================== | 97%, ETA 00:00 |================================================================================================================================== | 97%, ETA 00:00 |================================================================================================================================== | 97%, ETA 00:00 |================================================================================================================================== | 97%, ETA 00:00 |=================================================================================================================================== | 97%, ETA 00:00 |=================================================================================================================================== | 98%, ETA 00:00 |=================================================================================================================================== | 98%, ETA 00:00 |=================================================================================================================================== | 98%, ETA 00:00 |=================================================================================================================================== | 98%, ETA 00:00 |=================================================================================================================================== | 98%, ETA 00:00 |=================================================================================================================================== | 98%, ETA 00:00 |=================================================================================================================================== | 98%, ETA 00:00 |==================================================================================================================================== | 98%, ETA 00:00 |==================================================================================================================================== | 98%, ETA 00:00 |==================================================================================================================================== | 98%, ETA 00:00 |==================================================================================================================================== | 98%, ETA 00:00 |==================================================================================================================================== | 99%, ETA 00:00 |==================================================================================================================================== | 99%, ETA 00:00 |==================================================================================================================================== | 99%, ETA 00:00 |===================================================================================================================================== | 99%, ETA 00:00 |===================================================================================================================================== | 99%, ETA 00:00 |===================================================================================================================================== | 99%, ETA 00:00 |===================================================================================================================================== | 99%, ETA 00:00 |===================================================================================================================================== | 99%, ETA 00:00 |===================================================================================================================================== | 99%, ETA 00:00 |===================================================================================================================================== | 100%, ETA 00:00 |===================================================================================================================================== | 100%, ETA 00:00 |======================================================================================================================================| 100%, ETA 00:00 |======================================================================================================================================| 100%, ETA 00:00 |======================================================================================================================================| 100%, ETA 00:00 |==================================================================================================================================| 100%, Elapsed 00:01 Now we can look at isofroms that are correlated with the trajectory. Again we visualize these results using both a Seurat feature plot and a Monocle3 pseudotime gene-expression plot. Code traj_iso_res$plots$top_genes_featureplot Code traj_iso_res$plots$top_genes_pseudotime 11.3 Summary and downstream applications In this chapter, we used trajectory analysis with monocle3 to move beyond static clustering and reconstruct a smooth progression of cell states from our long-read single-cell dataset. Using the perform_trajectory_analysis() helper function, we learned a trajectory on the Seurat UMAP, ordered cells in pseudotime, and showed that the inferred path follows a biologically intuitive progression from stem cells through radial glia towards more mature neuronal subtypes. We then identified genes (and, by switching to assay = \"iso\", isoforms) whose expression patterns are significantly correlated with pseudotime, highlighting features that change gradually along the differentiation axis. All of this information – including the pseudotime values for each cell and the associated plots – is stored in the returned Seurat object (traj_res$seurat_obj) and result list. This makes it straightforward to incorporate trajectory information into later analyses. For example, users can (i) define “early”, “mid” and “late” pseudotime windows and perform differential expression between these pseudotime-defined groups, or (ii) compare pseudotime distributions across samples, time points, or conditions to ask whether a perturbation accelerates or delays progression along the trajectory. Together, these analyses provide a flexible scaffold for linking dynamic gene and isoform changes to underlying cell-state transitions in long-read single-cell data. It’s important to note that analyzing features in relation to pseudotime can be computationally intensive. The parameter number_of_features can be used to specify the number of highly variable features to test. Users can choose to plot the trajectory without the added computational load of ordering features by pseudotime, making the analysis more flexible.↩︎ "],["conclusion.html", "Conclusion Acknowledgements Session info", " Conclusion In this tutorial, we have demonstrated an end-to-end workflow for analyzing and visualising long-read single-cell data generated by FLAMES. We have shown how to preprocess the data to retain high-quality cells, load gene and isoform counts into a Seurat object, identify differentially expressed genes and isoforms across cell types, visualize isoform expression and structure, and identify novel isoforms that may impact protein function. While this tutorial covers the core aspects of single-cell long-read data analysis, several additional avenues remain unexplored. Further analyses could include enrichment analysis of differentially expressed transcription factors or splicing regulators, motif analysis to investigate regulatory element binding, and alternative splicing events that may impact cellular functions. Integrating these analyses can provide a more comprehensive understanding of cellular diversity and regulatory mechanisms. Ultimately, this tutorial, in combination with long-read tools such as FLAMES, offers a powerful toolkit for exploring and analyzing isoform-level dynamics in single cells. This workflow can be applied to other experimental contexts to identify candidate isoforms involved in development or disease pathogenesis. Acknowledgements Thank you to Manveer Chauhanand Michaela Sacco for reviewing this book and providing valuable suggestions to improve its clarity and content. Your feedback has contributed to making this a more useful resource for researchers working with long-read single-cell RNA sequencing data. Session info ## R version 4.4.0 (2024-04-24) ## Platform: x86_64-pc-linux-gnu ## Running under: Red Hat Enterprise Linux 9.6 (Plow) ## ## Matrix products: default ## BLAS/LAPACK: FlexiBLAS OPENBLAS; LAPACK version 3.10.1 ## ## locale: ## [1] LC_CTYPE=en_AU.UTF-8 LC_NUMERIC=C LC_TIME=en_AU.UTF-8 LC_COLLATE=en_AU.UTF-8 ## [5] LC_MONETARY=en_AU.UTF-8 LC_MESSAGES=en_AU.UTF-8 LC_PAPER=en_AU.UTF-8 LC_NAME=C ## [9] LC_ADDRESS=C LC_TELEPHONE=C LC_MEASUREMENT=en_AU.UTF-8 LC_IDENTIFICATION=C ## ## time zone: Australia/Melbourne ## tzcode source: system (glibc) ## ## attached base packages: ## [1] grid stats4 stats graphics grDevices utils datasets methods base ## ## other attached packages: ## [1] IsoformSwitchAnalyzeR_2.4.0 pfamAnalyzeR_1.6.0 sva_3.52.0 ## [4] genefilter_1.86.0 mgcv_1.9-1 nlme_3.1-166 ## [7] satuRn_1.12.0 limma_3.62.1 stageR_1.28.0 ## [10] DEXSeq_1.50.0 RColorBrewer_1.1-3 DESeq2_1.46.0 ## [13] DRIMSeq_1.34.0 ggpubr_0.6.0 progressr_0.15.0 ## [16] shiny_1.9.1 SeuratWrappers_0.3.5 monocle3_1.3.7 ## [19] ROCR_1.0-11 KernSmooth_2.23-24 fields_16.2 ## [22] viridisLite_0.4.2 spam_2.10-0 ggbeeswarm_0.7.2 ## [25] pheatmap_1.0.12 biomaRt_2.62.0 EnhancedVolcano_1.24.0 ## [28] ggrepel_0.9.6 dittoSeq_1.16.0 gprofiler2_0.2.3 ## [31] HGNChelper_0.8.14 data.tree_1.1.0 igraph_2.1.1 ## [34] ggraph_2.2.1 BSgenome.Hsapiens.UCSC.hg38_1.4.5 BSgenome_1.74.0 ## [37] BiocIO_1.16.0 Gviz_1.50.0 GenomicFeatures_1.58.0 ## [40] AnnotationDbi_1.68.0 ORFik_1.26.1 GenomicAlignments_1.42.0 ## [43] Rsamtools_2.22.0 Biostrings_2.74.1 XVector_0.46.0 ## [46] lubridate_1.9.3 forcats_1.0.0 dplyr_1.1.4 ## [49] purrr_1.0.2 readr_2.1.5 tidyr_1.3.1 ## [52] tibble_3.2.1 ggplot2_3.5.1 tidyverse_2.0.0 ## [55] patchwork_1.3.0 cowplot_1.1.3 stringr_1.5.1 ## [58] DoubletFinder_2.0.4 celda_1.20.0 Matrix_1.7-1 ## [61] BiocParallel_1.40.0 data.table_1.16.2 gridExtra_2.3 ## [64] DropletUtils_1.26.0 SingleCellExperiment_1.28.0 SummarizedExperiment_1.36.0 ## [67] Biobase_2.66.0 MatrixGenerics_1.18.0 matrixStats_1.4.1 ## [70] Seurat_5.1.0 SeuratObject_5.0.2 sp_2.1-4 ## [73] rtracklayer_1.66.0 GenomicRanges_1.58.0 GenomeInfoDb_1.42.0 ## [76] IRanges_2.40.0 S4Vectors_0.44.0 BiocGenerics_0.52.0 ## ## loaded via a namespace (and not attached): ## [1] ica_1.0-3 plotly_4.10.4 Formula_1.2-5 maps_3.4.2 ## [5] zlibbioc_1.52.0 tidyselect_1.2.1 bit_4.5.0 doParallel_1.0.17 ## [9] lattice_0.22-6 rjson_0.2.23 blob_1.2.4 S4Arrays_1.6.0 ## [13] parallel_4.4.0 dichromat_2.0-0.1 png_0.1-8 cli_3.6.3 ## [17] ProtGenerics_1.38.0 goftest_1.2-3 tximport_1.34.0 uwot_0.2.2 ## [21] curl_6.0.0 mime_0.12 evaluate_1.0.1 leiden_0.4.3.1 ## [25] stringi_1.8.4 backports_1.5.0 XML_3.99-0.17 httpuv_1.6.15 ## [29] magrittr_2.0.3 rappdirs_0.3.3 splines_4.4.0 jpeg_0.1-10 ## [33] sctransform_0.4.1 DBI_1.2.3 HDF5Array_1.34.0 jquerylib_0.1.4 ## [37] withr_3.0.2 lmtest_0.9-40 tidygraph_1.3.1 tximeta_1.22.1 ## [41] formatR_1.14 BiocManager_1.30.25 htmlwidgets_1.6.4 fst_0.9.8 ## [45] labeling_0.4.3 SparseArray_1.6.2 annotate_1.84.0 reticulate_1.39.0 ## [49] VariantAnnotation_1.52.0 zoo_1.8-12 knitr_1.48 UCSC.utils_1.2.0 ## [53] RhpcBLASctl_0.23-42 timechange_0.3.0 foreach_1.5.2 fansi_1.0.6 ## [57] rhdf5_2.50.0 pwalign_1.2.0 R.oo_1.27.0 RSpectra_0.16-2 ## [61] irlba_2.3.5.1 ggrastr_1.0.2 fastDummies_1.7.4 lazyeval_0.2.2 ## [65] yaml_2.3.10 survival_3.7-0 scattermore_1.2 BiocVersion_3.20.0 ## [69] crayon_1.5.3 RcppAnnoy_0.0.22 tweenr_2.0.3 later_1.3.2 ## [73] ggridges_0.5.6 codetools_0.2-20 base64enc_0.1-3 KEGGREST_1.46.0 ## [77] Rtsne_0.17 filelock_1.0.3 splitstackshape_1.4.8 foreign_0.8-87 ## [81] pkgconfig_2.0.3 xml2_1.3.5 spatstat.univar_3.0-0 servr_0.32 ## [85] spatstat.sparse_3.1-0 biovizBase_1.54.0 xtable_1.8-4 interp_1.1-6 ## [89] hwriter_1.3.2.1 car_3.1-3 highr_0.11 plyr_1.8.9 ## [93] httr_1.4.7 tools_4.4.0 globals_0.16.3 beeswarm_0.4.0 ## [97] htmlTable_2.4.3 broom_1.0.7 checkmate_2.3.2 fstcore_0.9.18 ## [101] lambda.r_1.2.4 futile.logger_1.4.3 dbplyr_2.5.0 lme4_1.1-35.5 ## [105] digest_0.6.37 bookdown_0.41 farver_2.1.2 tzdb_0.4.0 ## [109] AnnotationFilter_1.30.0 reshape2_1.4.4 biomartr_1.0.7 WriteXLS_6.7.0 ## [113] viridis_0.6.5 rpart_4.1.23 VennDiagram_1.7.3 glue_1.8.0 ## [117] cachem_1.1.0 BiocFileCache_2.14.0 polyclip_1.10-7 Hmisc_5.2-0 ## [121] generics_0.1.3 presto_1.0.0 parallelly_1.38.0 txdbmaker_1.0.1 ## [125] statmod_1.5.0 RcppHNSW_0.6.0 carData_3.0-5 minqa_1.2.8 ## [129] pbapply_1.7-2 httr2_0.2.3 dqrng_0.4.1 utf8_1.2.4 ## [133] graphlayouts_1.2.0 ggsignif_0.6.4 RcppEigen_0.3.4.0.2 GenomeInfoDbData_1.2.13 ## [137] R.utils_2.12.3 rhdf5filters_1.18.0 RCurl_1.98-1.16 memoise_2.0.1 ## [141] rmarkdown_2.29 locfdr_1.1-8 scales_1.3.0 R.methodsS3_1.8.2 ## [145] future_1.34.0 RANN_2.6.2 spatstat.data_3.1-2 rstudioapi_0.15.0 ## [149] cluster_2.1.6 spatstat.utils_3.1-1 hms_1.1.3 fitdistrplus_1.2-1 ## [153] munsell_0.5.1 colorspace_2.1-1 rlang_1.1.4 DelayedMatrixStats_1.28.0 ## [157] sparseMatrixStats_1.18.0 dotCall64_1.2 ggforce_0.4.2 scuttle_1.16.0 ## [161] xfun_0.52 remotes_2.5.0 iterators_1.0.14 abind_1.4-8 ## [165] MCMCprecision_0.4.0 Rhdf5lib_1.28.0 geneplotter_1.82.0 futile.options_1.0.1 ## [169] bitops_1.0-9 promises_1.3.0 RSQLite_2.3.7 openxlsx_4.2.6.1 ## [173] DelayedArray_0.32.0 harmony_1.2.1 compiler_4.4.0 prettyunits_1.2.0 ## [177] boot_1.3-31 beachmat_2.22.0 listenv_0.9.1 Rcpp_1.0.13-1 ## [181] AnnotationHub_3.14.0 enrichR_3.2 edgeR_4.4.0 tensor_1.5 ## [185] MASS_7.3-61 progress_1.2.3 spatstat.random_3.3-1 R6_2.5.1 ## [189] fastmap_1.2.0 rstatix_0.7.2 vipor_0.4.7 ensembldb_2.28.0 ## [193] rsvd_1.0.5 nnet_7.3-19 gtable_0.3.6 latticeExtra_0.6-30 ## [197] miniUI_0.1.1.1 deldir_2.0-4 htmltools_0.5.8.1 bit64_4.5.2 ## [201] spatstat.explore_3.3-1 lifecycle_1.0.4 zip_2.3.0 nloptr_2.1.1 ## [205] restfulr_0.0.15 sass_0.4.9 vctrs_0.6.5 spatstat.geom_3.3-2 ## [209] future.apply_1.11.3 bslib_0.8.0 pillar_1.9.0 locfit_1.5-9.10 ## [213] combinat_0.0-8 jsonlite_1.8.9 "],["differential-transcript-usage-dtu.html", "Chapter 12 Differential Transcript Usage (DTU) 12.1 Preparing the data for DTU analysis 12.2 Generating a SwitchList 12.3 Visualising DTU Hits 12.4 Final thoughts", " Chapter 12 Differential Transcript Usage (DTU) Differential transcript usage (DTU), or isoform switching, refers to changes in the relative expression of different transcript isoforms from the same gene across conditions, cell types, or time points. Unlike traditional gene- or isoform-level differential expression, which focuses on changes in total expression, DTU specifically examines how the proportions of isoforms shift between groups. This provides insight into how alternative splicing and isoform regulation contribute to cellular processes and phenotypic differences. DTU analysis is particularly useful for dissecting complex regulatory mechanisms, such as those underlying neuronal differentiation, disease progression, or cell state transitions, where changes in isoform usage may occur even when total gene expression remains stable. By identifying isoforms that are preferentially expressed under specific conditions, we can begin to link splicing programs to functional outcomes. This area is still relatively new in the context of single-cell sequencing, and tools developed specifically for single-cell DTU are not yet well established. In this chapter, we therefore use a bulk-oriented tool, IsoformSwitchAnalyzeR, and adapt it to our long-read single-cell setting. The full vignette for IsoformSwitchAnalyzeR can be found here: https://www.bioconductor.org/packages/release/bioc/vignettes/IsoformSwitchAnalyzeR/inst/doc/IsoformSwitchAnalyzeR.html We will start by loading the required packages. Code library(DRIMSeq) library(DEXSeq) library(stageR) library(IsoformSwitchAnalyzeR) library(rtracklayer) 12.1 Preparing the data for DTU analysis Next, we will build a pseudobulk data set containing isoform expression aggregated across our sample replicates. We will use Seurat’s native AggregateExpression() function and group counts by both cell type and sample replicate. This effectively creates one pseudobulk profile per cell type × sample combination, which is more appropriate for DTU methods like IsoformSwitchAnalyzeR which cannot use individual cells. In an ideal experimental design, you would have more biological replicates per time point (for example, at least three). In this tutorial we only have two replicates per time point, which is sufficient to illustrate the workflow, but additional replicates would provide more power and robustness for this type of analysis. Code #Get pseudobulk counts split by sample and celll type pseudo.seurat.isoforms &lt;- AggregateExpression( obj, assays = &quot;iso&quot;, return.seurat = FALSE, group.by = c(&quot;orig.ident&quot;, &quot;cell_type&quot;) ) # Make a dataframe from above data pseudo.seurat.isoforms.df &lt;- as.data.frame(pseudo.seurat.isoforms) colnames(pseudo.seurat.isoforms.df) ## [1] &quot;iso.C1.STC_Stem.cells&quot; &quot;iso.C2.Day25_Radial.glia&quot; &quot;iso.C2.Day25_Inhibitory.neurons&quot; ## [4] &quot;iso.C2.Day25_Excitatory.neurons&quot; &quot;iso.C4.STC_Stem.cells&quot; &quot;iso.C5.Day25_Radial.glia&quot; ## [7] &quot;iso.C5.Day25_Inhibitory.neurons&quot; &quot;iso.C5.Day25_Excitatory.neurons&quot; Code # Define sample condtions sample_data &lt;-as.data.frame(colnames(pseudo.seurat.isoforms.df)) # Rename the column for clarity colnames(sample_data) &lt;- &quot;colnames&quot; # Split the column names into sampleID and celltype split_sample_data &lt;- strsplit(sample_data$colnames, &quot;_&quot;) Now that we have our pseudobulk sample data, we need to build a sample table that describes the experimental design and conditions. We’ll call this table samps. We will construct this data frame using the column names of the pseudobulk matrix: for each cell type (four in total), there should be two replicates, which will be reflected as separate rows in samps. Code # Create a new data frame with the original column names and extracted sampleID and celltype samps &lt;- data.frame( sampleID = sample_data$colnames, condition = sapply(split_sample_data, `[`, 2) ) samps$condition &lt;- as.factor(samps$condition) samps ## sampleID condition ## 1 iso.C1.STC_Stem.cells Stem.cells ## 2 iso.C2.Day25_Radial.glia Radial.glia ## 3 iso.C2.Day25_Inhibitory.neurons Inhibitory.neurons ## 4 iso.C2.Day25_Excitatory.neurons Excitatory.neurons ## 5 iso.C4.STC_Stem.cells Stem.cells ## 6 iso.C5.Day25_Radial.glia Radial.glia ## 7 iso.C5.Day25_Inhibitory.neurons Inhibitory.neurons ## 8 iso.C5.Day25_Excitatory.neurons Excitatory.neurons Great! Now we can follow the IsoformSwitchAnalyzeR documentation to create a switchAnalyzeRlist and test for DTU across our cell types. Before generating this object, we first need to subset both the GTF and the count matrix to ensure a 1:1 match between them—that is, the reference GTF and the count data should contain exactly the same set of transcript (isoform) entries. This alignment is essential for IsoformSwitchAnalyzeR to correctly map counts to the underlying transcript models. Code ## Before generating a switch list we need to subset both the gtf and counts to ensure we have a 1:1 match #read in gtf This is the GTF output by flames tx2gene &lt;- import(&quot;./data/muti_sample/isoform_annotated.gtf&quot;) # Set row names of pseudo.seurat.isoforms.df to the transcript_id column # Extract the row names rownames_split &lt;- strsplit(rownames(pseudo.seurat.isoforms.df), &quot;-&quot;) # Add new columns &#39;transcript_id&#39; and &#39;gene_id&#39; to the data frame rownames(pseudo.seurat.isoforms.df) &lt;- sapply(rownames_split, `[`, 1) #subset to match subset_txt2gene &lt;- tx2gene[tx2gene$transcript_id %in% row.names(pseudo.seurat.isoforms.df), ] subset_cts &lt;- pseudo.seurat.isoforms.df[row.names(pseudo.seurat.isoforms.df) %in% tx2gene$transcript_id, ] # write gtf as we need it for the bext step export(subset_txt2gene, &quot;./output_files/multi_sample_subset/DTU.gtf&quot;, format = &quot;gtf&quot;) 12.2 Generating a SwitchList Now lets create the switch list: Code #### genrate a switch list aSwitchList &lt;- importRdata( isoformCountMatrix = subset_cts, isoformRepExpression = subset_cts, designMatrix = samps, isoformExonAnnoation = &quot;./output_files/multi_sample_subset/DTU.gtf&quot;, isoformNtFasta = &quot;/data/scratch/users/yairp/Kolf2.1_FLAMESv2/outs/Bambu_NDR_0.75/transcript_assembly.fa&quot;, # provide the FLAMES transcript_output .fasta, it will be found in the flames output fodler showProgress = TRUE, fixStringTieAnnotationProblem = TRUE ) ## Step 1 of 10: Checking data... ## Warning in importRdata(isoformCountMatrix = subset_cts, isoformRepExpression = subset_cts, : Using row.names as &#39;isoform_id&#39; for ## &#39;isoformCountMatrix&#39;. If not suitable you must add them manually. ## Using row.names as &#39;isoform_id&#39; for &#39;isoformRepExpression&#39;. If not suitable you must add them manually. ## Step 2 of 10: Obtaining annotation... ## importing GTF (this may take a while)... ## Warning in importRdata(isoformCountMatrix = subset_cts, isoformRepExpression = subset_cts, : We found 2 (0%) unstranded transcripts. ## These were removed as unstranded transcripts cannot be analysed ## Warning in importRdata(isoformCountMatrix = subset_cts, isoformRepExpression = subset_cts, : No CDS annotation was found in the GTF files meaning ORFs could not be annotated. ## (But ORFs can still be predicted with the analyzeORF() function) ## 5823 ( 4.37%) isoforms were removed since they were not expressed in any samples. ## Step 3 of 10: Fixing StringTie gene annoation problems... ## There were no need to rescue any annotation ## Step 4 of 10: Calculating expression estimates from count data... ## Skipped as user supplied expression via the &quot;isoformRepExpression&quot; argument... ## Step 5 of 10: Testing for unwanted effects... ## ## SVA analysis failed. No unwanted effects were added. ## Warning in importRdata(isoformCountMatrix = subset_cts, isoformRepExpression = subset_cts, : ## There were estimated unwanted effects in your dataset but the automatic sva run failed. ## We highly reccomend you run sva yourself, add the nessesary surrogate variables ## as extra columns in the &quot;designMatrix&quot; and re-run this function ## Step 6 of 10: Batch correcting expression estimates... ## Skipped as no batch effects were found or annoated... ## Step 7 of 10: Extracting data from each condition... ## | | | 0% | |=============================== | 25% | |============================================================== | 50% | |============================================================================================= | 75% | |============================================================================================================================| 100% ## Step 8 of 10: Making comparisons... ## | | | 0% | |===================== | 17% | |========================================= | 33% | |============================================================== | 50% | |=================================================================================== | 67% | |======================================================================================================= | 83% | |============================================================================================================================| 100% ## Step 9 of 10: Making switchAnalyzeRlist object... ## Step 10 of 10: Guestimating differential usage... ## The GUESSTIMATED number of genes with differential isoform usage are: ## comparison estimated_genes_with_dtu ## 1 Excitatory.neurons vs Inhibitory.neurons 0 - 0 ## 2 Excitatory.neurons vs Stem.cells 769 - 1282 ## 3 Radial.glia vs Stem.cells 165 - 275 ## Done Code #summary of switch lsit summary(aSwitchList) ## This switchAnalyzeRlist list contains: ## 127534 isoforms from 29885 genes ## 6 comparison from 4 conditions (in total 8 samples) ## ## Feature analyzed: ## [1] &quot;ntSequence&quot; Now that we have our switch list, we apply stringent filtering to remove genes and isoforms that are lowly expressed, as well as isoforms that contribute only a small fraction of a gene’s overall expression. We are deliberately strict here for two reasons: IsoformSwitchAnalyzeR is designed for bulk data, so using higher stringency thresholds is generally a safer and more biologically meaningful choice in this context. Filtering out isoforms of little consequence reduces noise, improves the robustness of the DTU testing, and substantially speeds up subsequent analysis steps. Code aSwitchList_filt &lt;- preFilter( aSwitchList, geneExpressionCutoff = 30, # min avg *gene* expression across samples isoformExpressionCutoff = 20, # min isoform expression in at least one condition IFcutoff = 0.05, # keep isoforms that contribute &gt;=5% to gene removeSingleIsoformGenes = TRUE, # drop genes with only one isoform acceptedGeneBiotype = NULL, # or e.g. &quot;protein_coding&quot; if annotated quiet = FALSE ) ## The filtering removed 120390 ( 94.4% of ) transcripts. There is now 7144 isoforms left Code summary(aSwitchList_filt) ## This switchAnalyzeRlist list contains: ## 7144 isoforms from 2865 genes ## 6 comparison from 4 conditions (in total 8 samples) ## ## Feature analyzed: ## [1] &quot;ntSequence&quot; As part of the workflow, we can also add ORF (open reading frame) information to the object. This step can be time-consuming if you have many isoforms, but we recommend running it where possible, as it helps to interpret the potential functional impact of different isoforms in different contexts. Code #Add ORF info aSwitchList_ORF_filt &lt;- analyzeORF(switchAnalyzeRlist = aSwitchList_filt, orfMethod = &quot;longest&quot;, showProgress = TRUE) ## Step 1 of 3 : Extracting transcript sequences... ## Step 2 of 3 : Locating potential ORFs... ## | | | 0% | |= | 0% | |= | 1% | |== | 1% | |== | 2% | |=== | 2% | |=== | 3% | |==== | 3% | |==== | 4% | |===== | 4% | |====== | 4% | |====== | 5% | |======= | 5% | |======= | 6% | |======== | 6% | |======== | 7% | |========= | 7% | |========= | 8% | |========== | 8% | |=========== | 8% | |=========== | 9% | |============ | 9% | |============ | 10% | |============= | 10% | |============= | 11% | |============== | 11% | |============== | 12% | |=============== | 12% | |================ | 12% | |================ | 13% | |================= | 13% | |================= | 14% | |================== | 14% | |================== | 15% | |=================== | 15% | |=================== | 16% | |==================== | 16% | |==================== | 17% | |===================== | 17% | |====================== | 17% | |====================== | 18% | |======================= | 18% | |======================= | 19% | |======================== | 19% | |======================== | 20% | |========================= | 20% | |========================= | 21% | |========================== | 21% | |=========================== | 21% | |=========================== | 22% | |============================ | 22% | |============================ | 23% | |============================= | 23% | |============================= | 24% | |============================== | 24% | |============================== | 25% | |=============================== | 25% | |================================ | 25% | |================================ | 26% | |================================= | 26% | |================================= | 27% | |================================== | 27% | |================================== | 28% | |=================================== | 28% | |=================================== | 29% | |==================================== | 29% | |===================================== | 29% | |===================================== | 30% | |====================================== | 30% | |====================================== | 31% | |======================================= | 31% | |======================================= | 32% | |======================================== | 32% | |======================================== | 33% | |========================================= | 33% | |========================================== | 33% | |========================================== | 34% | |=========================================== | 34% | |=========================================== | 35% | |============================================ | 35% | |============================================ | 36% | |============================================= | 36% | |============================================= | 37% | |============================================== | 37% | |============================================== | 38% | |=============================================== | 38% | |================================================ | 38% | |================================================ | 39% | |================================================= | 39% | |================================================= | 40% | |================================================== | 40% | |================================================== | 41% | |=================================================== | 41% | |=================================================== | 42% | |==================================================== | 42% | |===================================================== | 42% | |===================================================== | 43% | |====================================================== | 43% | |====================================================== | 44% | |======================================================= | 44% | |======================================================= | 45% | |======================================================== | 45% | |======================================================== | 46% | |========================================================= | 46% | |========================================================== | 46% | |========================================================== | 47% | |=========================================================== | 47% | |=========================================================== | 48% | |============================================================ | 48% | |============================================================ | 49% | |============================================================= | 49% | |============================================================= | 50% | |============================================================== | 50% | |=============================================================== | 50% | |=============================================================== | 51% | |================================================================ | 51% | |================================================================ | 52% | |================================================================= | 52% | |================================================================= | 53% | |================================================================== | 53% | |================================================================== | 54% | |=================================================================== | 54% | |==================================================================== | 54% | |==================================================================== | 55% | |===================================================================== | 55% | |===================================================================== | 56% | |====================================================================== | 56% | |====================================================================== | 57% | |======================================================================= | 57% | |======================================================================= | 58% | |======================================================================== | 58% | |========================================================================= | 58% | |========================================================================= | 59% | |========================================================================== | 59% | |========================================================================== | 60% | |=========================================================================== | 60% | |=========================================================================== | 61% | |============================================================================ | 61% | |============================================================================ | 62% | |============================================================================= | 62% | |============================================================================== | 62% | |============================================================================== | 63% | |=============================================================================== | 63% | |=============================================================================== | 64% | |================================================================================ | 64% | |================================================================================ | 65% | |================================================================================= | 65% | |================================================================================= | 66% | |================================================================================== | 66% | |================================================================================== | 67% | |=================================================================================== | 67% | |==================================================================================== | 67% | |==================================================================================== | 68% | |===================================================================================== | 68% | |===================================================================================== | 69% | |====================================================================================== | 69% | |====================================================================================== | 70% | |======================================================================================= | 70% | |======================================================================================= | 71% | |======================================================================================== | 71% | |========================================================================================= | 71% | |========================================================================================= | 72% | |========================================================================================== | 72% | |========================================================================================== | 73% | |=========================================================================================== | 73% | |=========================================================================================== | 74% | |============================================================================================ | 74% | |============================================================================================ | 75% | |============================================================================================= | 75% | |============================================================================================== | 75% | |============================================================================================== | 76% | |=============================================================================================== | 76% | |=============================================================================================== | 77% | |================================================================================================ | 77% | |================================================================================================ | 78% | |================================================================================================= | 78% | |================================================================================================= | 79% | |================================================================================================== | 79% | |=================================================================================================== | 79% | |=================================================================================================== | 80% | |==================================================================================================== | 80% | |==================================================================================================== | 81% | |===================================================================================================== | 81% | |===================================================================================================== | 82% | |====================================================================================================== | 82% | |====================================================================================================== | 83% | |======================================================================================================= | 83% | |======================================================================================================== | 83% | |======================================================================================================== | 84% | |========================================================================================================= | 84% | |========================================================================================================= | 85% | |========================================================================================================== | 85% | |========================================================================================================== | 86% | |=========================================================================================================== | 86% | |=========================================================================================================== | 87% | |============================================================================================================ | 87% | |============================================================================================================ | 88% | |============================================================================================================= | 88% | |============================================================================================================== | 88% | |============================================================================================================== | 89% | |=============================================================================================================== | 89% | |=============================================================================================================== | 90% | |================================================================================================================ | 90% | |================================================================================================================ | 91% | |================================================================================================================= | 91% | |================================================================================================================= | 92% | |================================================================================================================== | 92% | |=================================================================================================================== | 92% | |=================================================================================================================== | 93% | |==================================================================================================================== | 93% | |==================================================================================================================== | 94% | |===================================================================================================================== | 94% | |===================================================================================================================== | 95% | |====================================================================================================================== | 95% | |====================================================================================================================== | 96% | |======================================================================================================================= | 96% | |======================================================================================================================== | 96% | |======================================================================================================================== | 97% | |========================================================================================================================= | 97% | |========================================================================================================================= | 98% | |========================================================================================================================== | 98% | |========================================================================================================================== | 99% | |=========================================================================================================================== | 99% | |=========================================================================================================================== | 100% | |============================================================================================================================| 100% ## Step 3 of 3 : Scanning for PTCs... ## 7117 putative ORFs were identified, analyzed and added. ## Done Code #saveRDS( # object = aSwitchList_ORF, # file = &quot;./output_files/multi_sample_subset/DTU_switch_list_ORF.rds&quot; #) Lets add in gene symbols to the object so we can easily read what genes are switching Code #Add gene symbol to switch lsit resource_table &lt;- read.csv(&quot;./output_files/ref_files/isoform_gene_dict_mutlisample_subset.csv&quot;, header = T) # Access the isoform features list isoform_features &lt;- aSwitchList_ORF_filt[[&quot;isoformFeatures&quot;]] # Use match to fill in the &#39;gene_name&#39; based on &#39;gene_id&#39; isoform_features[[&quot;gene_name&quot;]] &lt;- resource_table$gene_symbol[match(isoform_features[[&quot;gene_id&quot;]], resource_table$gene_id)] # Save the updated isoformFeatures back into the main list aSwitchList_ORF_filt[[&quot;isoformFeatures&quot;]] &lt;- isoform_features After all of this, we can finally perform the statistical test for DTU. This step can be time-consuming, especially if there are many comparisons to make or a large number of samples to test. Code # Execute Switch testing SwitchListAnalyzed &lt;- isoformSwitchTestDEXSeq( switchAnalyzeRlist = aSwitchList_ORF_filt, reduceToSwitchingGenes=FALSE, reduceFurtherToGenesWithConsequencePotential=FALSE, alpha = 0.01, dIFcutoff = 0.25, onlySigIsoforms=FALSE ) ## Step 1 of 2: Testing each pairwise comparisons with DEXSeq (this might be a bit slow)... ## Estimated run time is: 9.5 min ## | | | 0% | |===================== | 17% | |========================================= | 33% | |============================================================== | 50% | |=================================================================================== | 67% | |======================================================================================================= | 83% | |============================================================================================================================| 100% ## Step 2 of 2: Integrating result into switchAnalyzeRlist... ## Isoform switch analysis was performed for 9033 gene comparisons (100%). ## Total runtime: 1 min ## Done Code #saveRDS(&quot;./output_files/multi_sample_subset/DTU_SwitchListAnalyzed.rds&quot;, object = SwitchListAnalyzed) 12.3 Visualising DTU Hits Lets Investigate the results. First we can look at the numebr of DTU hits across each condition. Code extractSwitchSummary(SwitchListAnalyzed) ## Comparison nrIsoforms nrSwitches nrGenes ## 1 Excitatory.neurons vs Inhibitory.neurons 3 2 2 ## 2 Excitatory.neurons vs Radial.glia 181 114 113 ## 3 Excitatory.neurons vs Stem.cells 555 321 325 ## 4 Inhibitory.neurons vs Radial.glia 88 47 55 ## 5 Inhibitory.neurons vs Stem.cells 543 293 337 ## 6 Radial.glia vs Stem.cells 503 252 310 ## 7 Combined 1159 670 651 We can then extract some of the top (most significant) DTU events and visualise them using the built-in plotting functions in the IsoformSwitchAnalyzeR package. These functions make it straightforward to inspect individual genes and their switching isoforms in more detail. If you run this function bellow you will generate the top 5 DTU events for each condition. Code extractTopSwitches(SwitchListAnalyzed, n=20) # Main results file iso_feat &lt;- as.data.frame(SwitchListAnalyzed$isoformFeatures) write.csv(SwitchListAnalyzed$isoformFeatures, &quot;stem_gaba_dtu.csv&quot;) #output switch plots for all switchPlotTopSwitches( switchAnalyzeRlist = SwitchListAnalyzed, n = 5, splitFunctionalConsequences = F, filterForConsequences = FALSE, #this could be changed to add in consequeces fileType = &quot;pdf&quot;, pathToOutput = &quot;./output_files/multi_sample_subset/&quot;, alpha = 0.01 ) Let’s explore one example in more detail. Here, we compare stem cells to radial glia and focus on one of the most significant DTU hits, RPS24. We can visualise this using a switch plot. The switch plot is composed of several panels. At the top, we see the isoform structures for the two RPS24 isoforms tested. Notably, ENST00000613865.5 is missing the penultimate exon, and the two isoforms have different ORFs, yet both are classified as coding. Below, the bar charts summarise overall gene expression and isoform-level expression across conditions. The panel on the right shows the key result: isoform usage (relative proportion) in each condition. In this example, stem cells use a higher proportion of ENST00000613865.5, whereas radial glia preferentially use ENST00000372360.9, illustrating a clear isoform switch between these two cell types. ## Omitting toplogy visualization as it has not been added. You can add this analysis through analyzeDeepTMHMM(). To avoid this message set &quot;plotTopology=FALSE&quot; This can be visualised and verified using our Seurat plotting functions. Let’s first look at gene-level expression of RPS24. As you can see below, RPS24 is expressed ubiquitously and appears, at first glance, to be a fairly unremarkable gene with expression detected across all cell types. Code FeaturePlot(obj, features = &quot;RPS24&quot;, reduction = &quot;umap.harm&quot;) Let’s dive in and plot the isoforms from the switch plot to see what is really going on. When we visualise these isoforms, we observe a clear separation in isoform expression between stem cells and radial glia. Stem cells appear to use a mixture of both isoforms, whereas radial glia are much more selective and predominantly express ENST00000372360.9. (It is important to note that additional RPS24 isoforms exist in the data, but they were not included in our DTU test or in the plots shown here.) Code FeaturePlot(obj, features = c(&quot;ENST00000372360.9-RPS24&quot;, &quot;ENST00000613865.5-RPS24&quot;), reduction = &quot;umap.harm&quot;) 12.4 Final thoughts DTU analysis is a powerful and exciting way to explore how isoforms are used in different contexts. Once you have the switch list we generated here, you can systematically explore many alternative DTU hits, inspect structural differences between isoforms, and assess whether particular transcripts are likely coding or non-coding. Together, these insights can greatly strengthen our understanding of isoform dynamics across cell types and conditions. Combined with trajectory analysis and standard differential expression, DTU provides yet another complementary lens for exploring the isoform landscape at single-cell resolution. "],["references.html", "References", " References Chen, Y., Sim, A., Wan, Y. K., Yeo, K., Lee, J. J. X., Ling, M. H., Love, M. I., &amp; Göke, J. (2023). Context-aware transcript quantification from long-read RNA-seq data with Bambu. Nature Methods, 20(8), 1187–1195. https://doi.org/10.1038/s41592-023-01908-w Hahne, F., &amp; Ivanek, R. (2016). Visualizing genomic data using gviz and bioconductor (pp. 335–351). Springer New York. https://doi.org/10.1007/978-1-4939-3578-9_16 Ianevski, A., Giri, A. K., &amp; Aittokallio, T. (2022). Fully-automated and ultra-fast cell-type identification using specific marker combinations from single-cell transcriptomic data. Nature Communications, 13(1). https://doi.org/10.1038/s41467-022-28803-w Jousheghani, Z. Z., &amp; Patro, R. (2024). Oarfish: Enhanced probabilistic modeling leads to improved accuracy in long read transcriptome quantification. http://dx.doi.org/10.1101/2024.02.28.582591 Korsunsky, I., Millard, N., Fan, J., Slowikowski, K., Zhang, F., Wei, K., Baglaenko, Y., Brenner, M., Loh, P., &amp; Raychaudhuri, S. (2019). Fast, sensitive and accurate integration of single-cell data with Harmony. Nature Methods, 16(12), 1289–1296. https://doi.org/10.1038/s41592-019-0619-0 Kovaka, S., Zimin, A. V., Pertea, G. M., Razaghi, R., Salzberg, S. L., &amp; Pertea, M. (2019). Transcriptome assembly from long-read RNA-seq alignments with StringTie2. Genome Biology, 20(1). https://doi.org/10.1186/s13059-019-1910-1 Pardo-Palacios, F. J., Arzalluz-Luque, A., Kondratova, L., Salguero, P., Mestre-Tomás, J., Amorín, R., Estevan-Morió, E., Liu, T., Nanni, A., McIntyre, L., Tseng, E., &amp; Conesa, A. (2024). SQANTI3: curation of long-read transcriptomes for accurate identification of known and novel isoforms. Nature Methods, 21(5), 793–797. https://doi.org/10.1038/s41592-024-02229-2 Smedley, D., Haider, S., Ballester, B., Holland, R., London, D., Thorisson, G., &amp; Kasprzyk, A. (2009). BioMart biological queries made easy. BMC Genomics, 10(1). https://doi.org/10.1186/1471-2164-10-22 Tian, L., Jabbari, J. S., Thijssen, R., Gouil, Q., Amarasinghe, S. L., Voogd, O., Kariyawasam, H., Du, M. R. M., Schuster, J., Wang, C., Su, S., Dong, X., Law, C. W., Lucattini, A., Prawer, Y. D. J., Collar-Fernandez, C., Chung, J. D., Naim, T., Chan, A., … Ritchie, M. E. (2021). Comprehensive characterization of single-cell full-length isoforms in human and mouse with long-read sequencing. Genome Biology, 22(1). https://doi.org/10.1186/s13059-021-02525-6 Tjeldnes, H., Labun, K., Torres Cleuren, Y., Chyżyńska, K., Świrski, M., &amp; Valen, E. (2021). ORFik: a comprehensive R toolkit for the analysis of translation. BMC Bioinformatics, 22(1). https://doi.org/10.1186/s12859-021-04254-w Trapnell, C., Cacchiarelli, D., Grimsby, J., Pokharel, P., Li, S., Morse, M., Lennon, N. J., Livak, K. J., Mikkelsen, T. S., &amp; Rinn, J. L. (2014). The dynamics and regulators of cell fate decisions are revealed by pseudotemporal ordering of single cells. Nature Biotechnology, 32(4), 381–386. https://doi.org/10.1038/nbt.2859 Wan, C. Y., Davis, J., Chauhan, M., Gleeson, J., Prawer, Y. D. J., DePaoli-Iseppi, R., Wells, C. A., Choi, J., &amp; Clark, M. B. (2024). IsoVis a webserver for visualization and annotation of alternative RNA isoforms. Nucleic Acids Research, 52(W1), W341–W347. https://doi.org/10.1093/nar/gkae343 Wang, C., Prawer, Y. D. J., Voogd, O., Schuster, J., De Paoli-Iseppi, R., Li, A., Hallab, J., Tian, L., Peng, H., David, M., Du, M. R. M., Velasco, S., Garone, M. G., Dong, X., Zeglinski, K., Pavan, C., Law, K. C. L., Abu-Bonsrah, K. D., Hunt, C. P. J., … You, Y. (2025). Igniting full-length isoform analysis in single-cell and spatial RNA-seq data with FLAMESv2. http://dx.doi.org/10.1101/2025.10.19.683327 You, Y., Prawer, Y. D. J., De Paoli-Iseppi, R., Hunt, C. P. J., Parish, C. L., Shim, H., &amp; Clark, M. B. (2023). Identification of cell barcodes from long-read single-cell RNA-seq with BLAZE. Genome Biology, 24(1). https://doi.org/10.1186/s13059-023-02907-y "],["appendix.html", "Appendix Calculating the ambient RNA profile Multisample QC function Convert Oarfish files to a count matrix", " Appendix Calculating the ambient RNA profile By calculating the ambient RNA profile, we can perform two important analyses to improve data quality: (1) removing empty droplets and (2) normalizing for background RNA contamination. Chapter 3 of the tutorial outlines both processes. However, the first step is to calculate the background RNA profile by quantifying gene expression for a list of barcodes known to represent background droplets rather than true cells. When running FLAMES, one of the outputs is the empty_bc_list.csv file, which contains 2,000 barcodes identified as background, not associated with cells. Users can manually add additional background barcodes if needed (for advanced users). For a detailed understanding of how this list is determined, refer to the BLAZE publication (You et al., 2023). To incorporate the background barcode list, users should run FLAMES as they did previously, but include the background barcode list as the barcode_file parameter. There is no need to identify or quantify isoforms so users can set the following parameters to false in the config file \"do_isoform_identification\": false, \"bambu_isoform_identification\": false, \"do_read_realignment\": false, \"do_transcript_quantification\": false Code # Run FLAMES using background barcode list generated in the first run. ppl &lt;- SingleCellPipeline(fastq=fastq, outdir=output, annot=GTF, genome=genome, #minimap=minimap_dir, k8=k8, config_file=config_file, expect_cell_number=1000, barcodes_file=&#39;path/to/emtpy_bc_list.csv&#39;) ppl &lt;- run_FLAMES(ppl) sce &lt;- experiment(ppl) Multisample QC function Code # Perform QC for each sample perform_qc_filtering &lt;- function(count.matrix=C1_STC, min.features = 5000 , max.features = 10000, max.counts = 100000, min.counts = 3000, npc = 15, cluster_res = 0.9, fig_name = &#39;1&#39;, project = &quot;2&quot;, MT = 10, doublet_rate = 0.039) { # Function to calculate min.features and max.features if not provided calculate_feature_range &lt;- function(nFeature_RNA) { min_feature &lt;- round(mean(nFeature_RNA) - (1.5 * sd(nFeature_RNA))) max_feature &lt;- round(mean(nFeature_RNA) + (1.5 * sd(nFeature_RNA))) return(list(min_feature = min_feature, max_feature = max_feature)) } # If min.features and max.features not provided, calculate them if (is.null(min.features) || is.null(max.features)) { seurat_obj_org &lt;- CreateSeuratObject(counts = count.matrix, project = project) feature_range &lt;- calculate_feature_range(seurat_obj_org$nFeature_RNA) min.features &lt;- feature_range$min_feature max.features &lt;- feature_range$max_feature } rst_figures &lt;- list() rst_table &lt;- data.frame() ##### remove features expressed in less than 1% of cells ##### # Calculate the percentage of cells expressing each gene #gene_percent_expression &lt;- base::rowMeans(count.matrix &gt; 0) * 100 # Select genes expressed in at least 1% of cells #genes_filter &lt;- names(gene_percent_expression[gene_percent_expression &gt; 1]) # Filter counts #counts_sub &lt;- count.matrix[genes_filter, ] # Record the number of features removed #removed_features &lt;- dim(count.matrix)[1] - length(genes_filter) ####### # Initialize Seurat object seurat_object &lt;- CreateSeuratObject(counts = count.matrix, project = project) plot_scatter1 &lt;- FeatureScatter(seurat_object, feature1 = &quot;nCount_RNA&quot;, feature2 = &quot;nFeature_RNA&quot;) + geom_smooth(method = &quot;lm&quot;) + NoLegend() + labs(title = &quot;Association between reads and \\nunique genes per cell BEFORE filtering&quot;) plot(plot_scatter1) # Add mitochondrial percentage seurat_object[[&quot;joined&quot;]] &lt;- JoinLayers(seurat_object[[&quot;RNA&quot;]]) seurat_object[[&quot;percent.mt&quot;]] &lt;- PercentageFeatureSet(seurat_object, pattern = &quot;^MT-&quot;) # Plot violin plots p1 &lt;- VlnPlot(seurat_object, features = c(&quot;nFeature_RNA&quot;, &quot;nCount_RNA&quot;, &quot;percent.mt&quot;)) p1 + plot_annotation(title = &quot;QC plots (gene level) BEFORE Filtering&quot;) plot(p1) # Remove low quality cells filt_seurat_object &lt;- subset(seurat_object, subset = nFeature_RNA &gt; min.features &amp; nFeature_RNA &lt; max.features &amp; percent.mt &lt; MT &amp; nCount_RNA &lt; max.counts &amp; nCount_RNA &gt; min.counts) # Plot quality metrics after filtering p2 &lt;- VlnPlot(filt_seurat_object, features = c(&quot;nFeature_RNA&quot;, &quot;nCount_RNA&quot;, &quot;percent.mt&quot;)) p2 + plot_annotation(title = &quot;QC metrics gene level AFTER Filtering&quot;) plot(p2) ####### # Normalize data filt_seurat_object &lt;- NormalizeData(filt_seurat_object, normalization.method = &quot;LogNormalize&quot;, scale.factor = 10000) # Identify highly variable features filt_seurat_object &lt;- FindVariableFeatures(filt_seurat_object, selection.method = &quot;vst&quot;, nfeatures = 2000) # Apply linear transformation all_genes &lt;- rownames(filt_seurat_object) filt_seurat_object &lt;- ScaleData(filt_seurat_object, features = all_genes) # Perform PCA filt_seurat_object &lt;- RunPCA(filt_seurat_object, features = VariableFeatures(object = filt_seurat_object)) # Visualize PCA rst_figures &lt;- append(rst_figures, ElbowPlot(filt_seurat_object)) # Cluster cells filt_seurat_object &lt;- FindNeighbors(filt_seurat_object, dims = 1:npc) filt_seurat_object &lt;- FindClusters(filt_seurat_object, resolution = cluster_res) # Perform UMAP filt_seurat_object &lt;- RunUMAP(filt_seurat_object, dims = 1:npc) ### Filter out doublets (remember to modify doublet rate if samples have variable target cells) ## pK Identification (no ground-truth) --------------------------------------------------------------------------------------- sweep.res.list_pbmc &lt;- paramSweep(filt_seurat_object, PCs = 1:20, sct = FALSE) sweep.stats_pbmc &lt;- summarizeSweep(sweep.res.list_pbmc, GT = FALSE) bcmvn_pbmc &lt;- find.pK(sweep.stats_pbmc) pK &lt;- bcmvn_pbmc %&gt;% filter(BCmetric == max(BCmetric)) %&gt;% dplyr::select(pK) pK &lt;- as.numeric(as.character(pK[[1]])) ## Homotypic Doublet Proportion Estimate ------------------------------------------------------------------------------------- annotations &lt;- filt_seurat_object@meta.data$seurat_clusters homotypic.prop &lt;- modelHomotypic(annotations) nExp_poi &lt;- round(doublet_rate * nrow(filt_seurat_object@meta.data)) nExp_poi.adj &lt;- round(nExp_poi * (1 - homotypic.prop)) # Run doubletFinder filt_seurat_object &lt;- doubletFinder(filt_seurat_object, PCs = 1:20, pN = 0.25, pK = pK, nExp = nExp_poi.adj, reuse.pANN = FALSE, sct = FALSE) colnames(filt_seurat_object@meta.data) &lt;- sub(&quot;DF.classifications_.*$&quot;, &quot;DF.classifications&quot;, colnames(filt_seurat_object@meta.data)) # Summary doublets statsDoublets &lt;- filt_seurat_object@meta.data %&gt;% group_by(DF.classifications) %&gt;% dplyr::summarize(Median_nCount_RNA = median(nCount_RNA), Median_nFeature_RNA = median(nFeature_RNA), Count = n()) # Visualize doublets doublets &lt;- DimPlot(filt_seurat_object, reduction = &#39;umap&#39;, group.by = &quot;DF.classifications&quot;) ### Save the seurat object with doublets listed filt_seurat_object_doublets &lt;- filt_seurat_object filt_seurat_object &lt;- subset(filt_seurat_object, subset = DF.classifications == &#39;Singlet&#39;) # figures ggplot_list &lt;- list( ElbowPlot(filt_seurat_object) + labs(title = &#39;SD explained by each PC&#39;) + theme(text = element_text(size = 10)), FeatureScatter(filt_seurat_object, feature1 = &quot;nCount_RNA&quot;, feature2 = &quot;nFeature_RNA&quot;) + geom_smooth(method = &quot;lm&quot;) + NoLegend() + labs(title = &quot;Association between reads and \\nunique genes per cell AFTER filtering&quot;), DimPlot(filt_seurat_object, reduction = &quot;umap&quot;) + labs(color = &quot;Cluster \\n(from PCA)&quot;, title = &#39;&#39;) + theme(text = element_text(size = 10)), FeaturePlot(filt_seurat_object, reduction = &quot;umap&quot;, features = &#39;nCount_RNA&#39;) + labs(color = &quot;UMI count&quot;, title = &#39;&#39;) + theme(text = element_text(size = 10)), FeaturePlot(filt_seurat_object, reduction = &quot;umap&quot;, features = &#39;nFeature_RNA&#39;) + labs(color = str_wrap(&quot;Feature count (gene)&quot;, 15), title = &#39;&#39;) + theme(text = element_text(size = 10)), p2 ) combined_plots &lt;- plot_grid(plotlist = ggplot_list, ncol = 3) plot(combined_plots) plot(DimPlot(filt_seurat_object_doublets, reduction = &#39;umap&#39;, group.by = &quot;DF.classifications&quot;)) tbl_sts1 &lt;- tableGrob(statsDoublets) grid.newpage() grid.draw(tbl_sts1) # summary stats stats_summary &lt;- rbind(&quot;Sample ID&quot; = project, &quot;Cells_before_filter&quot; = dim(seurat_object)[2], &quot;Cells_after_filter&quot; = dim(filt_seurat_object)[2], &quot;Median Feature per Cell before filter&quot; = median(seurat_object$nFeature_RNA), &quot;Median Reads per Gene before filter&quot; = median(seurat_object$nCount_RNA), &quot;Median Feature per Cell&quot; = median(filt_seurat_object$nFeature_RNA), &quot;Median Reads per Gene&quot; = median(filt_seurat_object$nCount_RNA), &quot;Max Features&quot; = max.features, &quot;Min Features&quot; = min.features, &quot;Min Counts&quot; = min.counts, &quot;Max Counts&quot; = max.counts, &quot;MT Percentage&quot; = MT, &quot;NPCs&quot; = npc, &quot;Median Percent MT before Filter&quot; = median(seurat_object@meta.data[[&quot;percent.mt&quot;]]), &quot;Median Percent MT after Filter&quot; = median(filt_seurat_object@meta.data[[&quot;percent.mt&quot;]]) ) tbl_sts2 &lt;- tableGrob(stats_summary) grid.newpage() grid.draw(tbl_sts2) list(filt_seurat_object, statsDoublets, stats_summary, filt_seurat_object_doublets) } Convert Oarfish files to a count matrix This is a function to take all Oarfish files from FLAMES multisample output folder and convert the files into a gene count matrix that contains gene symbol ids instead of ENSGIDs. To use this function ensure that the isoform_gene_dict.csv file has been generated as described in @ref(creating-resource-files.). Code ### readSeurat### read in Oarfish count files and add them to seurat objects ### process_oarfish_files_to_counts_matrix &lt;- function(sample_name, resource_table_path, output_dir, input_dir, filter_bambu_Genes = TRUE) { # Load required libraries library(Matrix) library(dplyr) library(data.table) # Read in the resource table (transcript_id, gene_id, gene_symbol) combined_data &lt;- fread(resource_table_path) # Define the file paths based on the sample name # Construct file paths count_matrix_path &lt;- file.path(input_dir, paste0(sample_name, &quot;.count.mtx&quot;)) barcodes_path &lt;- file.path(input_dir, paste0(sample_name, &quot;.barcodes.txt&quot;)) features_path &lt;- file.path(input_dir, paste0(sample_name, &quot;.features.txt&quot;)) # Read the data counts &lt;- readMM(count_matrix_path) barcodes &lt;- readLines(barcodes_path) features &lt;- read.delim(features_path, header = FALSE) # Transpose the matrix if needed (for Seurat compatibility) counts &lt;- t(counts) # Set row and column names rownames(counts) &lt;- features$V1 colnames(counts) &lt;- barcodes # Convert to a data frame counts_df &lt;- as.data.frame(counts) # Add transcript_id as the first column counts_df$transcript_id &lt;- rownames(counts_df) counts_df &lt;- counts_df[, c(ncol(counts_df), 1:(ncol(counts_df)-1))] # Merge with the resource table to add gene symbols df_genesymbol &lt;- counts_df %&gt;% left_join(combined_data, by = &quot;transcript_id&quot;) # Optionally filter out any gene_id containing &quot;BambuGene&quot; if (filter_bambu_Genes) { df_genesymbol &lt;- df_genesymbol %&gt;% dplyr::filter(!grepl(&quot;BambuGene&quot;, gene_id, fixed = TRUE)) } # Remove the gene_id column and reorder the columns df_genesymbol$gene_id &lt;- NULL df_genesymbol &lt;- df_genesymbol[, c(ncol(df_genesymbol), 1:(ncol(df_genesymbol)-1))] # Update row names to include gene symbol instead of transcript_id rownames(df_genesymbol) &lt;- paste0(df_genesymbol$transcript_id, &quot;_&quot;, df_genesymbol$gene_symbol) df_genesymbol$transcript_id &lt;- NULL df_genesymbol$gene_symbol &lt;- NULL # Write the output to a CSV file output_path &lt;- file.path(output_dir, paste0(&quot;gene_symbol_oarfish_&quot;, sample_name, &quot;_counts.csv&quot;)) fwrite(df_genesymbol, output_path, row.names = TRUE) cat(&quot;Processed sample:&quot;, sample_name, &quot;\\nOutput saved to:&quot;, output_path, &quot;\\n&quot;) } # Example usage: # List of sample names sample_names &lt;- c(&quot;C1_STC&quot;) #create a resource # Call the helper function defined in code block above to create a dictionary containing corresponding gene information for each isoform # This may take a few minutes # The FLAMES ref can be found in your selected output folder after running the Flames pipeline. FLAMES_gtf_file &lt;- &quot;./data/muti_sample/isoform_annotated.gtf&quot; #ensure file is unzipped reference_gtf_file &lt;- &quot;./data/gencode.v47.annotation.gtf&quot; # ensure file is unzipped output_file &lt;- &quot;multi_isoform_gene_dict.csv&quot; isoform_gene_dict &lt;- make_isoform_gene_symbol_dict(FLAMES_gtf_file, reference_gtf_file, output_file) # run this in the output FLAMES dir # Loop through each sample and process the count files for (sample in sample_names) { # Use tryCatch to handle errors tryCatch({ # Call the function to process the sample process_oarfish_files_to_counts_matrix( sample_name = sample, resource_table_path = &quot;./output_files/ref_files/multi_isoform_gene_dict.csv&quot;, output_dir = &quot;./output_files/mutli_sample/oarfish_counts&quot;, input_dir = &quot;./output_files/mutli_sample/oarfish_counts&quot; ) }, error = function(e) { # Print the error message and exit the loop cat(&quot;Error processing sample:&quot;, sample, &quot;\\nError message:&quot;, e$message, &quot;\\nExiting loop.\\n&quot;) stop(e) }) } "]]
