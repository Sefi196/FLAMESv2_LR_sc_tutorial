<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 10 Multisample analysis | Long-read Single-Cell RNA-seq analysis tutorial</title>
  <meta name="description" content="Chapter 10 Multisample analysis | Long-read Single-Cell RNA-seq analysis tutorial" />
  <meta name="generator" content="bookdown 0.41 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 10 Multisample analysis | Long-read Single-Cell RNA-seq analysis tutorial" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 10 Multisample analysis | Long-read Single-Cell RNA-seq analysis tutorial" />
  
  
  

<meta name="author" content="Sefi Prawer Postdoctoral Research Fellow in Long Reads and Single-Cell Transcriptomics University of Melbourne" />


<meta name="date" content="2025-11-28" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="profiling-isoform-diversity.html"/>
<link rel="next" href="trajectory-analysis.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/codefolding-lua-1.1/codefolding-lua.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Long-read Single-Cell RNA-seq analysis tutorial</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> <strong>Introduction</strong></a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#prerequisites"><i class="fa fa-check"></i><b>1.1</b> Prerequisites</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#getting-started-with-the-data"><i class="fa fa-check"></i><b>1.2</b> Getting Started with the Data</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#dataset-information"><i class="fa fa-check"></i><b>1.3</b> Dataset Information</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#citation"><i class="fa fa-check"></i><b>1.4</b> Citation</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#contact"><i class="fa fa-check"></i><b>1.5</b> Contact</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="setup.html"><a href="setup.html"><i class="fa fa-check"></i><b>2</b> <strong>Setup</strong></a>
<ul>
<li class="chapter" data-level="2.1" data-path="setup.html"><a href="setup.html#load-in-required-packages"><i class="fa fa-check"></i><b>2.1</b> Load in required packages</a></li>
<li class="chapter" data-level="2.2" data-path="setup.html"><a href="setup.html#creating-resource-files."><i class="fa fa-check"></i><b>2.2</b> Creating resource files.</a></li>
<li class="chapter" data-level="2.3" data-path="setup.html"><a href="setup.html#convert-count-matrices-from-gene-id-to-gene-symbol"><i class="fa fa-check"></i><b>2.3</b> Convert count matrices from Gene ID to gene Symbol</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="removing-sources-of-unwanted-noise-from-the-single-cell-dataset.html"><a href="removing-sources-of-unwanted-noise-from-the-single-cell-dataset.html"><i class="fa fa-check"></i><b>3</b> <strong>Removing sources of unwanted noise from the single cell dataset</strong></a>
<ul>
<li class="chapter" data-level="3.1" data-path="removing-sources-of-unwanted-noise-from-the-single-cell-dataset.html"><a href="removing-sources-of-unwanted-noise-from-the-single-cell-dataset.html#empty-droplets"><i class="fa fa-check"></i><b>3.1</b> Empty droplets</a></li>
<li class="chapter" data-level="3.2" data-path="removing-sources-of-unwanted-noise-from-the-single-cell-dataset.html"><a href="removing-sources-of-unwanted-noise-from-the-single-cell-dataset.html#removing-ambient-rna-contamination"><i class="fa fa-check"></i><b>3.2</b> Removing ambient RNA contamination</a></li>
<li class="chapter" data-level="3.3" data-path="removing-sources-of-unwanted-noise-from-the-single-cell-dataset.html"><a href="removing-sources-of-unwanted-noise-from-the-single-cell-dataset.html#standard-gene-qc-to-remove-low-quality-cells"><i class="fa fa-check"></i><b>3.3</b> Standard gene QC to remove low quality cells</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="add-isoform-counts-to-seurat-object.html"><a href="add-isoform-counts-to-seurat-object.html"><i class="fa fa-check"></i><b>4</b> <strong>Add isoform counts to Seurat object</strong></a>
<ul>
<li class="chapter" data-level="4.1" data-path="add-isoform-counts-to-seurat-object.html"><a href="add-isoform-counts-to-seurat-object.html#create-a-seurat-object-with-isoform-expression-data"><i class="fa fa-check"></i><b>4.1</b> Create a Seurat object with isoform expression data</a></li>
<li class="chapter" data-level="4.2" data-path="add-isoform-counts-to-seurat-object.html"><a href="add-isoform-counts-to-seurat-object.html#filter-the-new-seurat-object-based-on-gene-level-information"><i class="fa fa-check"></i><b>4.2</b> Filter the new Seurat object based on gene level information</a></li>
<li class="chapter" data-level="4.3" data-path="add-isoform-counts-to-seurat-object.html"><a href="add-isoform-counts-to-seurat-object.html#add-the-isoform-assay-to-the-seurat-object"><i class="fa fa-check"></i><b>4.3</b> Add the isoform assay to the Seurat object</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="finding-marker-genes-and-isoforms.html"><a href="finding-marker-genes-and-isoforms.html"><i class="fa fa-check"></i><b>5</b> <strong>Finding marker genes and isoforms</strong></a>
<ul>
<li class="chapter" data-level="5.1" data-path="finding-marker-genes-and-isoforms.html"><a href="finding-marker-genes-and-isoforms.html#differentially-expressed-genes-by-cluster-identity"><i class="fa fa-check"></i><b>5.1</b> Differentially expressed genes by cluster identity</a></li>
<li class="chapter" data-level="5.2" data-path="finding-marker-genes-and-isoforms.html"><a href="finding-marker-genes-and-isoforms.html#identifying-cell-types"><i class="fa fa-check"></i><b>5.2</b> Identifying cell types</a></li>
<li class="chapter" data-level="5.3" data-path="finding-marker-genes-and-isoforms.html"><a href="finding-marker-genes-and-isoforms.html#de-genes-and-isoforms-based-on-annotated-cell-types."><i class="fa fa-check"></i><b>5.3</b> DE genes and isoforms based on annotated cell types.</a></li>
<li class="chapter" data-level="5.4" data-path="finding-marker-genes-and-isoforms.html"><a href="finding-marker-genes-and-isoforms.html#volcano-plots"><i class="fa fa-check"></i><b>5.4</b> Volcano plots</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="finding-marker-genes-and-isoforms.html"><a href="finding-marker-genes-and-isoforms.html#findallmarkers-de"><i class="fa fa-check"></i><b>5.4.1</b> FindAllMarkers DE</a></li>
<li class="chapter" data-level="5.4.2" data-path="finding-marker-genes-and-isoforms.html"><a href="finding-marker-genes-and-isoforms.html#findmarkers-de"><i class="fa fa-check"></i><b>5.4.2</b> FindMarkers DE</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="exploring-isoforms-of-interest.html"><a href="exploring-isoforms-of-interest.html"><i class="fa fa-check"></i><b>6</b> <strong>Exploring isoforms of interest</strong></a>
<ul>
<li class="chapter" data-level="6.1" data-path="exploring-isoforms-of-interest.html"><a href="exploring-isoforms-of-interest.html#isoforms-expressed-per-gene"><i class="fa fa-check"></i><b>6.1</b> Isoforms expressed per gene</a></li>
<li class="chapter" data-level="6.2" data-path="exploring-isoforms-of-interest.html"><a href="exploring-isoforms-of-interest.html#top-10-genes-with-most-isoforms"><i class="fa fa-check"></i><b>6.2</b> Top 10 Genes with Most Isoforms</a></li>
<li class="chapter" data-level="6.3" data-path="exploring-isoforms-of-interest.html"><a href="exploring-isoforms-of-interest.html#exploring-macf1-isoforms"><i class="fa fa-check"></i><b>6.3</b> Exploring <em>MACF1</em> isoforms</a></li>
<li class="chapter" data-level="6.4" data-path="exploring-isoforms-of-interest.html"><a href="exploring-isoforms-of-interest.html#expression-of-macf1-isoforms-across-cell-types"><i class="fa fa-check"></i><b>6.4</b> Expression of <em>MACF1</em> isoforms Across Cell Types</a></li>
<li class="chapter" data-level="6.5" data-path="exploring-isoforms-of-interest.html"><a href="exploring-isoforms-of-interest.html#visualization-of-isoform-structures"><i class="fa fa-check"></i><b>6.5</b> Visualization of Isoform Structures</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="isoform-classification.html"><a href="isoform-classification.html"><i class="fa fa-check"></i><b>7</b> <strong>Isoform Classification</strong></a>
<ul>
<li class="chapter" data-level="7.1" data-path="isoform-classification.html"><a href="isoform-classification.html#classification-with-sqanti"><i class="fa fa-check"></i><b>7.1</b> Classification with SQANTI</a></li>
<li class="chapter" data-level="7.2" data-path="isoform-classification.html"><a href="isoform-classification.html#cell-type-specific-isoforms"><i class="fa fa-check"></i><b>7.2</b> Cell type specific isoforms</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="novel-isoforms.html"><a href="novel-isoforms.html"><i class="fa fa-check"></i><b>8</b> <strong>Novel isoforms</strong></a>
<ul>
<li class="chapter" data-level="8.1" data-path="novel-isoforms.html"><a href="novel-isoforms.html#find-all-the-genes-that-express-at-least-1-novel-isoform"><i class="fa fa-check"></i><b>8.1</b> Find all the genes that express at least 1 novel isoform</a></li>
<li class="chapter" data-level="8.2" data-path="novel-isoforms.html"><a href="novel-isoforms.html#visualising-oaz2-novel-isoform"><i class="fa fa-check"></i><b>8.2</b> Visualising OAZ2 novel isoform</a></li>
<li class="chapter" data-level="8.3" data-path="novel-isoforms.html"><a href="novel-isoforms.html#functional-impacts-of-novel-isoforms"><i class="fa fa-check"></i><b>8.3</b> Functional impacts of novel isoforms</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="profiling-isoform-diversity.html"><a href="profiling-isoform-diversity.html"><i class="fa fa-check"></i><b>9</b> <strong>Profiling Isoform Diversity</strong></a>
<ul>
<li class="chapter" data-level="9.1" data-path="profiling-isoform-diversity.html"><a href="profiling-isoform-diversity.html#measuring-entropy-with-find_diversity-function"><i class="fa fa-check"></i><b>9.1</b> Measuring entropy with <code>find_diversity()</code> function</a></li>
<li class="chapter" data-level="9.2" data-path="profiling-isoform-diversity.html"><a href="profiling-isoform-diversity.html#example-of-a-low-entropy-gene"><i class="fa fa-check"></i><b>9.2</b> Example of a low entropy gene</a></li>
<li class="chapter" data-level="9.3" data-path="profiling-isoform-diversity.html"><a href="profiling-isoform-diversity.html#example-of-a-high-entropy-gene"><i class="fa fa-check"></i><b>9.3</b> Example of a high entropy gene</a></li>
<li class="chapter" data-level="9.4" data-path="profiling-isoform-diversity.html"><a href="profiling-isoform-diversity.html#broadening-entropy-analysis"><i class="fa fa-check"></i><b>9.4</b> Broadening Entropy Analysis</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="multisample-analysis.html"><a href="multisample-analysis.html"><i class="fa fa-check"></i><b>10</b> <strong>Multisample analysis</strong></a>
<ul>
<li class="chapter" data-level="10.0.1" data-path="multisample-analysis.html"><a href="multisample-analysis.html#dataset-information-1"><i class="fa fa-check"></i><b>10.0.1</b> Dataset Information</a></li>
<li class="chapter" data-level="10.1" data-path="multisample-analysis.html"><a href="multisample-analysis.html#standard-pre-processing-and-quality-control"><i class="fa fa-check"></i><b>10.1</b> Standard pre-processing and quality control</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="multisample-analysis.html"><a href="multisample-analysis.html#define-qc-function"><i class="fa fa-check"></i><b>10.1.1</b> Define QC function</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="multisample-analysis.html"><a href="multisample-analysis.html#multisample-integration"><i class="fa fa-check"></i><b>10.2</b> Multisample integration</a></li>
<li class="chapter" data-level="10.3" data-path="multisample-analysis.html"><a href="multisample-analysis.html#add-isoform-counts"><i class="fa fa-check"></i><b>10.3</b> Add isoform counts</a></li>
<li class="chapter" data-level="10.4" data-path="multisample-analysis.html"><a href="multisample-analysis.html#identify-cell-types"><i class="fa fa-check"></i><b>10.4</b> Identify cell types</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html"><i class="fa fa-check"></i><b>11</b> <strong>Trajectory analysis</strong></a>
<ul>
<li class="chapter" data-level="11.1" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#running-pseudotime-analysis-on-genes"><i class="fa fa-check"></i><b>11.1</b> Running pseudotime analysis on genes</a></li>
<li class="chapter" data-level="11.2" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#running-pseudotime-analysis-on-isoforms"><i class="fa fa-check"></i><b>11.2</b> Running pseudotime analysis on isoforms</a></li>
<li class="chapter" data-level="11.3" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#summary-and-downstream-applications"><i class="fa fa-check"></i><b>11.3</b> Summary and downstream applications</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="differential-transcript-usage-dtu.html"><a href="differential-transcript-usage-dtu.html"><i class="fa fa-check"></i><b>12</b> <strong>Differential Transcript Usage (DTU)</strong></a>
<ul>
<li class="chapter" data-level="12.1" data-path="differential-transcript-usage-dtu.html"><a href="differential-transcript-usage-dtu.html#preparing-the-data-for-dtu-analysis"><i class="fa fa-check"></i><b>12.1</b> Preparing the data for DTU analysis</a></li>
<li class="chapter" data-level="12.2" data-path="differential-transcript-usage-dtu.html"><a href="differential-transcript-usage-dtu.html#generating-a-switchlist"><i class="fa fa-check"></i><b>12.2</b> Generating a SwitchList</a></li>
<li class="chapter" data-level="12.3" data-path="differential-transcript-usage-dtu.html"><a href="differential-transcript-usage-dtu.html#visualising-dtu-hits"><i class="fa fa-check"></i><b>12.3</b> Visualising DTU Hits</a></li>
<li class="chapter" data-level="12.4" data-path="differential-transcript-usage-dtu.html"><a href="differential-transcript-usage-dtu.html#final-thoughts"><i class="fa fa-check"></i><b>12.4</b> Final thoughts</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="conclusion.html"><a href="conclusion.html"><i class="fa fa-check"></i><strong>Conclusion</strong></a>
<ul>
<li class="chapter" data-level="" data-path="conclusion.html"><a href="conclusion.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
<li class="chapter" data-level="" data-path="conclusion.html"><a href="conclusion.html#session-info"><i class="fa fa-check"></i>Session info</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><strong>References</strong></a></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html"><i class="fa fa-check"></i><strong>Appendix</strong></a>
<ul>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html#calculating-the-ambient-rna-profile"><i class="fa fa-check"></i>Calculating the ambient RNA profile</a></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html#multisample-qc-function"><i class="fa fa-check"></i>Multisample QC function</a></li>
<li class="chapter" data-level="" data-path="appendix.html"><a href="appendix.html#convert-oarfish-files-to-a-count-matrix"><i class="fa fa-check"></i>Convert Oarfish files to a count matrix</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Long-read Single-Cell RNA-seq analysis tutorial</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="multisample-analysis" class="section level1 hasAnchor" number="10">
<h1><span class="header-section-number">Chapter 10</span> <strong>Multisample analysis</strong><a href="multisample-analysis.html#multisample-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The FLAMES pipeline supports the analysis of <strong>multiple samples simultaneously</strong>, allowing users to handle more complex experimental designs without having to process each sample independently. This is implemented through the <code>FLAMES::MultiSampleSCPipeline()</code> function, which produces outputs that are analogous to the single-sample workflow described in earlier chapters, but extends it to multi-sample experiments and ensures that novel isoform discovery is performed consistently across the entire dataset.</p>
<p>To take full advantage of these features, we first need to perform a few initial processing steps:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Sample QC</strong> – Basic preprocessing and quality control are largely the same as for a single sample. Here, we also show how to start directly from FLAMES output and perform initial QC <em>without</em> empty droplet removal or ambient RNA normalisation. These extra steps are recommended, but may not always be required depending on the dataset.</p></li>
<li><p><strong>Sample integration</strong> – Combining multiple samples into a single integrated object to remove batch effects and align shared biological structure.</p></li>
<li><p><strong>Adding isoform counts</strong> – Incorporating isoform-level counts into the integrated Seurat object so that gene- and isoform-level analyses can be performed side by side.</p></li>
<li><p><strong>Cell type identification</strong> – Annotating the integrated object with biologically meaningful cell type labels.</p></li>
</ol>
<p>In this chapter, we will walk through these steps using a small subset of a multi-sample dataset (described below). Once we have an integrated object that contains both gene and isoform counts, we can use it as the foundation for a range of downstream analyses. In the following chapters, we will illustrate two key examples:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Trajectory analysis</strong> – using pseudotime to identify genes and isoforms that change along differentiation paths.</p></li>
<li><p><strong>Differential transcript usage (DTU) analysis</strong> – investigating changes in isoform proportions between conditions.</p></li>
</ol>
<hr />
<div id="dataset-information-1" class="section level3 hasAnchor" number="10.0.1">
<h3><span class="header-section-number">10.0.1</span> Dataset Information<a href="multisample-analysis.html#dataset-information-1" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For this analysis, we use a subset of the neuronal differentiation dataset described in <span class="citation">Wang et al. (<a href="references.html#ref-wang2025" role="doc-biblioref">2025</a>)</span>. The full dataset contains eight samples spanning four time points from an excitatory neuronal differentiation protocol. To keep the tutorial runtime manageable, we randomly selected 2000 cells in total drawn from four samples at the first two timepoints: two stem cell (STC) samples and two Day 25 samples. This subset still captures the early stages of neuronal differentiation and allows us to explore temporal changes in gene and isoform expression between stem cells and early neuronal progenitors.</p>
</div>
<div id="standard-pre-processing-and-quality-control" class="section level2 hasAnchor" number="10.1">
<h2><span class="header-section-number">10.1</span> Standard pre-processing and quality control<a href="multisample-analysis.html#standard-pre-processing-and-quality-control" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>As before we will modify the count matrix for each sample so we use gene_symbol instead of ENSGID. The data generated from this multisample experiment is quite large. This is especially the case with Oarfish isoform quantification as there are many more features to consider. This means much of the workflow below is time consuming and computationally intensive. Please keep this in mind when processing your samples. In the tutorial we provide code for the required steps but do not evaluate many of the sections below due to these computational constraints. The raw counts are available in the multisample data folder if users wish to run through the analysis.</p>
<p>First we will make the isoform gene dictionary for the mutisample mode.</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb139"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb139-1"><a href="multisample-analysis.html#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The FLAMES ref can be found in your selected output folder after running the Flames pipeline. </span></span>
<span id="cb139-2"><a href="multisample-analysis.html#cb139-2" aria-hidden="true" tabindex="-1"></a>FLAMES_gtf_file <span class="ot">&lt;-</span> <span class="st">&quot;data/multi_sample_subset/isoform_annotated.gtf&quot;</span> <span class="co">#ensure file is unzipped</span></span>
<span id="cb139-3"><a href="multisample-analysis.html#cb139-3" aria-hidden="true" tabindex="-1"></a>reference_gtf_file <span class="ot">&lt;-</span> <span class="st">&quot;data/gencode.v47.annotation.gtf&quot;</span> <span class="co"># ensure file is unzipped</span></span>
<span id="cb139-4"><a href="multisample-analysis.html#cb139-4" aria-hidden="true" tabindex="-1"></a>output_file <span class="ot">&lt;-</span> <span class="st">&quot;isoform_gene_dict_mutlisample_subset.csv&quot;</span></span>
<span id="cb139-5"><a href="multisample-analysis.html#cb139-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-6"><a href="multisample-analysis.html#cb139-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Call the helper function defined in code block above to create a dictionary containing corresponding gene information for each isoform</span></span>
<span id="cb139-7"><a href="multisample-analysis.html#cb139-7" aria-hidden="true" tabindex="-1"></a><span class="co"># This may take a few minutes </span></span>
<span id="cb139-8"><a href="multisample-analysis.html#cb139-8" aria-hidden="true" tabindex="-1"></a>isoform_gene_dict_mutlisample <span class="ot">&lt;-</span> <span class="fu">make_isoform_gene_symbol_dict</span>(FLAMES_gtf_file,</span>
<span id="cb139-9"><a href="multisample-analysis.html#cb139-9" aria-hidden="true" tabindex="-1"></a>                                                   reference_gtf_file,</span>
<span id="cb139-10"><a href="multisample-analysis.html#cb139-10" aria-hidden="true" tabindex="-1"></a>                                                   output_file)</span></code></pre></div>
</details>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb140"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb140-1"><a href="multisample-analysis.html#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert Gene_id to gene symbol for all counts</span></span>
<span id="cb140-2"><a href="multisample-analysis.html#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="co">#run a loop to run this function on all count files.</span></span>
<span id="cb140-3"><a href="multisample-analysis.html#cb140-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Directory with input files</span></span>
<span id="cb140-4"><a href="multisample-analysis.html#cb140-4" aria-hidden="true" tabindex="-1"></a>input_dir <span class="ot">&lt;-</span> <span class="st">&quot;./data/multi_sample_subset/&quot;</span></span>
<span id="cb140-5"><a href="multisample-analysis.html#cb140-5" aria-hidden="true" tabindex="-1"></a>output_dir <span class="ot">&lt;-</span> <span class="st">&quot;./data/multi_sample_subset/&quot;</span></span>
<span id="cb140-6"><a href="multisample-analysis.html#cb140-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-7"><a href="multisample-analysis.html#cb140-7" aria-hidden="true" tabindex="-1"></a><span class="co"># List all CSV files in the input directory</span></span>
<span id="cb140-8"><a href="multisample-analysis.html#cb140-8" aria-hidden="true" tabindex="-1"></a>input_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(input_dir, <span class="at">pattern =</span> <span class="st">&quot;</span><span class="sc">\\</span><span class="st">count_subset.csv$&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb140-9"><a href="multisample-analysis.html#cb140-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-10"><a href="multisample-analysis.html#cb140-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize an empty list to store data frames</span></span>
<span id="cb140-11"><a href="multisample-analysis.html#cb140-11" aria-hidden="true" tabindex="-1"></a>result_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb140-12"><a href="multisample-analysis.html#cb140-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-13"><a href="multisample-analysis.html#cb140-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Process each file in the directory</span></span>
<span id="cb140-14"><a href="multisample-analysis.html#cb140-14" aria-hidden="true" tabindex="-1"></a>total_files <span class="ot">&lt;-</span> <span class="fu">length</span>(input_files)  <span class="co"># Total number of files</span></span>
<span id="cb140-15"><a href="multisample-analysis.html#cb140-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-16"><a href="multisample-analysis.html#cb140-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(input_files)) {</span>
<span id="cb140-17"><a href="multisample-analysis.html#cb140-17" aria-hidden="true" tabindex="-1"></a>  file_path <span class="ot">&lt;-</span> input_files[i]</span>
<span id="cb140-18"><a href="multisample-analysis.html#cb140-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-19"><a href="multisample-analysis.html#cb140-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract file name without extension</span></span>
<span id="cb140-20"><a href="multisample-analysis.html#cb140-20" aria-hidden="true" tabindex="-1"></a>  file_name <span class="ot">&lt;-</span> tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(<span class="fu">basename</span>(file_path))</span>
<span id="cb140-21"><a href="multisample-analysis.html#cb140-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-22"><a href="multisample-analysis.html#cb140-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Construct the output file name</span></span>
<span id="cb140-23"><a href="multisample-analysis.html#cb140-23" aria-hidden="true" tabindex="-1"></a>  output_file <span class="ot">&lt;-</span> <span class="fu">file.path</span>(output_dir, <span class="fu">paste0</span>(file_name, <span class="st">&quot;_gene_symbol.csv&quot;</span>))</span>
<span id="cb140-24"><a href="multisample-analysis.html#cb140-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-25"><a href="multisample-analysis.html#cb140-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Show progress to the user</span></span>
<span id="cb140-26"><a href="multisample-analysis.html#cb140-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Processing file %d of %d: %s&quot;</span>, i, total_files, file_name))</span>
<span id="cb140-27"><a href="multisample-analysis.html#cb140-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb140-28"><a href="multisample-analysis.html#cb140-28" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Call the function with return_df = TRUE to store the result</span></span>
<span id="cb140-29"><a href="multisample-analysis.html#cb140-29" aria-hidden="true" tabindex="-1"></a>    result_list[[file_name]] <span class="ot">&lt;-</span> <span class="fu">convert_ENSGID_to_geneSymbol</span>(</span>
<span id="cb140-30"><a href="multisample-analysis.html#cb140-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">id_symbol_df =</span> isoform_gene_dict_mutlisample,</span>
<span id="cb140-31"><a href="multisample-analysis.html#cb140-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">gene_count_matrix_path =</span> file_path,</span>
<span id="cb140-32"><a href="multisample-analysis.html#cb140-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">output_file =</span> output_file,</span>
<span id="cb140-33"><a href="multisample-analysis.html#cb140-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">return_df =</span> <span class="cn">TRUE</span></span>
<span id="cb140-34"><a href="multisample-analysis.html#cb140-34" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb140-35"><a href="multisample-analysis.html#cb140-35" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</details>
<pre><code>## Processing file 1 of 4: C1_STC_matched_reads_gene_count_subset</code></pre>
<pre><code>## Processing file 2 of 4: C2_Day25_matched_reads_gene_count_subset</code></pre>
<pre><code>## Processing file 3 of 4: C4_STC_matched_reads_gene_count_subset</code></pre>
<pre><code>## Processing file 4 of 4: C5_Day25_matched_reads_gene_count_subset</code></pre>
<div id="define-qc-function" class="section level3 hasAnchor" number="10.1.1">
<h3><span class="header-section-number">10.1.1</span> Define QC function<a href="multisample-analysis.html#define-qc-function" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We have developed a multisample QC function @ref(Multisample QC function) for processing count matrices and constructing filtered Seurat objects, following best practices outlined in the Seurat tutorial. This function includes steps to identify and remove doublets, as well as generate key diagnostic plots for data inspection. We encourage users to customize this function to fit their specific needs, such as applying additional filtering criteria.</p>
<p>For the purposes of presenting concise and readable code we will apply the default filtering parameters to all objects. If users wish to be more specific about filtering each sample independently this is possible and can be done by running the <code>perform_qc_filtering</code> function on each sample with desired parameters.</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb145"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb145-1"><a href="multisample-analysis.html#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define sample names</span></span>
<span id="cb145-2"><a href="multisample-analysis.html#cb145-2" aria-hidden="true" tabindex="-1"></a>sample_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;C1_STC&quot;</span>, <span class="st">&quot;C4_STC&quot;</span>, <span class="st">&quot;C2_Day25&quot;</span>, <span class="st">&quot;C5_Day25&quot;</span>)</span>
<span id="cb145-3"><a href="multisample-analysis.html#cb145-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-4"><a href="multisample-analysis.html#cb145-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize a list to store UMAP objects</span></span>
<span id="cb145-5"><a href="multisample-analysis.html#cb145-5" aria-hidden="true" tabindex="-1"></a>umap_objects <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb145-6"><a href="multisample-analysis.html#cb145-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-7"><a href="multisample-analysis.html#cb145-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Start the PDF for output</span></span>
<span id="cb145-8"><a href="multisample-analysis.html#cb145-8" aria-hidden="true" tabindex="-1"></a><span class="fu">pdf</span>(<span class="at">file =</span> <span class="st">&quot;./output_files/multi_sample_subset/QC/multisample_QC.pdf&quot;</span>, <span class="at">width =</span> <span class="dv">10</span>, <span class="at">height =</span> <span class="dv">6</span>)</span>
<span id="cb145-9"><a href="multisample-analysis.html#cb145-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-10"><a href="multisample-analysis.html#cb145-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each sample and apply the QC filtering function</span></span>
<span id="cb145-11"><a href="multisample-analysis.html#cb145-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(sample_names)) {</span>
<span id="cb145-12"><a href="multisample-analysis.html#cb145-12" aria-hidden="true" tabindex="-1"></a>  sample_name <span class="ot">&lt;-</span> sample_names[i]</span>
<span id="cb145-13"><a href="multisample-analysis.html#cb145-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-14"><a href="multisample-analysis.html#cb145-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Print progress message</span></span>
<span id="cb145-15"><a href="multisample-analysis.html#cb145-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">paste0</span>(<span class="st">&quot;Processing sample &quot;</span>, i, <span class="st">&quot; of &quot;</span>, <span class="fu">length</span>(sample_names), <span class="st">&quot;: &quot;</span>, sample_name))</span>
<span id="cb145-16"><a href="multisample-analysis.html#cb145-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-17"><a href="multisample-analysis.html#cb145-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Perform QC filtering</span></span>
<span id="cb145-18"><a href="multisample-analysis.html#cb145-18" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">perform_qc_filtering</span>(</span>
<span id="cb145-19"><a href="multisample-analysis.html#cb145-19" aria-hidden="true" tabindex="-1"></a>    result_list[<span class="fu">paste0</span>(sample_name, <span class="st">&quot;_matched_reads_gene_count_subset&quot;</span>)],</span>
<span id="cb145-20"><a href="multisample-analysis.html#cb145-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">fig_name =</span> sample_name,</span>
<span id="cb145-21"><a href="multisample-analysis.html#cb145-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">project =</span> sample_name</span>
<span id="cb145-22"><a href="multisample-analysis.html#cb145-22" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb145-23"><a href="multisample-analysis.html#cb145-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb145-24"><a href="multisample-analysis.html#cb145-24" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Store the UMAP object from the result</span></span>
<span id="cb145-25"><a href="multisample-analysis.html#cb145-25" aria-hidden="true" tabindex="-1"></a>  umap_objects[[sample_name]] <span class="ot">&lt;-</span> result[[<span class="dv">1</span>]]</span>
<span id="cb145-26"><a href="multisample-analysis.html#cb145-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb145-27"><a href="multisample-analysis.html#cb145-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-28"><a href="multisample-analysis.html#cb145-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Close the PDF device</span></span>
<span id="cb145-29"><a href="multisample-analysis.html#cb145-29" aria-hidden="true" tabindex="-1"></a><span class="fu">dev.off</span>()</span>
<span id="cb145-30"><a href="multisample-analysis.html#cb145-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-31"><a href="multisample-analysis.html#cb145-31" aria-hidden="true" tabindex="-1"></a><span class="co">#save the object</span></span>
<span id="cb145-32"><a href="multisample-analysis.html#cb145-32" aria-hidden="true" tabindex="-1"></a><span class="co">#saveRDS(umap_objects, file = &quot;./output_files/multi_sample_subset//umap_objects.rds&quot;)</span></span></code></pre></div>
</details>
</div>
</div>
<div id="multisample-integration" class="section level2 hasAnchor" number="10.2">
<h2><span class="header-section-number">10.2</span> Multisample integration<a href="multisample-analysis.html#multisample-integration" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>First we will merge the Seurat objects together and then perform integration. There are many options for sample integration and Seurat provides many wrappers for these functions. Here we will use Harmony <span class="citation">(<a href="references.html#ref-korsunsky2019" role="doc-biblioref">Korsunsky et al., 2019</a>)</span> for fast and effective integration. The code chunk bellow takes our samples and merges them together.</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb146"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb146-1"><a href="multisample-analysis.html#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co"># integrate samples  </span></span>
<span id="cb146-2"><a href="multisample-analysis.html#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="co">#from the function above pull the filtered seurat object </span></span>
<span id="cb146-3"><a href="multisample-analysis.html#cb146-3" aria-hidden="true" tabindex="-1"></a>umap_objects <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;./output_files/multi_sample_subset//umap_objects.rds&quot;</span>)</span>
<span id="cb146-4"><a href="multisample-analysis.html#cb146-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-5"><a href="multisample-analysis.html#cb146-5" aria-hidden="true" tabindex="-1"></a>merged_seurat <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb146-6"><a href="multisample-analysis.html#cb146-6" aria-hidden="true" tabindex="-1"></a>  umap_objects[[<span class="st">&quot;C1_STC&quot;</span>]],</span>
<span id="cb146-7"><a href="multisample-analysis.html#cb146-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">list</span>(</span>
<span id="cb146-8"><a href="multisample-analysis.html#cb146-8" aria-hidden="true" tabindex="-1"></a>    umap_objects[[<span class="st">&quot;C4_STC&quot;</span>]],</span>
<span id="cb146-9"><a href="multisample-analysis.html#cb146-9" aria-hidden="true" tabindex="-1"></a>    umap_objects[[<span class="st">&quot;C2_Day25&quot;</span>]],</span>
<span id="cb146-10"><a href="multisample-analysis.html#cb146-10" aria-hidden="true" tabindex="-1"></a>    umap_objects[[<span class="st">&quot;C5_Day25&quot;</span>]]</span>
<span id="cb146-11"><a href="multisample-analysis.html#cb146-11" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb146-12"><a href="multisample-analysis.html#cb146-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">add.cell.ids =</span> <span class="fu">c</span>(</span>
<span id="cb146-13"><a href="multisample-analysis.html#cb146-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;C1_STC&quot;</span>, <span class="st">&quot;C4_STC&quot;</span>, <span class="st">&quot;C2_Day25&quot;</span>, <span class="st">&quot;C5_Day25&quot;</span></span>
<span id="cb146-14"><a href="multisample-analysis.html#cb146-14" aria-hidden="true" tabindex="-1"></a>  ), </span>
<span id="cb146-15"><a href="multisample-analysis.html#cb146-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">project =</span> <span class="st">&quot;Multi-sample_tutorial&quot;</span></span>
<span id="cb146-16"><a href="multisample-analysis.html#cb146-16" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb146-17"><a href="multisample-analysis.html#cb146-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-18"><a href="multisample-analysis.html#cb146-18" aria-hidden="true" tabindex="-1"></a><span class="co"># create a sample column</span></span>
<span id="cb146-19"><a href="multisample-analysis.html#cb146-19" aria-hidden="true" tabindex="-1"></a>merged_seurat<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">rownames</span>(merged_seurat<span class="sc">@</span>meta.data)</span>
<span id="cb146-20"><a href="multisample-analysis.html#cb146-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-21"><a href="multisample-analysis.html#cb146-21" aria-hidden="true" tabindex="-1"></a><span class="do">## split sample column to make a batch col</span></span>
<span id="cb146-22"><a href="multisample-analysis.html#cb146-22" aria-hidden="true" tabindex="-1"></a>merged_seurat<span class="sc">@</span>meta.data <span class="ot">&lt;-</span> <span class="fu">separate</span>(merged_seurat<span class="sc">@</span>meta.data, <span class="at">col =</span> <span class="st">&#39;sample&#39;</span>, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&#39;batch&#39;</span>, <span class="st">&#39;Day&#39;</span>, <span class="st">&#39;Barcode&#39;</span>), </span>
<span id="cb146-23"><a href="multisample-analysis.html#cb146-23" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">sep =</span> <span class="st">&#39;_&#39;</span>)</span>
<span id="cb146-24"><a href="multisample-analysis.html#cb146-24" aria-hidden="true" tabindex="-1"></a><span class="co">#check some QC metrics </span></span>
<span id="cb146-25"><a href="multisample-analysis.html#cb146-25" aria-hidden="true" tabindex="-1"></a><span class="fu">VlnPlot</span>(merged_seurat, <span class="at">features =</span> <span class="fu">c</span>(<span class="st">&quot;nFeature_RNA&quot;</span>, <span class="st">&quot;nCount_RNA&quot;</span>, <span class="st">&quot;percent.mt&quot;</span>), <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">group.by =</span> <span class="st">&quot;Day&quot;</span>) <span class="sc">+</span> </span>
<span id="cb146-26"><a href="multisample-analysis.html#cb146-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">plot_annotation</span>(<span class="at">title =</span> <span class="st">&quot;Vln plots grouped by Day&quot;</span>)</span></code></pre></div>
</details>
<p><img src="bookdownproj_files/figure-html/subset_multisample_integration-1.png" width="672" /></p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb147"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb147-1"><a href="multisample-analysis.html#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co">#can plot based on any metadata col</span></span>
<span id="cb147-2"><a href="multisample-analysis.html#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="co">#VlnPlot(merged_seurat, features = c(&quot;nFeature_RNA&quot;, &quot;nCount_RNA&quot;, &quot;percent.mt&quot;), ncol = 3, group.by = &quot;orig.ident&quot;)</span></span>
<span id="cb147-3"><a href="multisample-analysis.html#cb147-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-4"><a href="multisample-analysis.html#cb147-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of cells per group</span></span>
<span id="cb147-5"><a href="multisample-analysis.html#cb147-5" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(merged_seurat<span class="sc">$</span>orig.ident)</span></code></pre></div>
</details>
<pre><code>## 
##   C1_STC C2_Day25   C4_STC C5_Day25 
##      225      330      328      138</code></pre>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb149"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb149-1"><a href="multisample-analysis.html#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(merged_seurat<span class="sc">$</span>Day)</span></code></pre></div>
</details>
<pre><code>## 
## Day25   STC 
##   468   553</code></pre>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb151"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb151-1"><a href="multisample-analysis.html#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply normal preprocessing steps to merged file </span></span>
<span id="cb151-2"><a href="multisample-analysis.html#cb151-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-3"><a href="multisample-analysis.html#cb151-3" aria-hidden="true" tabindex="-1"></a>merged_seurat <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(<span class="at">object =</span> merged_seurat)</span></code></pre></div>
</details>
<pre><code>## Normalizing layer: counts.C1_STC</code></pre>
<pre><code>## Normalizing layer: counts.C4_STC</code></pre>
<pre><code>## Normalizing layer: counts.C2_Day25</code></pre>
<pre><code>## Normalizing layer: counts.C5_Day25</code></pre>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb156"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb156-1"><a href="multisample-analysis.html#cb156-1" aria-hidden="true" tabindex="-1"></a>merged_seurat <span class="ot">&lt;-</span> <span class="fu">FindVariableFeatures</span>(<span class="at">object =</span> merged_seurat)</span></code></pre></div>
</details>
<pre><code>## Finding variable features for layer counts.C1_STC</code></pre>
<pre><code>## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : pseudoinverse used at -2.0512</code></pre>
<pre><code>## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : neighborhood radius 0.30103</code></pre>
<pre><code>## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : reciprocal condition number
## 2.3467e-16</code></pre>
<pre><code>## Finding variable features for layer counts.C4_STC</code></pre>
<pre><code>## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : pseudoinverse used at -2.2148</code></pre>
<pre><code>## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : neighborhood radius 0.30103</code></pre>
<pre><code>## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : reciprocal condition number
## 4.1338e-16</code></pre>
<pre><code>## Finding variable features for layer counts.C2_Day25</code></pre>
<pre><code>## Finding variable features for layer counts.C5_Day25</code></pre>
<pre><code>## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : pseudoinverse used at -1.8388</code></pre>
<pre><code>## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : neighborhood radius 0.30103</code></pre>
<pre><code>## Warning in simpleLoess(y, x, w, span, degree = degree, parametric = parametric, : reciprocal condition number
## 5.5033e-16</code></pre>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb170"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb170-1"><a href="multisample-analysis.html#cb170-1" aria-hidden="true" tabindex="-1"></a>merged_seurat <span class="ot">&lt;-</span> <span class="fu">ScaleData</span>(<span class="at">object =</span> merged_seurat) </span></code></pre></div>
</details>
<pre><code>## Centering and scaling data matrix</code></pre>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb172"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb172-1"><a href="multisample-analysis.html#cb172-1" aria-hidden="true" tabindex="-1"></a>merged_seurat <span class="ot">&lt;-</span> <span class="fu">RunPCA</span>(<span class="at">object =</span> merged_seurat)</span></code></pre></div>
</details>
<pre><code>## PC_ 1 
## Positive:  L1TD1, MGST1, GRID2, CACNA2D3, PRDX1, MT-CO3, HSPA8, GALNT17, POLR3G, ADGRV1 
##     ENSG00000248605, MT-ATP6, RBFOX1, ROR1, SHISA9, GPR176, RBM47, MT-CO2, SNTG2, PTPRG 
##     BNC2, SPATS2L, ENSG00000274090, HDAC2-AS2, MCM3, MT-CYB, FRAS1, ENSG00000203279, RPL22L1, CALN1 
## Negative:  MALAT1, ENSG00000280441, ENSG00000278996, DACH1, ENSG00000280614, ENSG00000280800, ZEB1, ENSG00000281181, SOX5, TUBA1A 
##     DLK1, ENSG00000257060, ENSG00000281383, WNT5B, NNAT, MAP2, ZFHX4, MEIS2, GPM6A, NPAS3 
##     MAPK10, CKB, FGF13, KCNQ3, ZBTB20, GREB1L, VIM, SSBP2, SOX6, LINC01414 
## PC_ 2 
## Positive:  ENSG00000259316, HMGB2, RPS24, SOX2-OT, VIM, DEK, CENPH, HMGN2, PTTG1, TUBA1B 
##     H2AZ2, CDC20, BIRC5, FRZB, LINC01830, MIR99AHG, LIX1, MXD3, H2AX, SMC4 
##     RPS3A, TYMS, CCNB2, MT-ND3, UBE2C, PBK, NUSAP1, ENSG00000285920, CCN1, IGFBP2 
## Negative:  RIMS2, STMN2, AKAP6, NFASC, XKR4, NALF1, CHN2, RMST, GAP43, KIF5C 
##     PCSK2, NRXN1, ANK3, PTPRD, ERC2, CADPS, NSG2, MYT1L, CACNA2D1, ENSG00000283982 
##     LINC01917, CTNNA2, ELAVL2, PBX1, CELF3, SLIT1, INA, DST, ELAVL4, CACNA1B 
## PC_ 3 
## Positive:  JPT1, TUBB2A, TMSB10, UBE2S, RBP1, S100A11, CRABP1, TUBB, BDNF-AS, NEFM 
##     PLAAT3, S100A10, TUBB2B, STMN2, ID2, DYNLL1, INA, IGFBPL1, MT1X, GDAP1L1 
##     GNG8, ST18, GAP43, CELF3, ID3, INSM1, TAGLN, PCSK1N, NSG2, LDHA 
## Negative:  GPC6, FBXL7, B3GALT1, FAT3, DLG2, ENSG00000228222, QKI, EFNA5, PLEKHA5, PARD3B 
##     XYLT1, TOX, NRG3, LINC03077, STK3, NLGN1, PTPRK, KCNT2, SDK1, EXT1 
##     GRIP1, RAD51B, PRKD1, DAB1, LDB2, SUPT3H, CDK14, TTC28, NAV3, KIAA1217 
## PC_ 4 
## Positive:  DANT2, RPL22L1, RPS24, BDNF-AS, RPS3A, PCDH11X, ENSG00000271860, MT-RNR2, PLAAT3, PRKG1 
##     TPM1, MT-CO3, DANT1, S100A11, ADAMTS6, ENSG00000272449, BST2, MT1X, LINC01414, DIAPH2 
##     MT-RNR1, DGKB, RPL34, ENSG00000289195, MT-CO1, ENSG00000239920, ATP2B4, USP38-DT, ID3, ENSG00000297419 
## Negative:  PBK, NUSAP1, PRC1, TOP2A, NUF2, ENSG00000285920, MXD3, TPX2, GAS2L3, NEK2 
##     CENPA, HMGB2, MKI67, KIF18A, CKAP2L, CDCA3, TUBB4B, KIF2C, FAM72C, GTSE1 
##     SGO2, KIFC1, CENPE, FAM72A, H2AX, FAM72D, ASPM, CDCA8, NDC80, RACGAP1 
## PC_ 5 
## Positive:  CDH18, LINC02609, LHX5-AS1, TBR1, EBF1, RSPO3, GPR149, SLC4A10, ENSG00000286446, SLIT1 
##     ENSG00000296399, SLC17A6, FSTL5, EPB41L3, ANKFN1, ROBO1, PCSK2, LHX1-DT, ENSG00000293110, LHX5 
##     PCDH9, TRH, EPHA3, ENSG00000227681, SAMD5, PCSK1N, GABBR2, RORB, ENSG00000259316, ENSG00000224658 
## Negative:  ASCL1, RASD1, DLX6-AS1, GADD45G, RGS16, NRXN3, MEST, NXPH1, GAD2, SMOC1 
##     COPG2IT1, ENSG00000258416, SOX4, COPG2, DLL1, SLCO5A1, GNG8, LINC02106, ENSG00000258637, MYT1 
##     ATP2B4, ENSG00000234710, PXDN, RND3, TH, ENSG00000295572, NOL4, ENSG00000270953, ISL1, PCP4</code></pre>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb174"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb174-1"><a href="multisample-analysis.html#cb174-1" aria-hidden="true" tabindex="-1"></a>merged_seurat <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(<span class="at">object =</span> merged_seurat, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">16</span>)</span></code></pre></div>
</details>
<pre><code>## Computing nearest neighbor graph</code></pre>
<pre><code>## Computing SNN</code></pre>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb177"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb177-1"><a href="multisample-analysis.html#cb177-1" aria-hidden="true" tabindex="-1"></a>merged_seurat <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(<span class="at">object =</span> merged_seurat, <span class="at">resolution =</span> <span class="fl">0.6</span>)</span></code></pre></div>
</details>
<pre><code>## Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck
## 
## Number of nodes: 1021
## Number of edges: 29966
## 
## Running Louvain algorithm...
## Maximum modularity in 10 random starts: 0.8700
## Number of communities: 8
## Elapsed time: 0 seconds</code></pre>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb179"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb179-1"><a href="multisample-analysis.html#cb179-1" aria-hidden="true" tabindex="-1"></a>merged_seurat <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(<span class="at">object =</span> merged_seurat, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">30</span>)</span></code></pre></div>
</details>
<pre><code>## 12:41:32 UMAP embedding parameters a = 0.9922 b = 1.112</code></pre>
<pre><code>## 12:41:32 Read 1021 rows and found 30 numeric columns</code></pre>
<pre><code>## 12:41:32 Using Annoy for neighbor search, n_neighbors = 30</code></pre>
<pre><code>## 12:41:32 Building Annoy index with metric = cosine, n_trees = 50</code></pre>
<pre><code>## 0%   10   20   30   40   50   60   70   80   90   100%</code></pre>
<pre><code>## [----|----|----|----|----|----|----|----|----|----|</code></pre>
<pre><code>## **************************************************|
## 12:41:32 Writing NN index file to temp file /tmp/RtmpSqzgLk/file35f6113b834dc
## 12:41:32 Searching Annoy index using 1 thread, search_k = 3000
## 12:41:32 Annoy recall = 100%
## 12:41:34 Commencing smooth kNN distance calibration using 1 thread with target n_neighbors = 30
## 12:41:36 Found 2 connected components, falling back to &#39;spca&#39; initialization with init_sdev = 1
## 12:41:36 Using &#39;irlba&#39; for PCA
## 12:41:36 PCA: 2 components explained 51.16% variance
## 12:41:36 Scaling init to sdev = 1
## 12:41:36 Commencing optimization for 500 epochs, with 39318 positive edges
## 12:41:38 Optimization finished</code></pre>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb187"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb187-1"><a href="multisample-analysis.html#cb187-1" aria-hidden="true" tabindex="-1"></a><span class="do">##save merged object</span></span>
<span id="cb187-2"><a href="multisample-analysis.html#cb187-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(merged_seurat, <span class="at">file =</span> <span class="st">&quot;./output_files/multi_sample_subset//merged_seurat.rds&quot;</span>)</span></code></pre></div>
</details>
<p>We then integrate the samples using <strong>Harmony</strong> and generate UMAPs from both the merged (non-integrated) and integrated data. This allows us to visually compare how well integration has reduced sample-specific batch effects. In this dataset, the integrated UMAP shows that cells from different samples cluster together based on their biological state rather than their sample of origin, indicating that there is no obvious sample-driven bias in the clustering.</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb188"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb188-1"><a href="multisample-analysis.html#cb188-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">00003</span>)</span>
<span id="cb188-2"><a href="multisample-analysis.html#cb188-2" aria-hidden="true" tabindex="-1"></a>merged_seurat <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;./output_files/multi_sample_subset/merged_seurat.rds&quot;</span>)</span>
<span id="cb188-3"><a href="multisample-analysis.html#cb188-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-4"><a href="multisample-analysis.html#cb188-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-5"><a href="multisample-analysis.html#cb188-5" aria-hidden="true" tabindex="-1"></a><span class="co">#Let&#39;s plot the merged file. </span></span>
<span id="cb188-6"><a href="multisample-analysis.html#cb188-6" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(merged_seurat, <span class="at">reduction =</span> <span class="st">&#39;umap&#39;</span>, <span class="at">features =</span> <span class="st">&#39;nCount_RNA&#39;</span>)</span>
<span id="cb188-7"><a href="multisample-analysis.html#cb188-7" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(merged_seurat, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">features =</span> <span class="st">&#39;nFeature_RNA&#39;</span>)</span>
<span id="cb188-8"><a href="multisample-analysis.html#cb188-8" aria-hidden="true" tabindex="-1"></a>p3 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(merged_seurat, <span class="at">reduction =</span> <span class="st">&#39;umap&#39;</span>, <span class="at">group.by =</span> <span class="st">&#39;Day&#39;</span>)</span>
<span id="cb188-9"><a href="multisample-analysis.html#cb188-9" aria-hidden="true" tabindex="-1"></a>p4 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(merged_seurat, <span class="at">reduction =</span> <span class="st">&#39;umap&#39;</span>, <span class="at">group.by =</span> <span class="st">&#39;orig.ident&#39;</span>)</span>
<span id="cb188-10"><a href="multisample-analysis.html#cb188-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb188-11"><a href="multisample-analysis.html#cb188-11" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p1, p2, p3, p4, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div>
</details>
<p><img src="bookdownproj_files/figure-html/subset_multisample_integration_2-1.png" width="960" /></p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb189"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb189-1"><a href="multisample-analysis.html#cb189-1" aria-hidden="true" tabindex="-1"></a>merged_seurat <span class="ot">&lt;-</span> <span class="fu">JoinLayers</span>(<span class="at">object =</span> merged_seurat)</span>
<span id="cb189-2"><a href="multisample-analysis.html#cb189-2" aria-hidden="true" tabindex="-1"></a>merged_seurat[[<span class="st">&quot;RNA&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">split</span>(merged_seurat[[<span class="st">&quot;RNA&quot;</span>]], <span class="at">f =</span> merged_seurat<span class="sc">$</span>orig.ident)</span>
<span id="cb189-3"><a href="multisample-analysis.html#cb189-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb189-4"><a href="multisample-analysis.html#cb189-4" aria-hidden="true" tabindex="-1"></a><span class="co">#perform integration with Harmony</span></span>
<span id="cb189-5"><a href="multisample-analysis.html#cb189-5" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">IntegrateLayers</span>(<span class="at">object =</span> merged_seurat,</span>
<span id="cb189-6"><a href="multisample-analysis.html#cb189-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">method =</span> HarmonyIntegration,</span>
<span id="cb189-7"><a href="multisample-analysis.html#cb189-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">orig.reduction =</span> <span class="st">&quot;pca&quot;</span>,</span>
<span id="cb189-8"><a href="multisample-analysis.html#cb189-8" aria-hidden="true" tabindex="-1"></a>                       <span class="at">new.reduction =</span> <span class="st">&#39;integrated.harm&#39;</span>,</span>
<span id="cb189-9"><a href="multisample-analysis.html#cb189-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">verbose =</span> <span class="cn">FALSE</span>,</span>
<span id="cb189-10"><a href="multisample-analysis.html#cb189-10" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</details>
<pre><code>## Warning in harmony::HarmonyMatrix(data_mat = Embeddings(object = orig), : HarmonyMatrix is deprecated and will be removed in the
## future from the API in the future</code></pre>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb191"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb191-1"><a href="multisample-analysis.html#cb191-1" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(obj, <span class="at">reduction=</span><span class="st">&quot;integrated.harm&quot;</span>)</span>
<span id="cb191-2"><a href="multisample-analysis.html#cb191-2" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(obj, <span class="at">resolution=</span><span class="fl">0.4</span>, <span class="at">cluster.name=</span><span class="st">&quot;harm_cluster&quot;</span>)</span></code></pre></div>
</details>
<pre><code>## Modularity Optimizer version 1.3.0 by Ludo Waltman and Nees Jan van Eck
## 
## Number of nodes: 1021
## Number of edges: 29472
## 
## Running Louvain algorithm...
## Maximum modularity in 10 random starts: 0.8720
## Number of communities: 7
## Elapsed time: 0 seconds</code></pre>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb193"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb193-1"><a href="multisample-analysis.html#cb193-1" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(obj, <span class="at">reduction=</span><span class="st">&quot;integrated.harm&quot;</span>, <span class="at">dims=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, <span class="at">reduction.name =</span> <span class="st">&quot;umap.harm&quot;</span>)</span>
<span id="cb193-2"><a href="multisample-analysis.html#cb193-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-3"><a href="multisample-analysis.html#cb193-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb193-4"><a href="multisample-analysis.html#cb193-4" aria-hidden="true" tabindex="-1"></a><span class="fu">DimPlot</span>(obj, <span class="at">reduction =</span> <span class="st">&quot;umap.harm&quot;</span>, <span class="at">group.by =</span> <span class="fu">c</span>(<span class="st">&quot;Day&quot;</span>, <span class="st">&quot;orig.ident&quot;</span>, <span class="st">&quot;harm_cluster&quot;</span>), <span class="at">label =</span> T)  </span></code></pre></div>
</details>
<p><img src="bookdownproj_files/figure-html/subset_multisample_integration_2-2.png" width="960" /></p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb194"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb194-1"><a href="multisample-analysis.html#cb194-1" aria-hidden="true" tabindex="-1"></a><span class="do">### save object </span></span>
<span id="cb194-2"><a href="multisample-analysis.html#cb194-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(obj, <span class="at">file =</span> <span class="st">&quot;./output_files/multi_sample_subset//integrated_harm_seurat.rds&quot;</span>)</span></code></pre></div>
</details>
</div>
<div id="add-isoform-counts" class="section level2 hasAnchor" number="10.3">
<h2><span class="header-section-number">10.3</span> Add isoform counts<a href="multisample-analysis.html#add-isoform-counts" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Now we can add isoform level information to the integrated Seurat object. When doing this you may need to convert the Oarfish files into a count.csv file with the row names in the <code>ENSTID_genesymbol</code> form. The function to do so can be found here @ref(Convert Oarfish files to count matrix). The function also allows you to include or exclude novel bambu genes quantified by Oarfish; for the sake of simplicity in this tutorial, we will exclude these novel bambu genes.</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb195"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb195-1"><a href="multisample-analysis.html#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define sample names</span></span>
<span id="cb195-2"><a href="multisample-analysis.html#cb195-2" aria-hidden="true" tabindex="-1"></a>sample_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;C1_STC&quot;</span>,</span>
<span id="cb195-3"><a href="multisample-analysis.html#cb195-3" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;C4_STC&quot;</span>,</span>
<span id="cb195-4"><a href="multisample-analysis.html#cb195-4" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;C2_Day25&quot;</span>,</span>
<span id="cb195-5"><a href="multisample-analysis.html#cb195-5" aria-hidden="true" tabindex="-1"></a>                  <span class="st">&quot;C5_Day25&quot;</span>)</span>
<span id="cb195-6"><a href="multisample-analysis.html#cb195-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb195-7"><a href="multisample-analysis.html#cb195-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Loop through each sample and process the count files</span></span>
<span id="cb195-8"><a href="multisample-analysis.html#cb195-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (sample <span class="cf">in</span> sample_names) {</span>
<span id="cb195-9"><a href="multisample-analysis.html#cb195-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use tryCatch to handle errors</span></span>
<span id="cb195-10"><a href="multisample-analysis.html#cb195-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tryCatch</span>({</span>
<span id="cb195-11"><a href="multisample-analysis.html#cb195-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Call the function to process the sample</span></span>
<span id="cb195-12"><a href="multisample-analysis.html#cb195-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">process_oarfish_files_to_counts_matrix</span>(</span>
<span id="cb195-13"><a href="multisample-analysis.html#cb195-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">sample_name =</span> sample,</span>
<span id="cb195-14"><a href="multisample-analysis.html#cb195-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">resource_table_path =</span> <span class="st">&quot;./output_files/ref_files/isoform_gene_dict_mutlisample_subset.csv&quot;</span>,</span>
<span id="cb195-15"><a href="multisample-analysis.html#cb195-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">output_dir =</span> <span class="st">&quot;./output_files/multi_sample_subset/oarfish_counts/&quot;</span>,</span>
<span id="cb195-16"><a href="multisample-analysis.html#cb195-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">input_dir =</span> <span class="st">&quot;./data/multi_sample_subset/oarfsih/&quot;</span>,</span>
<span id="cb195-17"><a href="multisample-analysis.html#cb195-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">filter_bambu_Genes =</span> <span class="cn">TRUE</span></span>
<span id="cb195-18"><a href="multisample-analysis.html#cb195-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb195-19"><a href="multisample-analysis.html#cb195-19" aria-hidden="true" tabindex="-1"></a>  }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb195-20"><a href="multisample-analysis.html#cb195-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Print the error message and exit the loop</span></span>
<span id="cb195-21"><a href="multisample-analysis.html#cb195-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">cat</span>(<span class="st">&quot;Error processing sample:&quot;</span>, sample, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Error message:&quot;</span>, e<span class="sc">$</span>message, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Exiting loop.</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb195-22"><a href="multisample-analysis.html#cb195-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(e)</span>
<span id="cb195-23"><a href="multisample-analysis.html#cb195-23" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb195-24"><a href="multisample-analysis.html#cb195-24" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</details>
<p>Once we have created the CSV files with the correct structure (<code>ENSTID_genesymbol</code>), we can add the isoform information back into our gene-level object. First, we create an isoform-level Seurat object <strong>for each sample</strong> and merge these into a single isoform Seurat object. Next, we <strong>filter the merged isoform object</strong> to retain only high-quality cells, using the cell types and QC filters defined in the gene-level analysis above.</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb196"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb196-1"><a href="multisample-analysis.html#cb196-1" aria-hidden="true" tabindex="-1"></a><span class="do">############ read in count matrix and add isoform assay to Seurat object  #########</span></span>
<span id="cb196-2"><a href="multisample-analysis.html#cb196-2" aria-hidden="true" tabindex="-1"></a><span class="co">#Make Seurat objects not filtered</span></span>
<span id="cb196-3"><a href="multisample-analysis.html#cb196-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to read a CSV file and create a Seurat object</span></span>
<span id="cb196-4"><a href="multisample-analysis.html#cb196-4" aria-hidden="true" tabindex="-1"></a>create_seurat_object <span class="ot">&lt;-</span> <span class="cf">function</span>(sample_name, input_dir, project_name) {</span>
<span id="cb196-5"><a href="multisample-analysis.html#cb196-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Construct file path</span></span>
<span id="cb196-6"><a href="multisample-analysis.html#cb196-6" aria-hidden="true" tabindex="-1"></a>  file_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(input_dir, <span class="fu">paste0</span>(<span class="st">&quot;gene_symbol_oarfish_&quot;</span>, sample_name, <span class="st">&quot;_counts.csv&quot;</span>))</span>
<span id="cb196-7"><a href="multisample-analysis.html#cb196-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb196-8"><a href="multisample-analysis.html#cb196-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Read the CSV file</span></span>
<span id="cb196-9"><a href="multisample-analysis.html#cb196-9" aria-hidden="true" tabindex="-1"></a>  counts <span class="ot">&lt;-</span> <span class="fu">fread</span>(file_path)</span>
<span id="cb196-10"><a href="multisample-analysis.html#cb196-10" aria-hidden="true" tabindex="-1"></a>  counts <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(counts) </span>
<span id="cb196-11"><a href="multisample-analysis.html#cb196-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames</span>(counts) <span class="ot">&lt;-</span> counts[[<span class="dv">1</span>]]            <span class="co"># Set row names from the first column</span></span>
<span id="cb196-12"><a href="multisample-analysis.html#cb196-12" aria-hidden="true" tabindex="-1"></a>  counts[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="cn">NULL</span>     </span>
<span id="cb196-13"><a href="multisample-analysis.html#cb196-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb196-14"><a href="multisample-analysis.html#cb196-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create the Seurat object</span></span>
<span id="cb196-15"><a href="multisample-analysis.html#cb196-15" aria-hidden="true" tabindex="-1"></a>  seurat_obj <span class="ot">&lt;-</span> <span class="fu">CreateSeuratObject</span>(<span class="at">counts =</span> counts, <span class="at">project =</span> project_name, <span class="at">min.cells =</span> <span class="dv">5</span>, <span class="at">min.features =</span> <span class="dv">500</span>)</span>
<span id="cb196-16"><a href="multisample-analysis.html#cb196-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb196-17"><a href="multisample-analysis.html#cb196-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(seurat_obj)</span>
<span id="cb196-18"><a href="multisample-analysis.html#cb196-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb196-19"><a href="multisample-analysis.html#cb196-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-20"><a href="multisample-analysis.html#cb196-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Directory where the CSV files are stored</span></span>
<span id="cb196-21"><a href="multisample-analysis.html#cb196-21" aria-hidden="true" tabindex="-1"></a>input_directory <span class="ot">&lt;-</span> <span class="st">&quot;./output_files/multi_sample_subset/oarfish_counts/&quot;</span></span>
<span id="cb196-22"><a href="multisample-analysis.html#cb196-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-23"><a href="multisample-analysis.html#cb196-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an empty list to store Seurat objects</span></span>
<span id="cb196-24"><a href="multisample-analysis.html#cb196-24" aria-hidden="true" tabindex="-1"></a>iso_seurat_objects <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb196-25"><a href="multisample-analysis.html#cb196-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-26"><a href="multisample-analysis.html#cb196-26" aria-hidden="true" tabindex="-1"></a>total_samples <span class="ot">&lt;-</span> <span class="fu">length</span>(sample_names)</span>
<span id="cb196-27"><a href="multisample-analysis.html#cb196-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(sample_names)) {</span>
<span id="cb196-28"><a href="multisample-analysis.html#cb196-28" aria-hidden="true" tabindex="-1"></a>  sample <span class="ot">&lt;-</span> sample_names[i]</span>
<span id="cb196-29"><a href="multisample-analysis.html#cb196-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb196-30"><a href="multisample-analysis.html#cb196-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="fu">sprintf</span>(<span class="st">&quot;Processing sample %d of %d: %s&quot;</span>, i, total_samples, sample))</span>
<span id="cb196-31"><a href="multisample-analysis.html#cb196-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb196-32"><a href="multisample-analysis.html#cb196-32" aria-hidden="true" tabindex="-1"></a>  iso_seurat_objects[[sample]] <span class="ot">&lt;-</span> <span class="fu">create_seurat_object</span>(</span>
<span id="cb196-33"><a href="multisample-analysis.html#cb196-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">sample_name =</span> sample,</span>
<span id="cb196-34"><a href="multisample-analysis.html#cb196-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">input_dir =</span> input_directory,</span>
<span id="cb196-35"><a href="multisample-analysis.html#cb196-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">project_name =</span> sample</span>
<span id="cb196-36"><a href="multisample-analysis.html#cb196-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb196-37"><a href="multisample-analysis.html#cb196-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb196-38"><a href="multisample-analysis.html#cb196-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-39"><a href="multisample-analysis.html#cb196-39" aria-hidden="true" tabindex="-1"></a><span class="do">####### Merge the samples into one object ######</span></span>
<span id="cb196-40"><a href="multisample-analysis.html#cb196-40" aria-hidden="true" tabindex="-1"></a>iso.merged_seurat <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb196-41"><a href="multisample-analysis.html#cb196-41" aria-hidden="true" tabindex="-1"></a>  iso_seurat_objects[[<span class="st">&quot;C1_STC&quot;</span>]],</span>
<span id="cb196-42"><a href="multisample-analysis.html#cb196-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> <span class="fu">list</span>(</span>
<span id="cb196-43"><a href="multisample-analysis.html#cb196-43" aria-hidden="true" tabindex="-1"></a>    iso_seurat_objects[[<span class="st">&quot;C4_STC&quot;</span>]],</span>
<span id="cb196-44"><a href="multisample-analysis.html#cb196-44" aria-hidden="true" tabindex="-1"></a>    iso_seurat_objects[[<span class="st">&quot;C2_Day25&quot;</span>]],</span>
<span id="cb196-45"><a href="multisample-analysis.html#cb196-45" aria-hidden="true" tabindex="-1"></a>    iso_seurat_objects[[<span class="st">&quot;C5_Day25&quot;</span>]]</span>
<span id="cb196-46"><a href="multisample-analysis.html#cb196-46" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb196-47"><a href="multisample-analysis.html#cb196-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">add.cell.ids =</span> <span class="fu">c</span>(</span>
<span id="cb196-48"><a href="multisample-analysis.html#cb196-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;C1_STC&quot;</span>, <span class="st">&quot;C4_STC&quot;</span>, <span class="st">&quot;C2_Day25&quot;</span>, <span class="st">&quot;C5_Day25&quot;</span></span>
<span id="cb196-49"><a href="multisample-analysis.html#cb196-49" aria-hidden="true" tabindex="-1"></a>  ), </span>
<span id="cb196-50"><a href="multisample-analysis.html#cb196-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">project =</span> <span class="st">&quot;iso-Multi-sample_tutorial&quot;</span></span>
<span id="cb196-51"><a href="multisample-analysis.html#cb196-51" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb196-52"><a href="multisample-analysis.html#cb196-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-53"><a href="multisample-analysis.html#cb196-53" aria-hidden="true" tabindex="-1"></a><span class="co"># create a sample column</span></span>
<span id="cb196-54"><a href="multisample-analysis.html#cb196-54" aria-hidden="true" tabindex="-1"></a>iso.merged_seurat<span class="sc">$</span>sample <span class="ot">&lt;-</span> <span class="fu">rownames</span>(iso.merged_seurat<span class="sc">@</span>meta.data)</span>
<span id="cb196-55"><a href="multisample-analysis.html#cb196-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-56"><a href="multisample-analysis.html#cb196-56" aria-hidden="true" tabindex="-1"></a><span class="co"># split sample column to makw a batch col</span></span>
<span id="cb196-57"><a href="multisample-analysis.html#cb196-57" aria-hidden="true" tabindex="-1"></a>iso.merged_seurat<span class="sc">@</span>meta.data <span class="ot">&lt;-</span> <span class="fu">separate</span>(iso.merged_seurat<span class="sc">@</span>meta.data, <span class="at">col =</span> <span class="st">&#39;sample&#39;</span>, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&#39;batch&#39;</span>, <span class="st">&#39;Day&#39;</span>, <span class="st">&#39;Barcode&#39;</span>), </span>
<span id="cb196-58"><a href="multisample-analysis.html#cb196-58" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">sep =</span> <span class="st">&#39;_&#39;</span>)</span>
<span id="cb196-59"><a href="multisample-analysis.html#cb196-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-60"><a href="multisample-analysis.html#cb196-60" aria-hidden="true" tabindex="-1"></a><span class="do">## filter the data to iso and gene cells match</span></span>
<span id="cb196-61"><a href="multisample-analysis.html#cb196-61" aria-hidden="true" tabindex="-1"></a>merged_seurat_isoform_filtered <span class="ot">&lt;-</span> <span class="fu">subset</span>(iso.merged_seurat, <span class="at">cells =</span>obj<span class="sc">@</span>graphs[[<span class="st">&quot;RNA_nn&quot;</span>]]<span class="sc">@</span>Dimnames[[<span class="dv">1</span>]])</span>
<span id="cb196-62"><a href="multisample-analysis.html#cb196-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-63"><a href="multisample-analysis.html#cb196-63" aria-hidden="true" tabindex="-1"></a><span class="fu">VlnPlot</span>(merged_seurat_isoform_filtered, <span class="at">features =</span> <span class="fu">c</span>(<span class="st">&quot;nFeature_RNA&quot;</span>, <span class="st">&quot;nCount_RNA&quot;</span>, <span class="st">&quot;percent.mt&quot;</span>), <span class="at">ncol =</span> <span class="dv">3</span>)</span>
<span id="cb196-64"><a href="multisample-analysis.html#cb196-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-65"><a href="multisample-analysis.html#cb196-65" aria-hidden="true" tabindex="-1"></a><span class="co"># perform standard workflow steps</span></span>
<span id="cb196-66"><a href="multisample-analysis.html#cb196-66" aria-hidden="true" tabindex="-1"></a>merged_seurat_isoform_filtered <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(<span class="at">object =</span> merged_seurat_isoform_filtered) <span class="co"># if using SCT dont run this</span></span>
<span id="cb196-67"><a href="multisample-analysis.html#cb196-67" aria-hidden="true" tabindex="-1"></a>merged_seurat_isoform_filtered <span class="ot">&lt;-</span> <span class="fu">FindVariableFeatures</span>(<span class="at">object =</span> merged_seurat_isoform_filtered) <span class="co"># if using SCT dont run this</span></span>
<span id="cb196-68"><a href="multisample-analysis.html#cb196-68" aria-hidden="true" tabindex="-1"></a>merged_seurat_isoform_filtered <span class="ot">&lt;-</span> <span class="fu">ScaleData</span>(<span class="at">object =</span> merged_seurat_isoform_filtered) <span class="co"># if using SCT dont run this</span></span>
<span id="cb196-69"><a href="multisample-analysis.html#cb196-69" aria-hidden="true" tabindex="-1"></a>merged_seurat_isoform_filtered <span class="ot">&lt;-</span> <span class="fu">RunPCA</span>(<span class="at">object =</span> merged_seurat_isoform_filtered)</span>
<span id="cb196-70"><a href="multisample-analysis.html#cb196-70" aria-hidden="true" tabindex="-1"></a><span class="co">#ElbowPlot(merged_seurat_isoform_filtered)</span></span>
<span id="cb196-71"><a href="multisample-analysis.html#cb196-71" aria-hidden="true" tabindex="-1"></a>merged_seurat_isoform_filtered <span class="ot">&lt;-</span> <span class="fu">FindNeighbors</span>(<span class="at">object =</span> merged_seurat_isoform_filtered, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb196-72"><a href="multisample-analysis.html#cb196-72" aria-hidden="true" tabindex="-1"></a>merged_seurat_isoform_filtered <span class="ot">&lt;-</span> <span class="fu">FindClusters</span>(<span class="at">object =</span> merged_seurat_isoform_filtered, <span class="at">resolution =</span> <span class="fl">0.6</span>)</span>
<span id="cb196-73"><a href="multisample-analysis.html#cb196-73" aria-hidden="true" tabindex="-1"></a>merged_seurat_isoform_filtered <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(<span class="at">object =</span> merged_seurat_isoform_filtered, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span>
<span id="cb196-74"><a href="multisample-analysis.html#cb196-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb196-75"><a href="multisample-analysis.html#cb196-75" aria-hidden="true" tabindex="-1"></a><span class="co">#Save file</span></span>
<span id="cb196-76"><a href="multisample-analysis.html#cb196-76" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(merged_seurat_isoform_filtered, <span class="at">file =</span> <span class="st">&quot;./output_files/multi_sample_subset//merged_seurat_isoform_filtered.rds&quot;</span>)</span></code></pre></div>
</details>
<p>We can then add this merged isoform object as a <strong>new assay</strong> in the gene-level Seurat object, allowing gene- and isoform-level analyses to be performed side by side. In principle, the isoform assay could also be integrated across samples (e.g. using Harmony) to further remove sample-specific batch effects, but for simplicity we do not perform isoform-level integration in this tutorial and rely on gene level integration.</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb197"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb197-1"><a href="multisample-analysis.html#cb197-1" aria-hidden="true" tabindex="-1"></a>merged_seurat_isoform_filtered <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="st">&quot;./output_files/multi_sample_subset//merged_seurat_isoform_filtered.rds&quot;</span>)</span>
<span id="cb197-2"><a href="multisample-analysis.html#cb197-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-3"><a href="multisample-analysis.html#cb197-3" aria-hidden="true" tabindex="-1"></a><span class="co">#plots</span></span>
<span id="cb197-4"><a href="multisample-analysis.html#cb197-4" aria-hidden="true" tabindex="-1"></a>p5 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(merged_seurat_isoform_filtered, <span class="at">reduction =</span> <span class="st">&#39;umap&#39;</span>, <span class="at">group.by =</span> <span class="st">&#39;orig.ident&#39;</span>)</span>
<span id="cb197-5"><a href="multisample-analysis.html#cb197-5" aria-hidden="true" tabindex="-1"></a>p6 <span class="ot">&lt;-</span> <span class="fu">DimPlot</span>(merged_seurat_isoform_filtered, <span class="at">reduction =</span> <span class="st">&#39;umap&#39;</span>, <span class="at">group.by =</span> <span class="st">&#39;Day&#39;</span>)</span>
<span id="cb197-6"><a href="multisample-analysis.html#cb197-6" aria-hidden="true" tabindex="-1"></a>p7 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(merged_seurat_isoform_filtered, <span class="at">reduction =</span> <span class="st">&#39;umap&#39;</span>, <span class="at">features =</span> <span class="st">&#39;nCount_RNA&#39;</span>)</span>
<span id="cb197-7"><a href="multisample-analysis.html#cb197-7" aria-hidden="true" tabindex="-1"></a>p8 <span class="ot">&lt;-</span> <span class="fu">FeaturePlot</span>(merged_seurat_isoform_filtered, <span class="at">reduction =</span> <span class="st">&quot;umap&quot;</span>, <span class="at">features =</span> <span class="st">&#39;nFeature_RNA&#39;</span>)</span>
<span id="cb197-8"><a href="multisample-analysis.html#cb197-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb197-9"><a href="multisample-analysis.html#cb197-9" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(p5, p6, p7, p8, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div>
</details>
<p><img src="bookdownproj_files/figure-html/subset_multisample_add_iso_counts_2-1.png" width="672" /></p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="multisample-analysis.html#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="do">#####</span></span>
<span id="cb198-2"><a href="multisample-analysis.html#cb198-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-3"><a href="multisample-analysis.html#cb198-3" aria-hidden="true" tabindex="-1"></a>merged_seurat_isoform_filtered <span class="ot">&lt;-</span> <span class="fu">JoinLayers</span>(merged_seurat_isoform_filtered)</span>
<span id="cb198-4"><a href="multisample-analysis.html#cb198-4" aria-hidden="true" tabindex="-1"></a>counts_table <span class="ot">&lt;-</span> merged_seurat_isoform_filtered[[<span class="st">&quot;RNA&quot;</span>]]<span class="sc">$</span>counts</span>
<span id="cb198-5"><a href="multisample-analysis.html#cb198-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-6"><a href="multisample-analysis.html#cb198-6" aria-hidden="true" tabindex="-1"></a>obj[[<span class="st">&quot;iso&quot;</span>]] <span class="ot">&lt;-</span> <span class="fu">CreateAssay5Object</span>(<span class="at">counts =</span> counts_table)</span>
<span id="cb198-7"><a href="multisample-analysis.html#cb198-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-8"><a href="multisample-analysis.html#cb198-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Normalize the new assay data</span></span>
<span id="cb198-9"><a href="multisample-analysis.html#cb198-9" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">NormalizeData</span>(obj, <span class="at">assay =</span> <span class="st">&quot;iso&quot;</span>)</span>
<span id="cb198-10"><a href="multisample-analysis.html#cb198-10" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">FindVariableFeatures</span>(obj, <span class="at">assay =</span> <span class="st">&quot;iso&quot;</span>)</span>
<span id="cb198-11"><a href="multisample-analysis.html#cb198-11" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">ScaleData</span>(obj, <span class="at">assay =</span> <span class="st">&quot;iso&quot;</span>)</span>
<span id="cb198-12"><a href="multisample-analysis.html#cb198-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-13"><a href="multisample-analysis.html#cb198-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: Perform PCA</span></span>
<span id="cb198-14"><a href="multisample-analysis.html#cb198-14" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">RunPCA</span>(obj, <span class="at">assay =</span> <span class="st">&quot;iso&quot;</span>, <span class="at">reduction.name =</span> <span class="st">&quot;pca_iso&quot;</span>)</span></code></pre></div>
</details>
<pre><code>## Warning: Key &#39;PC_&#39; taken, using &#39;pcaiso_&#39; instead</code></pre>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="multisample-analysis.html#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Run UMAP</span></span>
<span id="cb200-2"><a href="multisample-analysis.html#cb200-2" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">RunUMAP</span>(obj, <span class="at">reduction =</span> <span class="st">&quot;pca_iso&quot;</span>, <span class="at">dims =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>, <span class="at">assay =</span> <span class="st">&quot;iso&quot;</span>, <span class="at">reduction.name =</span> <span class="st">&quot;umap_iso&quot;</span>)</span>
<span id="cb200-3"><a href="multisample-analysis.html#cb200-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb200-4"><a href="multisample-analysis.html#cb200-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize the UMAP</span></span>
<span id="cb200-5"><a href="multisample-analysis.html#cb200-5" aria-hidden="true" tabindex="-1"></a><span class="fu">DimPlot</span>(obj, <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">reduction =</span> <span class="st">&quot;umap.harm&quot;</span>) <span class="sc">|</span> <span class="fu">DimPlot</span>(obj, <span class="at">label =</span> <span class="cn">TRUE</span>, <span class="at">reduction =</span> <span class="st">&quot;umap_iso&quot;</span>)</span></code></pre></div>
</details>
<p><img src="bookdownproj_files/figure-html/subset_multisample_add_iso_counts_2-2.png" width="672" /></p>
<p>Now we have a complete object to work with that contains an integrated gene-level assay and isoform counts for the same set of cells. As with any single-cell analysis, the next step is to <strong>annotate cell types</strong>, so that downstream analyses can be interpreted in a biologically meaningful way.</p>
</div>
<div id="identify-cell-types" class="section level2 hasAnchor" number="10.4">
<h2><span class="header-section-number">10.4</span> Identify cell types<a href="multisample-analysis.html#identify-cell-types" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Here, we annotate cell types using a small set of key marker genes. We keep this step deliberately simple, as automated annotation methods and GO-enrichment-based strategies have already been described in earlier chapters.</p>
<p>Cluster 1 2 and 3 are stem ells</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="multisample-analysis.html#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We can annoate Day 0 </span></span>
<span id="cb201-2"><a href="multisample-analysis.html#cb201-2" aria-hidden="true" tabindex="-1"></a><span class="fu">FeaturePlot</span>(obj, <span class="at">reduction =</span> <span class="st">&quot;umap.harm&quot;</span>, <span class="at">features =</span> <span class="fu">c</span>(<span class="st">&quot;MKI67&quot;</span>, <span class="st">&quot;NANOG&quot;</span>, <span class="st">&quot;POU5F1&quot;</span>), <span class="at">ncol =</span> <span class="dv">3</span>)</span></code></pre></div>
</details>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-25-1.png" width="1152" /></p>
<p>Cluster 0 and 4 - Radial Glia</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb202"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb202-1"><a href="multisample-analysis.html#cb202-1" aria-hidden="true" tabindex="-1"></a><span class="fu">FeaturePlot</span>(obj, <span class="at">reduction =</span> <span class="st">&quot;umap.harm&quot;</span>, <span class="at">features =</span> <span class="fu">c</span>(<span class="st">&quot;VIM&quot;</span>, <span class="st">&quot;SOX2&quot;</span>, <span class="st">&quot;PAX6&quot;</span>), <span class="at">ncol =</span> <span class="dv">3</span>)</span></code></pre></div>
</details>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-26-1.png" width="1152" /></p>
<p>Cluster 5 - Inhibitory neurons</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="multisample-analysis.html#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="fu">FeaturePlot</span>(obj, <span class="at">reduction =</span> <span class="st">&quot;umap.harm&quot;</span>, <span class="at">features =</span> <span class="fu">c</span>(<span class="st">&quot;GAD1&quot;</span>, <span class="st">&quot;GAD2&quot;</span>, <span class="st">&quot;DLX5&quot;</span>, <span class="st">&quot;DLX6&quot;</span>),<span class="at">ncol =</span> <span class="dv">4</span>)</span></code></pre></div>
</details>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-27-1.png" width="1152" /></p>
<p>Cluster 6 - Excitatory neurons (NPC)</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="multisample-analysis.html#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Clsuter 6 Excitorty neurons (NPC)</span></span>
<span id="cb204-2"><a href="multisample-analysis.html#cb204-2" aria-hidden="true" tabindex="-1"></a><span class="fu">FeaturePlot</span>(obj, <span class="at">reduction =</span> <span class="st">&quot;umap.harm&quot;</span>, <span class="at">features =</span> <span class="fu">c</span>(<span class="st">&quot;EOMES&quot;</span>, <span class="st">&quot;TBR1&quot;</span>))</span></code></pre></div>
</details>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-28-1.png" width="768" /></p>
<p>Now we will assign these labels to each cluster.</p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="multisample-analysis.html#cb205-1" aria-hidden="true" tabindex="-1"></a>new_ids <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb205-2"><a href="multisample-analysis.html#cb205-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;0&quot;</span> <span class="ot">=</span> <span class="st">&quot;Radial glia&quot;</span>,</span>
<span id="cb205-3"><a href="multisample-analysis.html#cb205-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;1&quot;</span> <span class="ot">=</span> <span class="st">&quot;Stem cells&quot;</span>,</span>
<span id="cb205-4"><a href="multisample-analysis.html#cb205-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;2&quot;</span> <span class="ot">=</span> <span class="st">&quot;Stem cells&quot;</span>,</span>
<span id="cb205-5"><a href="multisample-analysis.html#cb205-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;3&quot;</span> <span class="ot">=</span> <span class="st">&quot;Stem cells&quot;</span>,</span>
<span id="cb205-6"><a href="multisample-analysis.html#cb205-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;4&quot;</span> <span class="ot">=</span> <span class="st">&quot;Radial glia&quot;</span>,</span>
<span id="cb205-7"><a href="multisample-analysis.html#cb205-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;5&quot;</span> <span class="ot">=</span> <span class="st">&quot;Inhibitory neurons&quot;</span>,</span>
<span id="cb205-8"><a href="multisample-analysis.html#cb205-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;6&quot;</span> <span class="ot">=</span> <span class="st">&quot;Excitatory neurons&quot;</span></span>
<span id="cb205-9"><a href="multisample-analysis.html#cb205-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb205-10"><a href="multisample-analysis.html#cb205-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-11"><a href="multisample-analysis.html#cb205-11" aria-hidden="true" tabindex="-1"></a>obj <span class="ot">&lt;-</span> <span class="fu">RenameIdents</span>(obj, new_ids)</span>
<span id="cb205-12"><a href="multisample-analysis.html#cb205-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-13"><a href="multisample-analysis.html#cb205-13" aria-hidden="true" tabindex="-1"></a><span class="co"># store as a metadata column for later</span></span>
<span id="cb205-14"><a href="multisample-analysis.html#cb205-14" aria-hidden="true" tabindex="-1"></a>obj<span class="sc">$</span>cell_type <span class="ot">&lt;-</span> <span class="fu">Idents</span>(obj)</span>
<span id="cb205-15"><a href="multisample-analysis.html#cb205-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-16"><a href="multisample-analysis.html#cb205-16" aria-hidden="true" tabindex="-1"></a><span class="co"># plot by cell type instead of numeric cluster</span></span>
<span id="cb205-17"><a href="multisample-analysis.html#cb205-17" aria-hidden="true" tabindex="-1"></a><span class="fu">DimPlot</span>(obj, <span class="at">group.by =</span> <span class="st">&quot;cell_type&quot;</span>, <span class="at">reduction =</span> <span class="st">&quot;umap.harm&quot;</span>)</span></code></pre></div>
</details>
<p><img src="bookdownproj_files/figure-html/unnamed-chunk-29-1.png" width="576" /></p>
<details class=chunk-details open><summary class=chunk-summary><span class=chunk-summary-text>Code</span></summary>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="multisample-analysis.html#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="co">#saveRDS(obj, file = &quot;./output_files/multi_sample/multisample_seurat.intergrated_harm.isoform.rds&quot;)</span></span></code></pre></div>
</details>
<p>Now that we have an integrated Seurat object containing both gene- and isoform-level counts, along with curated cell type annotations, we can move beyond static clustering to explore how these transcriptional programs change over time and across lineages. In the next sections, we will use this object as the foundation for <strong>trajectory analysis</strong>, to reconstruct developmental paths and cell state transitions, and for <strong>differential transcript usage (DTU)</strong> analysis, to identify genes whose <strong>isoform composition</strong> shifts between conditions, lineages, or cell types.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="profiling-isoform-diversity.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="trajectory-analysis.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "sans",
    "size": 2
  },
  "edit": {
    "link": "https://github.com/sefi196/FLAMESv2_LR_sc_tutorial/edit/main/09_multi_sample_subset.rmd",
    "text": "Edit"
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": "https://github.com/sefi196/FLAMESv2_LR_sc_tutorial/blob/main/09_multi_sample_subset.rmd",
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "subsection"
  }
});
});
</script>

</body>

</html>
