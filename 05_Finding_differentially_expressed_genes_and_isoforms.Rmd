---
title: "Finding differentially expressed genes and isoforms"
author: "Sefi Prawer"
date: "`r Sys.Date()`"
output: html_document
---

# Finding differentially expressed genes and isoforms {style="gray"}

------------------------------------------------------------------------

## Differentially expressed genes by cluster identity

first we will look at marker genes for each cluster. This will help us identify which genes are DE in each cluster and indicate which cell type each cluster belongs to. We will also look at DE isoforms using the same methodology

```{r perform_marker_gene_analysis, echo=TRUE, message=FALSE, warning=FALSE}
#Find markers for all clusters using the "RNA" and "iso" assay

all_markers_gene <- FindAllMarkers(seu_obj, assay = "RNA", do.print = TRUE,
                                       logfc.threshold = 0.5, min.pct = 0.20, only.pos = TRUE) %>% dplyr::filter(p_val_adj < 0.05)

all_markers_iso <- FindAllMarkers(seu_obj, assay = "iso", do.print = TRUE,
                                      logfc.threshold = 0.5, min.pct = 0.20, only.pos = TRUE) %>% dplyr::filter(p_val_adj < 0.05)

#save the list of DE genes 
write.csv(all_markers_gene, "./output_files/DE/all_markers_one_gene.csv")
write.csv(all_markers_iso, "./output_files/DE/all_markers_one_iso.csv")
```

#notes - could add other DE options maybe add this later

## Identifying cell types

Based on these differentially expressed (DE) genes, we can identify the cell types present in our sample. This process is often complex and requires prior knowledge of cell markers as well as an understanding of the cell types expected in the sample. An alternative approach is to use automated cell type identification tools. In this tutorial, we will use **scType** [ref]. However, it is important to note that the accuracy of automated tools varies and depends heavily on the reference database they utilize. Therefore, it is recommended to use a combination of methods to cross-validate cell type identification and ensure robust results.

```{r sctype, echo=TRUE, message=FALSE, warning=FALSE}
# load libraries from sctype
lapply(c("ggraph","igraph","tidyverse", "data.tree"), library, character.only = T)
lapply(c("dplyr","Seurat","HGNChelper"), library, character.only = T)

# load gene set preparation function
source("https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/R/gene_sets_prepare.R")
# load cell type annotation function
source("https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/R/sctype_score_.R")

####
# define functions
perform_sctype_analysis <- function(seurat_obj, db_, tissue, gs_removal_list = c(), 
                                    metadat_col_prefix = "db_prefix", figure_prefix ="fig_name" ,
                                    cluster_res = "RNA_snn_res.0.9", output_file = "") {
  # Prepare gene sets
  gs_list <- gene_sets_prepare(db_, tissue)
  
  # Remove specified gene sets
  for (gs in gs_removal_list) {
    gs_list[["gs_positive"]][[gs]] <- NULL
  }
  
  # Calculate sctype scores
  es.max <- sctype_score(scRNAseqData = seurat_obj@assays$RNA$scale.data, scaled = TRUE, 
                         gs = gs_list$gs_positive, gs2 = gs_list$gs_negative)
  
  # Set identities in Seurat object
  Idents(seurat_obj) <- cluster_res
  
  # Merge by cluster
  cL_results <- do.call("rbind", lapply(unique(seurat_obj@meta.data[[cluster_res]]), function(cl) {
    es.max.cl <- sort(rowSums(es.max[, rownames(seurat_obj@meta.data[seurat_obj@meta.data[[cluster_res]] == cl, ])]), decreasing = TRUE)
    head(data.frame(cluster = cl, type = names(es.max.cl), scores = es.max.cl, ncells = sum(seurat_obj@meta.data[[cluster_res]] == cl)), 10)
  }))
  
  sctype_scores <- cL_results %>% group_by(cluster) %>% top_n(n = 1, wt = scores)
  
  # Set low-confident clusters to "Unknown"
  sctype_scores$scores <- as.numeric(sctype_scores$scores)
  sctype_scores$type[sctype_scores$scores < sctype_scores$ncells / 4] <- "Unknown"
  print(sctype_scores[, 1:3])
  
  # Overlay the labels
  seurat_obj@meta.data[[metadat_col_prefix]] <- ""
  for (j in unique(sctype_scores$cluster)) {
    cl_type <- sctype_scores[sctype_scores$cluster == j,]
    seurat_obj@meta.data[[metadat_col_prefix]][seurat_obj@meta.data[[cluster_res]] == j] <- as.character(cl_type$type[1])
  }
  
  # Plotting
  pclass <- DimPlot(seurat_obj, reduction = "umap", label = TRUE, repel = TRUE, group.by = metadat_col_prefix)
  print(pclass)
  
  # Save the plot to a PDF
  pdf(file = paste0(figure_prefix, "_", metadat_col_prefix, "_sctype_genes.pdf"), width = 8, height = 8)
  print(pclass + ggtitle(figure_prefix))
  dev.off()
  
  # Save the updated Seurat object to an RDS file
  if (output_file != "") {
    saveRDS(seurat_obj, file = paste0(output_file, ".rds"))
  }
  
  # Return the updated Seurat object
  return(seurat_obj)
}


# Define variables
db_ = "https://raw.githubusercontent.com/IanevskiAleksandr/sc-type/master/ScTypeDB_full.xlsx"; # this is a defualt databse from sctype 
tissue <- "Brain"
gs_removal_list <- c("Tanycytes") # list of cell types from the db to remove

seu_obj <- perform_sctype_analysis(seu_obj, db_, tissue, gs_removal_list, 
                        metadat_col_prefix ="sctype_db", figure_prefix = "Day_55",
                        output_file = "Day_55", cluster_res = "RNA_snn_res.0.9")

```

Sctype gives us some indication of which cell types we have in our data. We can use the DE genes to get some more specific info. Glutatergic Neuronal Markers "SLC17A7","SLC17A6","GRIN1","GRIN2B" are all DE in cluster 0 - the mature neuron cluster. This suggests these cells are indeed glutamatergic neurons.

```{r plot marker genes, echo=TRUE, message=FALSE, warning=FALSE}
# markers for 
FeaturePlot(seu_obj, features = c("SLC17A7","SLC17A6","GRIN1","GRIN2B"))

## Change the names of ScType DF to Glutatertergic neurons in metadat
seu_obj@meta.data$sctype_db <- gsub("Mature neurons", "Glutamatergic neurons", seu_obj@meta.data$sctype_db)

```

We can now plot the UMAP to ensure we have update the metadata correctly

```{r plot marker genes iso,  fig.height=10, fig.width=10}

DimPlot(seu_obj, group.by = "sctype_db") | DimPlot(seu_obj, reduction ="umap_iso", group.by = "sctype_db")


```

It is possible to explore the radial glial cells in more detail as there are likely more subtypes of radial glial cells in this data set. For the purposes of the tutorial we will leave this annoation as is. Based on this we have 5 main cell types.

1.  Radial glial cells

2.  Immature neurons

3.  Glutamatergic neurons

4.  GABAergic neuorns

## DE genes and isofroms based on annotaed cell types.

Cell type identification is an iterative process and often one of the most challenging aspects of single-cell analysis. For this example, we will assume that our combined approach, using automated clustering and differential expression (DE) analysis based on clusters, provides a good indication of the cell types present in our data.

With this foundation, we can refine our DE analysis by focusing on cell types rather than clusters. This step is critical in nearly all transcriptomic analyses, offering a wide range of possibilities for downstream investigations.

A common downstream approach involves generating volcano plots to visualize DE genes and isoforms. performing gene set enrichment analysis, In the following sections, we will demonstrate how to perform these types of analyses and explore their potential applications.

The code chunk below provides an example of how to execute these analyses:

```{r setup traj, include=FALSE}
#Set identities based on cell type

Idents(seu_obj) <- "sctype_db"

all_markers_gene_celltype <- FindAllMarkers(
  object = seu_obj, 
  assay = "RNA", 
  group.by = "sctype_db",  # Replace with your metadata column name
  logfc.threshold = 0.5, 
  min.pct = 0.20, 
  only.pos = FALSE # changed this to false to get negatively DE genes to
)

all_markers_iso_celltype <- FindAllMarkers(
  object = seu_obj, 
  assay = "iso", 
  group.by = "sctype_db",  # Replace with your metadata column name
  logfc.threshold = 0.5, 
  min.pct = 0.20, 
  only.pos = FALSE # changed this to false to get negatively DE genes to
)

#save the list of DE genes 
write.csv(all_markers_gene_celltype, "./output_files/DE/all_markers_one_gene_celltype.csv")
write.csv(all_markers_iso_celltype, "./output_files/DE/all_markers_one_iso_celltype.csv")
```

### Volcano plots

Fist lets generate some volcano plots. This analysis can be useful to identify genes and isoforms that are DE and also have large fold changes. Often these types of features are the interesting for further analysis. This can be done for any of the cell types defined in our object. For the sake of brevity we will look a the Glutamatergic neurons.

When plotting the volcano plots, we observe that many genes exhibit both statistically significant p-values (p \< 0.05) and log2 fold changes -1\< or \>1. To highlight key findings, we have labeled some glutamatergic marker genes, demonstrating that the genes we expect to be upregulated in this cell type are indeed showing the expected pattern. Additionally, we have labeled VIM, a marker of radial glial and projenitor cells. As anticipated, VIM expression is downregulated in these neurons, which aligns with our expectations.

```{r valocano1, include=TRUE}
library(EnhancedVolcano)

#filter for the cell type of interest 
glut_DE_iso <- dplyr::filter(all_markers_iso_celltype, cluster == "Glutamatergic neurons")
glut_DE_gene <- dplyr::filter(all_markers_gene_celltype, cluster == "Glutamatergic neurons") 

#we can plot our colcano plot 
EnhancedVolcano(glut_DE_gene,
                lab=glut_DE_gene$gene,
                x='avg_log2FC', y='p_val_adj', pCutoff=0.05, FCcutoff=1,
                boxedLabels = TRUE,
                drawConnectors = TRUE,
                selectLab= c("SLC17A7","SLC17A6",'GRIN1',"GRIN2B",'VIM'))
```

Interestingly our long read data allows us to perform the same analysis but at the isoform level. This can be hard to interpret as there are many more features to plot on the volcano plot. for the sake a clarity we have just labelled TBR1 isoforms. This code bellow will allow suers to plot all the isofroms from agiven gene on the volacon plot making interpation of the data a bit cleaner. Here just like in \@ref(Add isoform counts to Seurat object) we can see two differnt isofroms of the TBR1 gene showing regulation this cell type

```{r valocano2, include=TRUE }
gene <- "TBR1"
plot_features_list <- grep(paste0("(^|-|\\b)", gene, "($|\\b)"), features, value = TRUE)

EnhancedVolcano(glut_DE_iso,
                lab=glut_DE_iso$gene,
                x='avg_log2FC', y='p_val_adj', pCutoff=0.05, FCcutoff=1,
                boxedLabels = TRUE,
                drawConnectors = TRUE,
                selectLab= plot_features_list)


```

Finding All Markers is just one type of differential expression (DE) analysis that can be performed. Seurat offers the `FindAllMarkers` function, which tests the cell type of interest against all other cell types. While this approach is often sufficient for identifying marker genes, users may also want to test differences between two specific cell types. For instance, you might want to identify DE genes when comparing glutamatergic neurons to radial glial cells. Below, we demonstrate how to perform this type of analysis.

### Gene Set enrichemt

### TBD - Manveer to complete.

From this work we can see ... \## plotting trajectories

## Finding isofrms of interest

## 

## plotting with ditoplot
